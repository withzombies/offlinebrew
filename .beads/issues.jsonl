{"id":"bd-0we","content_hash":"f11e7b6bd112ec6093f475b9cf32e4fdfbe002e5fda9eb0b2d5d9ef4e2b62e84","title":"Bug: E2E test doesn't catch Fatal errors from brew-offline-install","description":"","design":"## Bug Description\nE2E test script doesn't catch \"Fatal:\" errors from brew-offline-install,\nonly looks for \"Error:\" prefix.\n\n## Reproduction Steps\n1. Run E2E test that triggers a Fatal error\n2. Test checks: if vm_exec \"$install_cmd\" | grep -q \"Error:\"; then\n3. Fatal error is missed, test reports success\n\n## Expected Behavior\nTest should catch both \"Error:\" and \"Fatal:\" messages.\n\n## Actual Behavior\nOnly catches \"Error:\", misses \"Fatal:\" failures.\n\n## Root Cause\nFile: test/integration/phases/verify-install.sh:67\n\n```bash\nif vm_exec \"$install_cmd\" 2\u003e\u00261 | grep -q \"Error:\"; then\n  error \"  Failed to install $name\"\n```\n\nHomebrew uses different error prefixes:\n- \"Error:\" for recoverable errors\n- \"Fatal:\" for unrecoverable errors\n\n## Solution Approach\nChange grep pattern to catch both:\n```bash\nif vm_exec \"$install_cmd\" 2\u003e\u00261 | grep -qE \"(Error:|Fatal:)\"; then\n```\n\nOr use exit code instead of string matching.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-14T10:28:52.798447-05:00","updated_at":"2025-11-14T10:32:07.693309-05:00","closed_at":"2025-11-14T10:32:07.693309-05:00","source_repo":"."}
{"id":"bd-bh6","content_hash":"35b4544f275a1c7b3774ff8288ffeb42484653a0879ee2f9eb8e0a1e99d9f466","title":"Feature: Homebrew API Mirror with Bottles and Casks","description":"","design":"## Requirements (IMMUTABLE)\n\n### Core Functionality\n- Offline cask installation via local API mirror (firefox, docker-desktop, etc.)\n- Offline formula installation with bottles (90%+ formulas, \u003c10 second installs)\n- Offline formula installation from source when no bottles available (graceful fallback)\n- Single HTTP server architecture (all users point to one mirror)\n- Unified API approach for both formulas and casks (no HOMEBREW_NO_INSTALL_FROM_API)\n\n### Technical Requirements\n- Generate Homebrew-compatible API JSON endpoints (/api/formula.json, /api/cask.json, etc.)\n- Download and mirror bottles for current architecture (arm64_sonoma by default)\n- Support --include-intel flag for Intel architecture bottles\n- SHA256 verification for all downloads (bottles, sources, casks)\n- Enhanced cache pre-population (bottles + sources + casks)\n- Backward compatible with existing manifest.json and urlmap.json\n\n### User Experience\n- Single environment variable: HOMEBREW_API_DOMAIN=http://mirror:8000/api\n- Clear error messages for missing bottles, architecture mismatches, corrupt files\n- Performance: bottles install in \u003c10 seconds (vs hours for source builds)\n- Multi-user support: central mirror server for team/organization\n\n## Success Criteria (MUST ALL BE TRUE)\n\n### Functional\n- [ ] Firefox cask installs offline from mirror (DMG cached and used)\n- [ ] jq formula installs from bottle in \u003c10 seconds (no compilation)\n- [ ] oniguruma dependency bottle installed automatically for jq\n- [ ] Formula without bottles falls back to source build successfully\n- [ ] API JSON validates against Homebrew's expected schema\n- [ ] SHA256 verification passes for bottles, sources, and casks\n- [ ] brew-mirror generates all required API endpoints\n- [ ] brew-offline-install uses HOMEBREW_API_DOMAIN (not NO_INSTALL_FROM_API)\n\n### Performance\n- [ ] Bottle installation completes in \u003c10 seconds\n- [ ] Cask installation completes in \u003c30 seconds\n- [ ] Mirror creation for 10 packages completes in \u003c5 minutes\n- [ ] API JSON generation completes in \u003c10 seconds\n\n### Quality\n- [ ] All existing tests pass\n- [ ] Integration test: full mirror → install workflow for jq + firefox\n- [ ] Unit tests for API generation, bottle download, cache pre-population\n- [ ] Pre-commit hooks pass\n- [ ] No Homebrew warnings during installation\n\n### Integration\n- [ ] Works with existing CLI flags (--with-deps, --casks, -f)\n- [ ] Backward compatible with current manifest.json format\n- [ ] All tests passing\n\n## Anti-Patterns (FORBIDDEN)\n\n❌ NO mocking Homebrew API responses in tests (defeats schema validation)\n❌ NO hardcoded ARM64-only assumptions (must support --include-intel)\n❌ NO skipping SHA256 verification (security requirement)\n❌ NO incomplete API JSON (must match HOMEBREW_API_SCHEMA.md)\n❌ NO using HOMEBREW_NO_INSTALL_FROM_API=1 (defeats bottle support)\n❌ NO bottle-only without source fallback (some formulas lack bottles)\n❌ NO mixing bottles and sources in same directory (keep bottles/ separate)\n❌ NO TODO stubs for core API generation or bottle download\n\n## Approach\n\n### Architecture Overview\nLocal API mirror approach that unifies formula and cask installation:\n\n1. **Mirror Creation (brew-mirror):**\n   - Download source tarballs (existing)\n   - Download cask installers (existing)\n   - NEW: Download bottles for formulas\n   - NEW: Generate API JSON endpoints\n   - Update manifest.json and urlmap.json\n\n2. **Mirror Structure:**\n   ```\n   /mirror-directory/\n   ├── api/\n   │   ├── formula.json, formula/\u003cname\u003e.json\n   │   └── cask.json, cask/\u003cname\u003e.json\n   ├── bottles/\n   │   └── formula--version.platform.bottle.tar.gz\n   ├── casks/\n   │   └── app--version.dmg\n   ├── sources/\n   │   └── formula-version.tar.gz\n   └── manifest.json, urlmap.json\n   ```\n\n3. **Installation (brew-offline-install):**\n   - Set HOMEBREW_API_DOMAIN=http://mirror:8000/api\n   - Pre-populate cache with bottles, sources, casks\n   - Homebrew fetches definitions from mirror API\n   - Homebrew finds files in cache\n   - Fast bottle installs (no compilation!)\n\n### Components\n\n**Component 1: API Generator (mirror/lib/api_generator.rb)**\n- Generates /api/formula.json (array of formula names)\n- Generates /api/formula/\u003cname\u003e.json (full definition with bottle metadata)\n- Generates /api/cask.json (array of cask tokens)\n- Generates /api/cask/\u003cname\u003e.json (full cask definition)\n- Schema validation against Homebrew's API structure\n\n**Component 2: Bottle Downloader (mirror/lib/bottle_downloader.rb)**\n- Extracts bottle URLs from Formula objects\n- Downloads bottles for current platform (arm64_sonoma)\n- Optional: --include-intel for Intel bottles\n- Verifies SHA256 checksums\n- Updates urlmap.json with bottle URLs\n\n**Component 3: Enhanced Cache Pre-population (mirror/bin/brew-offline-install)**\n- Prioritizes bottles over source tarballs\n- Falls back to source if no bottle available\n- Handles cask installers (DMG/PKG)\n- Reports: \"Pre-populated X files (Y bottles, Z casks)\"\n\n## Context\n\n### Research Documents\n- HOMEBREW_API_SCHEMA.md - API JSON structure reference\n- BOTTLES_IMPLEMENTATION_GUIDE.md - Detailed implementation guide\n- BOTTLES_AND_GIT_QUICK_REFERENCE.md - Quick reference during development\n- RESEARCH_SUMMARY.md - Executive summary of bottles research\n\n### Existing Code Patterns\n- mirror/bin/brew-mirror:400-600 - Formula resource collection\n- mirror/bin/brew-mirror:700-900 - Cask resource collection\n- mirror/bin/brew-offline-install:160-197 - Cache pre-population\n- mirror/lib/dependency_resolver.rb - Dependency resolution pattern\n\n### API Documentation\n- https://formulae.brew.sh/docs/api/ - Official API documentation\n- https://formulae.brew.sh/api/formula/jq.json - Example formula JSON\n- https://formulae.brew.sh/api/cask/firefox.json - Example cask JSON\n\n### Key Environment Variables\n- HOMEBREW_API_DOMAIN - Points to mirror API (our solution)\n- HOMEBREW_CACHE - Cache directory for bottles/sources\n- HOMEBREW_NO_INSTALL_FROM_API - Do NOT use (defeats bottles)\n\n### Performance Data\n- Bottle install: ~5 seconds (research verified)\n- Source build: 3+ hours for complex formulas (research verified)\n- 90%+ formulas have bottles available (research verified)\n","status":"open","priority":0,"issue_type":"epic","created_at":"2025-11-14T15:07:54.807192-05:00","updated_at":"2025-11-14T15:07:54.807192-05:00","source_repo":"."}
{"id":"bd-ejw","content_hash":"11f56af0da3315951c8b5c768470a36384ca1246ceb65a64e25b37c39eee022f","title":"Implement bottle downloader for formulas","description":"","design":"Download and mirror Homebrew bottles (precompiled binaries) for formulas. Enables \u003c10 second formula installations versus hours for source builds.\n\nSee .beads/task-bottle-downloader.md for detailed implementation plan.\n\nKey deliverables:\n- mirror/lib/bottle_downloader.rb with BottleDownloader class\n- mirror/test/lib/test_bottle_downloader.rb with TDD tests\n- Integration into brew-mirror for bottle downloads\n- SHA256 verification and urlmap updates\n- Platform detection (ARM64/Intel support)","status":"closed","priority":0,"issue_type":"feature","created_at":"2025-11-14T15:35:59.425229-05:00","updated_at":"2025-11-14T15:46:05.905649-05:00","closed_at":"2025-11-14T15:46:05.905649-05:00","source_repo":".","dependencies":[{"issue_id":"bd-ejw","depends_on_id":"bd-bh6","type":"parent-child","created_at":"2025-11-14T15:36:07.43643-05:00","created_by":"ryan"},{"issue_id":"bd-ejw","depends_on_id":"bd-vam","type":"blocks","created_at":"2025-11-14T15:36:07.950242-05:00","created_by":"ryan"}]}
{"id":"bd-pgr","content_hash":"7676e8fe5d9d27c5075f8952b330c383e49d09bf8da399963f52662541fbf9e2","title":"Bug: Confusing tap warnings for bundled default taps","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-14T10:37:17.445365-05:00","updated_at":"2025-11-14T10:41:08.249091-05:00","closed_at":"2025-11-14T10:41:08.249091-05:00","source_repo":"."}
{"id":"bd-snn","content_hash":"c80fcfd579698505d850d7a7f814ace2391d531c50eae99fff18171d248cdc28","title":"Bug: brew-offline-install fails on Homebrew 5.0+ bundled taps","description":"","design":"## Bug Description\nbrew-offline-install fails immediately on Homebrew 5.0+ with:\n\"Fatal: homebrew-core tap not found at /opt/homebrew/Library/Taps/homebrew/homebrew-core\"\n\nThis prevents ANY package installation from offline mirrors.\n\n## Reproduction Steps\n1. Create mirror: brew offline mirror -d ~/mirror -f jq\n2. Try to install: brew offline install jq\n3. See: \"Fatal: homebrew-core tap not found at /opt/homebrew/Library/Taps/homebrew/homebrew-core\"\n\n## Expected Behavior\nShould install jq from the mirror without errors.\n\n## Actual Behavior\nFails before even attempting installation.\n\n## Root Cause\nFile: mirror/bin/brew-offline-install:87-90\n\nCode checks for tap directory:\n```ruby\nunless Dir.exist?(CORE_TAP_DIR)\n  abort \"Fatal: homebrew-core tap not found at #{CORE_TAP_DIR}\"\nend\n```\n\nIn Homebrew 5.0+:\n- Core and cask taps are BUNDLED (no separate directory)\n- They exist at /opt/homebrew/Library/Taps/homebrew/homebrew-{core,cask}\n- But these are just symlinks/references, not full git repos\n- The actual tap data is bundled in Homebrew itself\n\nThis check was valid for Homebrew 4.x where taps were separate git clones.\n\n## Solution Approach\nRemove the tap directory check for bundled taps. Instead:\n1. Check if Homebrew is installed (already done on line 83)\n2. Trust that bundled taps are available\n3. Only check third-party tap directories\n\nOr use TapManager.tap_installed? which handles bundled taps correctly.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-14T10:28:45.208024-05:00","updated_at":"2025-11-14T10:32:07.164131-05:00","closed_at":"2025-11-14T10:32:07.164131-05:00","source_repo":"."}
{"id":"bd-vam","content_hash":"d0a8be4842f7b8cda1223e79d98af2a1244080e1c5127238ded879a5fe6ac0d1","title":"Implement API JSON generator for formulas","description":"","design":"## Goal\n\nCreate the API JSON generator that produces Homebrew-compatible formula definitions with bottle metadata. This is the foundation for the entire API mirror approach.\n\n**Deliverable:** Working api_generator.rb that generates /api/formula.json and /api/formula/\u003cname\u003e.json files matching Homebrew's schema.\n\n## Implementation\n\n### 1. Study existing code patterns\n\n**Similar implementations to review:**\n- mirror/bin/brew-mirror:400-500 - Formula resource collection (how we iterate formulas)\n- mirror/bin/brew-mirror:950-1000 - Manifest generation (how we extract metadata)\n- Formula object methods: formula.name, formula.version, formula.desc, formula.bottle\n\n**Research documents:**\n- HOMEBREW_API_SCHEMA.md - Required fields for formula JSON\n- Live API example: curl https://formulae.brew.sh/api/formula/jq.json\n\n### 2. Write tests first (TDD)\n\n**Create: mirror/test/lib/test_api_generator.rb**\n\nTest cases:\n- `test_generates_formula_list_json` - /api/formula.json is array of strings\n- `test_generates_single_formula_json` - /api/formula/jq.json has required fields\n- `test_includes_bottle_metadata` - Bottle URLs, SHA256s, platforms present\n- `test_handles_formula_without_bottles` - No bottle section when unavailable\n- `test_validates_against_schema` - All required fields present, correct types\n\n**Test data:** Use jq and oniguruma as test formulas (we know they have bottles)\n\n### 3. Implementation checklist\n\n**Create: mirror/lib/api_generator.rb**\n\n- [ ] ApiGenerator class with generate_all(formulas, output_dir) method\n- [ ] generate_formula_list(formulas) → /api/formula.json\n  - Returns: [\"jq\", \"oniguruma\", ...]\n  \n- [ ] generate_formula_json(formula) → /api/formula/\u003cname\u003e.json\n  - Extract: name, full_name, tap, desc, license, homepage\n  - Extract: versions (stable, head, bottle)\n  - Extract: urls.stable (url, checksum)\n  - Extract: bottle data (stable, files with platform-specific URLs/SHA256s)\n  - Extract: dependencies, build_dependencies\n  - Extract: revision, version_scheme\n  \n- [ ] extract_bottle_metadata(formula) - Helper for bottle data\n  - Parse formula.bottle.checksums hash\n  - Map to Homebrew API format: {files: {arm64_sonoma: {url, sha256}, ...}}\n  \n- [ ] validate_formula_json(json_hash) - Schema validator\n  - Check all required fields present\n  - Check data types match schema\n  - Warn on missing optional fields\n\n**File locations:**\n- mirror/lib/api_generator.rb - Main implementation\n- mirror/test/lib/test_api_generator.rb - Test suite\n\n### 4. Integration point\n\n**Modify: mirror/bin/brew-mirror (around line 950)**\n\nAfter manifest generation, add:\n```ruby\n# Generate API JSON files\nrequire_relative '../lib/api_generator'\napi_dir = File.join(options[:directory], 'api')\nApiGenerator.generate_all(formulas, api_dir)\nohai \"Generated API JSON for #{formulas.count} formulas\"\n```\n\n## Success Criteria\n\n- [ ] Tests pass: ruby mirror/test/lib/test_api_generator.rb\n- [ ] Generated /api/formula.json is valid JSON array\n- [ ] Generated /api/formula/jq.json matches schema in HOMEBREW_API_SCHEMA.md\n- [ ] Bottle metadata included when formula has bottles\n- [ ] No bottles section when formula lacks bottles\n- [ ] brew-mirror successfully generates API files for jq\n- [ ] Pre-commit hooks pass\n\n## Verification Commands\n\n```bash\n# Run tests\nruby mirror/test/lib/test_api_generator.rb\n\n# Test integration with brew-mirror\nbrew-mirror -d /tmp/test-api -f jq\n\n# Verify output\ncat /tmp/test-api/api/formula.json\ncat /tmp/test-api/api/formula/jq.json | jq .\n\n# Compare with real API (should have same structure)\ndiff \u003c(curl -s https://formulae.brew.sh/api/formula/jq.json | jq 'keys | sort')      \u003c(cat /tmp/test-api/api/formula/jq.json | jq 'keys | sort')\n```\n\n## Notes\n\n- Reference HOMEBREW_API_SCHEMA.md for complete field list\n- Start with minimal required fields, add optional fields iteratively\n- Use Formula object methods (formula.bottle, formula.deps, etc.)\n- Don't hardcode - extract everything from Formula objects\n","status":"closed","priority":0,"issue_type":"feature","created_at":"2025-11-14T15:08:31.58578-05:00","updated_at":"2025-11-14T15:18:37.087873-05:00","closed_at":"2025-11-14T15:18:37.087873-05:00","source_repo":".","dependencies":[{"issue_id":"bd-vam","depends_on_id":"bd-bh6","type":"parent-child","created_at":"2025-11-14T15:08:39.568958-05:00","created_by":"ryan"}]}
{"id":"bd-w2x","content_hash":"1887e7660da4ccfb89ae7d352b070eb5fd0d04fc2e51621c4b4b19ac808d4bb8","title":"Enhance cache pre-population for bottles in brew-offline-install","description":"","design":"Enable offline bottle installations by pre-populating Homebrew cache with bottles from mirror.\n\n## Goal\nPre-populate HOMEBREW_CACHE with bottles, sources, and casks from mirror directory before running brew install, enabling fast (\u003c10 second) offline installations.\n\n## Context\n- bd-vam completed: API JSON generation for formulas\n- bd-ejw completed: Bottle downloading in brew-mirror\n- Gap: brew-offline-install doesn't pre-populate bottles in cache\n\nCurrent: Only sources pre-populated, bottles ignored → slow source builds\nNeeded: Bottles pre-populated → fast bottle installs\n\n## Implementation\n\n### 1. Extend cache pre-population\n**File:** mirror/bin/brew-offline-install (around lines 160-197)\n\nAdd bottle cache population:\n- Scan bottles/ directory in mirror\n- Copy bottles to HOMEBREW_CACHE/downloads/\n- Maintain existing source/cask pre-population\n- Report: 'Pre-populated X files (Y bottles, Z sources, W casks)'\n\n### 2. Set HOMEBREW_API_DOMAIN\n**File:** mirror/bin/brew-offline-install\n\nBefore running brew install:\n- Set HOMEBREW_API_DOMAIN=file:///path/to/mirror/api\n- Verify api/ directory exists in mirror\n- Document why this enables bottle usage\n\n## Success Criteria\n- [ ] Bottles copied from mirror/bottles/ to HOMEBREW_CACHE\n- [ ] brew install jq uses bottle (not source build)\n- [ ] Installation completes in \u003c10 seconds\n- [ ] Works with dependencies (jq + oniguruma)\n- [ ] Pre-commit hooks pass","status":"in_progress","priority":0,"issue_type":"feature","created_at":"2025-11-14T15:46:38.571822-05:00","updated_at":"2025-11-14T15:51:18.402591-05:00","source_repo":".","dependencies":[{"issue_id":"bd-w2x","depends_on_id":"bd-bh6","type":"parent-child","created_at":"2025-11-14T15:46:45.867953-05:00","created_by":"ryan"},{"issue_id":"bd-w2x","depends_on_id":"bd-ejw","type":"blocks","created_at":"2025-11-14T15:46:46.40114-05:00","created_by":"ryan"}]}

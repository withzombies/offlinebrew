{"id":"bd-1ml","content_hash":"1aec2bfa1be13958dc1bd8cd9e7d07b291a0de8ca3e1d3db5ee1226959c5ea85","title":"Phase 2: Remove legacy config support and simplify mirror scripts","description":"","design":"## Goal\nRemove all backward compatibility for old config formats. Require new multi-tap format only.\n\n## Effort Estimate\n3-4 hours\n\n## Success Criteria\n- [ ] Legacy config auto-conversion removed\n- [ ] Clear error message for old format configs\n- [ ] New format properly validated\n- [ ] Test with old format shows helpful error\n- [ ] Test with new format works correctly\n- [ ] Integration tests pass\n\n## Implementation Steps\n\n### Step Group 1: Remove Legacy Support from brew-offline-install\n\n**Files:**\n- Modify: `mirror/bin/brew-offline-install:195-209`\n\n**Step 1: Open the file**\n```bash\ncd /Users/ryan/src/offlinebrew\nopen mirror/bin/brew-offline-install\n```\n\n**Step 2: Find the legacy conversion code at line 195**\n```bash\ngrep -n \"Handle new tap-based config format\" mirror/bin/brew-offline-install\n# Should show line 195\n```\n\n**Step 3: Replace the entire conversion block (lines 195-209)**\nDelete this:\n```ruby\n# Handle new tap-based config format with backward compatibility\ntaps = if config[:taps]\n         # New format\n         config[:taps]\n       elsif config[:commit]\n         # Old format - convert to new format\n         {\n           \"homebrew/homebrew-core\" =\u003e {\n             \"commit\" =\u003e config[:commit],\n             \"type\" =\u003e \"formula\",\n           },\n         }\n       else\n         abort \"Invalid config format: no taps or commit found\"\n       end\n```\n\nReplace with:\n```ruby\n# Require new tap-based config format (Homebrew 5.0+ only)\nif config[:commit]\n  abort \u003c\u003c~ERROR\n    ❌ Legacy config format detected!\n\n    Your config uses the old single-tap format:\n    {\n      \"commit\": \"#{config[:commit][0..10]}...\",\n      \"formulae\": [...]\n    }\n\n    This format is no longer supported. Please use the new multi-tap format:\n    {\n      \"taps\": {\n        \"homebrew/homebrew-core\": {\n          \"commit\": \"bundled-5.0\",\n          \"type\": \"formula\"\n        }\n      },\n      \"formulae\": [...],\n      \"casks\": [...]\n    }\n\n    For bundled taps in Homebrew 5.0+, use \"bundled-5.0\" as the commit.\n  ERROR\nend\n\nunless config[:taps]\n  abort \u003c\u003c~ERROR\n    ❌ Invalid config format: 'taps' section is required\n\n    Config must include a 'taps' section:\n    {\n      \"taps\": {\n        \"homebrew/homebrew-core\": {\n          \"commit\": \"bundled-5.0\",\n          \"type\": \"formula\"\n        }\n      },\n      \"formulae\": [\"wget\", \"curl\"]\n    }\n  ERROR\nend\n\ntaps = config[:taps]\n```\n\n**Step 4: Add validation for tap entries**\nAfter the taps assignment, add:\n```ruby\n# Validate each tap configuration\ntaps.each do |tap_name, tap_config|\n  unless tap_config.is_a?(Hash)\n    abort \"❌ Invalid tap config for #{tap_name}: must be a hash with 'commit' and 'type'\"\n  end\n\n  unless tap_config[\"commit\"] || tap_config[:commit]\n    abort \"❌ Invalid tap config for #{tap_name}: missing 'commit' field\"\n  end\n\n  unless tap_config[\"type\"] || tap_config[:type]\n    abort \"❌ Invalid tap config for #{tap_name}: missing 'type' field (formula/cask/mixed)\"\n  end\nend\n```\n\n**Step 5: Verify the changes**\n```bash\nruby -c mirror/bin/brew-offline-install\n# Expected: Syntax OK\n```\n\n### Step Group 2: Remove Legacy Generation from brew-mirror\n\n**Files:**\n- Modify: `mirror/bin/brew-mirror:276-282`\n\n**Step 1: Open the file**\n```bash\nopen mirror/bin/brew-mirror\n```\n\n**Step 2: Find the legacy field generation at line 276**\n```bash\ngrep -n \"Legacy fields for backward compatibility\" mirror/bin/brew-mirror\n# Should show line 276\n```\n\n**Step 3: Delete the legacy field generation (lines 276-282)**\nDelete these lines entirely:\n```ruby\n# Legacy fields for backward compatibility\n# Use first tap's commit (usually homebrew-core) for old format\nfirst_tap = config[:taps].values.first\nconfig[:commit] = first_tap[\"commit\"] if first_tap\nconfig[:stamp] = Time.now.to_i.to_s\nconfig[:cache] = options[:directory]\nconfig[:baseurl] = options[:baseurl]\n```\n\n**Step 4: Clean up the config to only include necessary fields**\nThe config should now only have:\n```ruby\nconfig = {\n  taps: tap_configs,\n  formulae: formulae,\n  casks: casks,\n  timestamp: Time.now.utc.iso8601\n}\n```\n\n**Step 5: Verify no other legacy references**\n```bash\ngrep -n \"config\\[:commit\\]\" mirror/bin/brew-mirror\n# Expected: No output (all removed)\n```\n\n### Step Group 3: Update brew-mirror-verify Warning\n\n**Files:**\n- Modify: `mirror/bin/brew-mirror-verify:88-110`\n\n**Step 1: Open the file**\n```bash\nopen mirror/bin/brew-mirror-verify\n```\n\n**Step 2: Find the format detection at line 88**\n```bash\ngrep -n \"Detect format\" mirror/bin/brew-mirror-verify\n# Should show around line 88\n```\n\n**Step 3: Replace the warning with an error**\nFind this code around lines 88-110:\n```ruby\n# Detect format\nif config[\"taps\"]\n  # New format\n  puts \"Config format: Multi-tap (new)\"\nelsif config[\"commit\"]\n  # Old format\n  puts \"Config format: Single-tap (legacy)\"\n  puts \"WARNING: Legacy format is deprecated\"\nelse\n  abort \"Invalid config format\"\nend\n```\n\nReplace with:\n```ruby\n# Require new format only\nif config[\"commit\"]\n  abort \u003c\u003c~ERROR\n    ❌ Legacy config format no longer supported!\n\n    This mirror uses the old single-tap format.\n    Please recreate the mirror using:\n\n    brew offline mirror --directory /new/path \\\\\n      --formulae wget,curl \\\\\n      --casks firefox\n  ERROR\nend\n\nunless config[\"taps\"]\n  abort \"❌ Invalid config format: 'taps' section is required\"\nend\n\nputs \"✓ Config format: Multi-tap (Homebrew 5.0+)\"\n```\n\n**Step 4: Verify syntax**\n```bash\nruby -c mirror/bin/brew-mirror-verify\n# Expected: Syntax OK\n```\n\n### Step Group 4: Create Test Configs\n\n**Files:**\n- Create: `/tmp/test_old_format.json`\n- Create: `/tmp/test_new_format.json`\n- Create: `/tmp/test_mixed_format.json`\n\n**Step 1: Create old format test config**\n```bash\ncat \u003e /tmp/test_old_format.json \u003c\u003c 'EOF'\n{\n  \"commit\": \"abc123def456789\",\n  \"formulae\": [\"wget\", \"curl\"],\n  \"stamp\": \"1699999999\"\n}\nEOF\n```\n\n**Step 2: Create new format test config**\n```bash\ncat \u003e /tmp/test_new_format.json \u003c\u003c 'EOF'\n{\n  \"taps\": {\n    \"homebrew/homebrew-core\": {\n      \"commit\": \"bundled-5.0\",\n      \"type\": \"formula\"\n    }\n  },\n  \"formulae\": [\"wget\", \"curl\"]\n}\nEOF\n```\n\n**Step 3: Create mixed format test config (should be rejected)**\n```bash\ncat \u003e /tmp/test_mixed_format.json \u003c\u003c 'EOF'\n{\n  \"commit\": \"old_commit\",\n  \"taps\": {\n    \"homebrew/homebrew-core\": {\n      \"commit\": \"new_commit\",\n      \"type\": \"formula\"\n    }\n  },\n  \"formulae\": [\"wget\"]\n}\nEOF\n```\n\n### Step Group 5: Test Legacy Format Rejection\n\n**Step 1: Test brew-offline-install with old format**\n```bash\ncd /Users/ryan/src/offlinebrew\n./mirror/bin/brew-offline-install /tmp/test_old_format.json /tmp/test_mirror 2\u003e\u00261\n```\nExpected output:\n```\n❌ Legacy config format detected!\n\nYour config uses the old single-tap format...\n```\n\n**Step 2: Test brew-offline-install with new format**\n```bash\n./mirror/bin/brew-offline-install /tmp/test_new_format.json /tmp/test_mirror 2\u003e\u00261 | head -5\n```\nExpected: Should start installation without errors\n\n**Step 3: Test brew-offline-install with mixed format**\n```bash\n./mirror/bin/brew-offline-install /tmp/test_mixed_format.json /tmp/test_mirror 2\u003e\u00261\n```\nExpected: Should detect and reject the legacy \"commit\" field\n\n**Step 4: Test brew-mirror-verify with old config**\n```bash\n./mirror/bin/brew-mirror-verify /tmp/test_old_format.json 2\u003e\u00261\n```\nExpected:\n```\n❌ Legacy config format no longer supported!\n```\n\n### Step Group 6: Update Integration Tests\n\n**Files:**\n- Modify: `mirror/test/integration/test_error_handling.rb`\n\n**Step 1: Find tests that expect legacy format to work**\n```bash\ngrep -n \"legacy\\|old format\\|commit.*:\" mirror/test/integration/test_error_handling.rb\n```\n\n**Step 2: Update test to expect failure for legacy format**\nFind any test that creates a legacy config and expects it to work.\nChange it to expect an error instead:\n```ruby\ndef test_legacy_format_rejection\n  config = {\n    commit: \"abc123\",\n    formulae: [\"wget\"]\n  }\n\n  # Should now fail with clear error\n  assert_raises(SystemExit) do\n    # ... code that processes config\n  end\nend\n```\n\n**Step 3: Run the integration tests**\n```bash\ncd mirror\nruby test/integration/test_error_handling.rb\n```\nExpected: Tests should pass with updated expectations\n\n### Step Group 7: Final Verification and Commit\n\n**Step 1: Verify no legacy support remains**\n```bash\ngrep -r \"Old format.*convert\\|backward compatibility\" mirror/bin/\n```\nExpected: No output (all legacy support removed)\n\n**Step 2: Check for any remaining commit field handling**\n```bash\ngrep -r \"config\\[:commit\\]\\|config\\[\\\"commit\\\"\\]\" mirror/bin/ | grep -v ERROR\n```\nExpected: Only error message references should remain\n\n**Step 3: Test the full workflow**\n```bash\n# Create a test mirror with new format\necho '{\"taps\":{\"homebrew/homebrew-core\":{\"commit\":\"bundled-5.0\",\"type\":\"formula\"}},\"formulae\":[\"jq\"]}' \u003e /tmp/new.json\n\n# This should work\n./mirror/bin/brew-offline-install /tmp/new.json /tmp/test_install\n```\n\n**Step 4: Commit the changes**\n```bash\ngit add mirror/bin/brew-offline-install mirror/bin/brew-mirror mirror/bin/brew-mirror-verify\ngit add mirror/test/integration/test_error_handling.rb  # if modified\ngit commit -m \"refactor(bd-1ml): remove legacy config format support\n\n- Remove auto-conversion from old single-tap to new multi-tap format\n- Add clear error messages when legacy format is detected\n- Remove legacy field generation from brew-mirror\n- Update brew-mirror-verify to reject legacy configs\n- Require Homebrew 5.0+ multi-tap format only\n- Update tests to expect legacy format rejection\n\nBreaking change: Configs with 'commit' field at root level are no longer supported.\nUsers must migrate to the new 'taps' format.\n\nPart of bd-8mg: Simplify offlinebrew to require Homebrew 5.0+ only\"\n```\n\n## Key Considerations\n\n### Edge Case: Empty Config\nWhat if config.json is empty or just `{}`?\n- Should show clear error about required 'taps' section\n- Don't crash with undefined method errors\n\n### Edge Case: Mixed Format\nWhat if config has both old and new fields?\n```json\n{\n  \"commit\": \"old\",\n  \"taps\": { ... }\n}\n```\n- Detect and reject - no ambiguity allowed\n- Clear error message about format conflict\n\n### Edge Case: Malformed JSON\n- Use proper error handling for JSON.parse\n- Show file path in error message\n- Suggest using JSON validator\n\n### Migration Path\nSince we're not providing auto-migration:\n- Error message must be crystal clear\n- Show example of correct format\n- Consider logging old format for debugging\n\n## Anti-patterns\n- ❌ Don't silently ignore old format fields\n- ❌ Don't attempt partial conversion\n- ❌ Don't assume default tap if not specified\n- ❌ Don't crash with Ruby errors - use abort with message\n- ❌ Don't accept ambiguous configs","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-13T19:07:36.1521-05:00","updated_at":"2025-11-14T08:19:02.45686-05:00","source_repo":".","labels":["parent:bd-8mg"],"dependencies":[{"issue_id":"bd-1ml","depends_on_id":"bd-8mg","type":"parent-child","created_at":"2025-11-13T19:08:20.357043-05:00","created_by":"ryan"},{"issue_id":"bd-1ml","depends_on_id":"bd-clw","type":"blocks","created_at":"2025-11-13T19:08:22.01447-05:00","created_by":"ryan"}],"comments":[{"id":2,"issue_id":"bd-1ml","author":"ryan","text":"## Design\n\n### Goal\nRemove all backward compatibility for old config formats\n\n### Files to modify\n- `mirror/bin/brew-offline-install`\n- `mirror/bin/brew-offline-mirror`\n\n### Changes for brew-offline-install\n\n1. **Remove legacy config conversion** (lines 195-209):\n   - Delete the auto-conversion logic\n   - Require new format only\n   - Abort with clear error if old format detected\n\n2. **Simplify config validation**:\n   - Add clear error message for old format:\n   ```\n   if config[:commit]\n     abort 'Legacy config format detected. Please use new format: {\"taps\": {\"tap-name\": {...}}}'\n   end\n   ```\n   - Document required format in error message\n\n### Changes for brew-offline-mirror\n\n1. **Check if legacy support exists**:\n   - Search for any old format handling\n   - Remove if present\n   - Ensure only new format accepted\n\n### Verification\n- Test with old format config - should error clearly\n- Test with new format config - should work\n- Run integration tests","created_at":"2025-11-14T00:20:56Z"},{"id":5,"issue_id":"bd-1ml","author":"ryan","text":"## Reopened - Implementation Not Completed\n\n**Review Date:** 2025-11-14\n\n**Finding:** Epic was closed but none of the required changes were implemented.\n\n**Evidence:**\n- Legacy auto-conversion still exists in brew-offline-install:195-209\n- Legacy field generation still exists in brew-mirror:276-282\n- brew-mirror-verify still accepts legacy format (warning, not error)\n- Integration tests still expect backward compatibility\n- No commits were made for this epic\n\n**Required Work:**\nAll 7 Step Groups from the original design need to be executed:\n1. Remove legacy conversion from brew-offline-install\n2. Remove legacy field generation from brew-mirror\n3. Update brew-mirror-verify to reject legacy configs\n4. Create test configs\n5. Test legacy format rejection\n6. Update integration tests\n7. Commit changes\n\n**Current Status:** 0% complete - no code changes made","created_at":"2025-11-14T13:19:11Z"}]}
{"id":"bd-2oh","content_hash":"1755a65a3e6619f72579f6e2e17e7adc9cd2d36c8b4a1e617f06a739afa2cff1","title":"Remove legacy field generation from brew-mirror","description":"","design":"## Goal\nRemove the legacy field generation code from brew-mirror that adds backward compatibility fields to config.json.\n\n## Context\nThis is Step Group 2 of bd-1ml. Currently brew-mirror:276-282 generates legacy fields (commit, stamp, cache, baseurl) for backward compatibility. These must be removed.\n\nCompleted bd-rv9: Removed legacy conversion from brew-offline-install.\n\n## Implementation Steps\n\n1. Read brew-mirror lines 276-282 to confirm current state\n2. Delete lines 276-282 (legacy field generation)\n3. Verify config structure only includes new format fields\n4. Run ruby -c to verify syntax\n5. Check for any other references to config[:commit] in brew-mirror\n6. Verify no legacy fields remain\n\n## Files Modified\n- mirror/bin/brew-mirror\n\n## Success Criteria\n- [ ] Lines 276-282 deleted from brew-mirror\n- [ ] No legacy field generation (commit, stamp, cache) remains\n- [ ] Config only contains: taps, formulae, casks, timestamp\n- [ ] Syntax check passes (ruby -c)\n- [ ] No other config[:commit] references in brew-mirror (except error messages)","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-14T08:23:17.192889-05:00","updated_at":"2025-11-14T08:24:51.516911-05:00","closed_at":"2025-11-14T08:24:51.516911-05:00","source_repo":".","dependencies":[{"issue_id":"bd-2oh","depends_on_id":"bd-1ml","type":"parent-child","created_at":"2025-11-14T08:23:23.845314-05:00","created_by":"ryan"},{"issue_id":"bd-2oh","depends_on_id":"bd-rv9","type":"blocks","created_at":"2025-11-14T08:23:24.364432-05:00","created_by":"ryan"}]}
{"id":"bd-8mg","content_hash":"085bed9d5dbfad7dd35178861b0266f816d03c38400b51e06c4e6a79184aa57d","title":"Feature: Simplify offlinebrew to require Homebrew 5.0+ only","description":"","design":"## Goal\nRemove all legacy compatibility code and simplify offlinebrew to require Homebrew 5.0+ minimum, enabling cleaner and more maintainable codebase.\n\n## Effort Estimate\n20-25 hours total (4 phases, 5-6 hours each)\n\n## Chosen Approach\nAggressive simplification: Remove ALL compatibility code, legacy config support, and API fallbacks. Assume Homebrew 5.0+ APIs are stable.\n\n## Success Criteria\n- [ ] All 4 phase tasks completed successfully\n- [ ] Integration tests passing with Homebrew 5.0+\n- [ ] Documentation updated with 5.0+ requirement\n- [ ] Pre-commit hooks pass\n- [ ] No references to Homebrew \u003c5.0 remain\n- [ ] Mirror creation works with bundled taps\n\n## Background: Homebrew 5.0 Architecture\nBased on research, Homebrew 5.0 has fundamentally changed:\n- Core/Cask taps are bundled (no local git repos)\n- JSON API is default (not git clones)\n- HOMEBREW_NO_INSTALL_FROM_API=1 forces old behavior\n- Bottles stored in GitHub Container Registry\n- Concurrent downloads enabled by default\n\n## Anti-patterns\n- ❌ No assumptions about tap directory existence for bundled taps\n- ❌ No direct use of Cask::Cask.all (private API)\n- ❌ No version checks that could break with future releases\n- ❌ No hardcoded paths to tap directories","status":"open","priority":2,"issue_type":"epic","created_at":"2025-11-13T19:07:10.131881-05:00","updated_at":"2025-11-13T19:36:48.212499-05:00","source_repo":"."}
{"id":"bd-8vd","content_hash":"0b360d5bddc4ce1cd72443d449b07c192a1a26d726e95a75a10a05f2f7cae047","title":"Update brew-mirror-verify to reject legacy configs","description":"","design":"## Goal\nUpdate brew-mirror-verify to reject legacy config format with an error instead of a warning.\n\n## Context\nThis is Step Group 3 of bd-1ml. Currently brew-mirror-verify:88-110 shows a warning for legacy format but continues. This must be changed to abort with a clear error.\n\nCompleted bd-rv9 and bd-2oh.\n\n## Implementation Steps\n\n1. Read brew-mirror-verify lines 88-110 to find format detection code\n2. Replace warning logic with error logic:\n   - If config[\"commit\"] exists (old format) -\u003e abort with error\n   - If config[\"taps\"] doesn't exist -\u003e abort with error\n   - If config[\"taps\"] exists -\u003e print success message\n3. Run ruby -c to verify syntax\n4. Test with old format config (should abort)\n5. Test with new format config (should work)\n\n## Files Modified\n- mirror/bin/brew-mirror-verify\n\n## Success Criteria\n- [ ] Legacy format detection changed from warning to error\n- [ ] Clear error message for old format (mentions recreating mirror)\n- [ ] Clear error message for missing taps section\n- [ ] Success message for new format\n- [ ] Syntax check passes (ruby -c)","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-14T08:25:16.885583-05:00","updated_at":"2025-11-14T08:26:26.607694-05:00","closed_at":"2025-11-14T08:26:26.607694-05:00","source_repo":".","dependencies":[{"issue_id":"bd-8vd","depends_on_id":"bd-1ml","type":"parent-child","created_at":"2025-11-14T08:25:24.53546-05:00","created_by":"ryan"},{"issue_id":"bd-8vd","depends_on_id":"bd-2oh","type":"blocks","created_at":"2025-11-14T08:25:25.070446-05:00","created_by":"ryan"}]}
{"id":"bd-8wx","content_hash":"231c9459987790674234846da20e50ac7c8adcaee296c4a5cc4a5ea36ff2738e","title":"Phase 4: Update tests and documentation","description":"","design":"## Goal\nUpdate all tests and documentation to reflect Homebrew 5.0+ requirement and removal of legacy code.\n\n## Effort Estimate\n2-3 hours\n\n## Success Criteria\n- [ ] All tests pass without version-specific logic\n- [ ] Documentation clearly states Homebrew 5.0+ requirement\n- [ ] No references to legacy formats or compatibility\n- [ ] CHANGELOG documents breaking changes\n- [ ] Installation fails gracefully on Homebrew \u003c 5.0\n\n## Implementation Steps\n\n### Step Group 1: Update Main README.md\n\n**Files:**\n- Modify: `README.md`\n\n**Step 1: Open README.md**\n```bash\ncd /Users/ryan/src/offlinebrew\nopen README.md\n```\n\n**Step 2: Find and update Requirements section**\n```bash\ngrep -n \"Requirements\\|Homebrew\" README.md | head -10\n```\n\nFind the Requirements section and update it to:\n```markdown\n## Requirements\n\n- macOS 12.0 or later\n- Homebrew 5.0 or later (required - older versions not supported)\n- Ruby 3.0 or later (included with Homebrew)\n```\n\n**Step 3: Remove any Homebrew 4.x references**\n```bash\ngrep -n \"Homebrew 4\\|4\\.0\\|4\\.x\" README.md\n```\n\nDelete any lines mentioning Homebrew 4.x compatibility.\n\n**Step 4: Update config format examples**\nSearch for old config format examples:\n```bash\ngrep -n '\"commit\".*:' README.md\n```\n\nEnsure only new multi-tap format is shown:\n```json\n{\n  \"taps\": {\n    \"homebrew/homebrew-core\": {\n      \"commit\": \"bundled-5.0\",\n      \"type\": \"formula\"\n    }\n  },\n  \"formulae\": [\"wget\", \"curl\"]\n}\n```\n\n**Step 5: Add migration guide section**\nAdd near the end of README:\n```markdown\n## Migrating from Previous Versions\n\n### Upgrading to v2.0 (Homebrew 5.0+ required)\n\nIf you're using an older version of offlinebrew:\n\n1. **Upgrade Homebrew first:**\n   ```bash\n   brew update \u0026\u0026 brew upgrade\n   brew --version  # Should show 5.0.0 or higher\n   ```\n\n2. **Recreate your mirrors:**\n   The old single-tap config format is no longer supported.\n   You'll need to recreate mirrors with the new format:\n   ```bash\n   brew offline mirror --directory /path/to/mirror \\\\\n     --formulae wget,curl \\\\\n     --casks firefox\n   ```\n\n3. **Update any scripts:**\n   - Config files now require the 'taps' section\n   - Version detection methods have been removed\n   - API fallbacks have been removed\n```\n\n**Step 6: Verify changes**\n```bash\ngrep -i \"homebrew.*version\\|requirements\" README.md\n# Should show 5.0+ requirement clearly\n```\n\n### Step Group 2: Create CHANGELOG.md\n\n**Files:**\n- Create: `CHANGELOG.md` (if doesn't exist) or Modify existing\n\n**Step 1: Check if CHANGELOG exists**\n```bash\ntest -f CHANGELOG.md \u0026\u0026 echo \"EXISTS\" || echo \"CREATE\"\n```\n\n**Step 2: Create or update CHANGELOG.md**\n```bash\ncat \u003e CHANGELOG.md \u003c\u003c 'EOF'\n# Changelog\n\nAll notable changes to offlinebrew will be documented in this file.\n\nThe format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),\nand this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).\n\n## [2.0.0] - 2025-11-14\n\n### BREAKING CHANGES\n\n- **Minimum Homebrew version is now 5.0+**\n  - Older Homebrew versions (4.x and earlier) are no longer supported\n  - Install will fail if Homebrew \u003c 5.0 is detected\n\n- **Removed legacy config format**\n  - Old single-tap format `{\"commit\": \"...\", \"formulae\": [...]}` no longer supported\n  - Must use new multi-tap format with `\"taps\"` section\n  - No automatic migration - mirrors must be recreated\n\n- **Removed API compatibility layers**\n  - All version detection code removed\n  - No fallback APIs - direct API calls only\n  - Methods fail fast with clear errors instead of trying alternatives\n\n### Changed\n\n- Simplified TapManager module\n  - Removed `in_brew_ruby_context?`, `homebrew_version`, `homebrew_5_or_higher?`, `require_homebrew_5!` methods\n  - Assumes Homebrew 5.0+ bundled taps (core and cask)\n  - Returns synthetic \"bundled-X.X\" commits for bundled taps\n\n- Simplified API usage\n  - Removed conditional API checks (`respond_to?`, `defined?`)\n  - Removed rescue blocks with fallback attempts\n  - Direct modern API calls only\n\n- Cleaner error messages\n  - Legacy config shows clear error with migration example\n  - Missing APIs raise immediately instead of silently failing\n\n### Removed\n\n- Version detection methods\n- Legacy config auto-conversion\n- API fallback methods\n- Homebrew 4.x compatibility code\n\n### Migration Guide\n\nSee README.md \"Migrating from Previous Versions\" section.\n\n## [1.x.x] - Previous versions\n\n(Add previous changelog entries if they exist)\nEOF\n```\n\n**Step 3: Verify CHANGELOG**\n```bash\ncat CHANGELOG.md | head -30\n# Should show clear breaking changes\n```\n\n### Step Group 3: Update Integration Test Status\n\n**Files:**\n- Modify: `test/integration/.validation-status`\n\n**Step 1: Open validation status file**\n```bash\nopen test/integration/.validation-status\n```\n\n**Step 2: Update the status**\nReplace content or add at the end:\n```\nVALIDATION STATUS: offlinebrew-2.0.0\n=====================================\nDate: 2025-11-14\nStatus: VALIDATED FOR HOMEBREW 5.0+\n\nHomebrew 5.0+ Refactoring Complete:\n✓ Phase 1: TapManager simplified - version checks removed\n✓ Phase 2: Legacy config support removed\n✓ Phase 3: API fallbacks removed\n✓ Phase 4: Tests and documentation updated\n\nMinimum Requirements:\n- Homebrew 5.0.0 or later (REQUIRED)\n- macOS 12.0 or later\n- Ruby 3.0 or later\n\nBreaking Changes:\n- No support for Homebrew \u003c 5.0\n- Legacy single-tap config format rejected\n- No API compatibility layers\n\nTest Infrastructure Validated:\n- Tart VM setup ✓\n- Homebrew 5.0+ installation ✓\n- Bundled tap detection ✓\n- Mirror creation with new format ✓\n- All unit tests passing ✓\n\nCommit Hash: (to be added after final commit)\n```\n\n**Step 3: Verify the update**\n```bash\ncat test/integration/.validation-status\n```\n\n### Step Group 4: Verify Integration Tests\n\n**Files:**\n- Verify: `test/integration/phases/install-homebrew.sh`\n\n**Step 1: Check install-homebrew.sh**\n```bash\ngrep -n \"bundled\\|Skip tap installation\" test/integration/phases/install-homebrew.sh\n# Lines 64-67 should already skip tap installation for 5.0+\n```\n\n**Step 2: Verify the comment is accurate**\nAt lines 64-67, should say:\n```bash\n# Skip tap installation for modern Homebrew (5.0+)\n# homebrew/core and homebrew/cask are now bundled with Homebrew\ninfo \"Skipping tap installation (bundled in Homebrew 5.0+)...\"\nok \"Using bundled homebrew/core and homebrew/cask taps\"\n```\n\nThis is already correct from the earlier work!\n\n**Step 3: Run integration tests**\n```bash\nmake test-integration\n# Or: cd test/integration \u0026\u0026 ./tart-e2e.sh\n```\nExpected: All phases should complete successfully\n\n### Step Group 5: Search and Update Version References\n\n**Step 1: Find all Homebrew version references**\n```bash\ngrep -rn \"Homebrew.*[34]\\.\\|version.*[34]\\.\" --include=\"*.rb\" --include=\"*.sh\" --include=\"*.md\" .\n```\n\n**Step 2: Update or remove each reference**\nFor each result:\n- If it's a comment about compatibility: Update to \"Homebrew 5.0+\"\n- If it's version checking code: Should already be removed by previous phases\n- If it's documentation: Update to reflect 5.0+ requirement\n\n**Step 3: Verify no pre-5.0 references remain**\n```bash\ngrep -rn \"4\\.0\\|4\\.x\\|Homebrew 4\" --include=\"*.rb\" --include=\"*.sh\" --include=\"*.md\" . | grep -v CHANGELOG\n```\nExpected: No results (except CHANGELOG which documents the change)\n\n### Step Group 6: Final Verification and Commit\n\n**Step 1: Run all tests**\n```bash\ncd mirror\nruby test/test_tap_manager.rb\n# Should pass with version tests removed (from Phase 1)\n```\n\n**Step 2: Verify documentation**\n```bash\n# README should clearly state 5.0+ requirement\ngrep -A 3 \"Requirements\" README.md\n\n# CHANGELOG should document breaking changes\nhead -30 CHANGELOG.md\n```\n\n**Step 3: Verify no legacy references**\n```bash\ngrep -r \"homebrew.*version.*check\\|4\\.0.*compat\\|legacy.*format\" mirror/lib/\n```\nExpected: No results\n\n**Step 4: Commit all documentation changes**\n```bash\ngit add README.md CHANGELOG.md test/integration/.validation-status\ngit commit -m \"docs(bd-8wx): update for Homebrew 5.0+ requirement\n\n- Update README with 5.0+ requirement\n- Add migration guide for upgrading from older versions\n- Create CHANGELOG documenting breaking changes\n- Update validation status for offlinebrew 2.0\n- Remove all references to Homebrew 4.x\n- Document that legacy config format is no longer supported\n\nPart of bd-8mg: Simplify offlinebrew to require Homebrew 5.0+ only\"\n```\n\n## Key Considerations\n\n### Edge Case: User Has Old Mirrors\nMigration guide clearly states mirrors must be recreated\n- No automatic migration provided\n- Clear instructions on how to recreate\n- Example commands provided\n\n### Edge Case: Documentation in Multiple Files\nSearch thoroughly for all docs:\n- README.md files in subdirectories\n- Comments in code files\n- Test file comments\n- Integration test scripts\n\n### Edge Case: External Documentation\nIf docs exist elsewhere:\n- Wiki pages\n- GitHub releases\n- External websites\nUpdate those separately after commit\n\n## Anti-patterns\n- ❌ Don't keep \"deprecated but still works\" comments\n- ❌ Don't leave version checking code commented out\n- ❌ Don't document workarounds for old versions\n- ❌ Don't hedge with \"should work with 4.x but untested\"\n- ❌ Don't leave TODO comments about version compatibility","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-13T19:08:04.942627-05:00","updated_at":"2025-11-13T21:28:18.323058-05:00","source_repo":".","labels":["parent:bd-8mg"],"dependencies":[{"issue_id":"bd-8wx","depends_on_id":"bd-8mg","type":"parent-child","created_at":"2025-11-13T19:08:21.459162-05:00","created_by":"ryan"},{"issue_id":"bd-8wx","depends_on_id":"bd-pve","type":"blocks","created_at":"2025-11-13T19:08:23.113432-05:00","created_by":"ryan"}],"comments":[{"id":4,"issue_id":"bd-8wx","author":"ryan","text":"## Design\n\n### Goal\nUpdate all tests and docs to reflect Homebrew 5.0+ requirement\n\n### Files to modify\n- `README.md`\n- `test/integration/.validation-status`\n- `mirror/test/test_tap_manager.rb`\n- `test/integration/phases/install-homebrew.sh`\n- All other test files\n\n### Changes\n\n1. **Update README.md**:\n   - Change requirements section to 'Homebrew 5.0 or higher'\n   - Remove any mentions of older versions\n   - Remove legacy config format examples\n   - Update installation instructions if needed\n\n2. **Update test_tap_manager.rb**:\n   - Remove tests for version detection (lines 89-103)\n   - Update test assumptions to assume 5.0+\n   - Simplify bundled tap tests\n\n3. **Update install-homebrew.sh**:\n   - Add version check after installation\n   - Abort if version \u003c 5.0\n   - Update comments about bundled taps\n\n4. **Update .validation-status**:\n   - Document that we now require Homebrew 5.0+\n   - Update commit hash when complete\n\n5. **Search and update other files**:\n   - Find all references to Homebrew 4.x\n   - Update or remove version checks\n   - Update documentation strings\n\n### Verification\n- README should clearly state 5.0+ requirement\n- All tests should pass\n- No references to pre-5.0 versions remain","created_at":"2025-11-14T00:21:35Z"}]}
{"id":"bd-clw","content_hash":"513c7e69edd68033b5286e0a3d5492974721f9a91ceb9912a395ab1d51d2edfa","title":"Phase 1: Simplify TapManager and remove version checks","description":"","design":"## Goal\nRemove all Homebrew version checking code since we now require 5.0+ minimum. Simplify TapManager module to assume Homebrew 5.0+ environment.\n\n## Effort Estimate\n4-6 hours\n\n## Success Criteria\n- [ ] All version check methods removed from TapManager\n- [ ] Module still correctly identifies bundled vs non-bundled taps\n- [ ] Synthetic commits generated correctly for bundled taps\n- [ ] All TapManager tests pass\n- [ ] No errors when running with Homebrew 5.0+\n- [ ] Code is cleaner and more maintainable\n- [ ] Verified working in Tart VM\n\n## Implementation Steps\n\n### Step Group 1: Remove Version Detection Methods\n\n**Files:**\n- Modify: `mirror/lib/tap_manager.rb:21-52`\n\n**Step 1: Open the file in your editor**\n```bash\ncd /Users/ryan/src/offlinebrew\nopen mirror/lib/tap_manager.rb  # or use your preferred editor\n```\n\n**Step 2: Delete the in_brew_ruby_context? method (lines 21-23)**\nDelete these exact lines:\n```ruby\n  # Check if running in brew ruby context\n  def self.in_brew_ruby_context?\n    Object.const_defined?(:Homebrew) \u0026\u0026 defined?(HOMEBREW_VERSION)\n  end\n```\n\n**Step 3: Delete the homebrew_version method (lines 26-32)**\nDelete these exact lines:\n```ruby\n  # Get Homebrew version (works in brew ruby context)\n  def self.homebrew_version\n    if in_brew_ruby_context? \u0026\u0026 defined?(HOMEBREW_VERSION)\n      HOMEBREW_VERSION.to_s\n    else\n      nil\n    end\n  end\n```\n\n**Step 4: Delete the homebrew_5_or_higher? method (lines 35-40)**\nDelete these exact lines:\n```ruby\n  # Check if Homebrew version is 5.0 or higher\n  def self.homebrew_5_or_higher?\n    version = homebrew_version\n    return false unless version\n    major_version = version.split('.')[0].to_i\n    major_version \u003e= 5\n  end\n```\n\n**Step 5: Delete the require_homebrew_5! method (lines 43-52)**\nDelete these exact lines:\n```ruby\n  # Enforce Homebrew 5.0+ requirement\n  def self.require_homebrew_5!\n    unless homebrew_5_or_higher?\n      version = homebrew_version || \"unknown\"\n      abort \u003c\u003c~ERROR\n        Error: offlinebrew requires Homebrew 5.0 or higher\n        Current version: #{version}\n        Please upgrade Homebrew: brew update \u0026\u0026 brew upgrade\n      ERROR\n    end\n  end\n```\n\n**Step 6: Save the file and verify deletion**\n```bash\n# Verify the methods are gone\ngrep -n \"def self.in_brew_ruby_context?\" mirror/lib/tap_manager.rb\n# Expected: No output (method deleted)\n\ngrep -n \"def self.homebrew_version\" mirror/lib/tap_manager.rb\n# Expected: No output (method deleted)\n\ngrep -n \"def self.homebrew_5_or_higher?\" mirror/lib/tap_manager.rb\n# Expected: No output (method deleted)\n\ngrep -n \"def self.require_homebrew_5!\" mirror/lib/tap_manager.rb\n# Expected: No output (method deleted)\n```\n\n### Step Group 2: Simplify tap_installed? Method\n\n**Files:**\n- Modify: `mirror/lib/tap_manager.rb:135-146` (will shift up ~31 lines after deletions)\n\n**Step 1: Find the tap_installed? method**\n```bash\ngrep -n \"def self.tap_installed?\" mirror/lib/tap_manager.rb\n# Note the new line number after deletions\n```\n\n**Step 2: Replace the entire method**\nReplace the current tap_installed? method with:\n```ruby\n  # Check if tap is installed\n  #\n  # @param tap_name [String] Tap name in format \"user/repo\"\n  # @return [Boolean] True if tap is available\n  #\n  # @example Check tap installation\n  #   installed = TapManager.tap_installed?(\"homebrew/homebrew-core\")\n  #   # =\u003e true (bundled in Homebrew 5.0+)\n  def self.tap_installed?(tap_name)\n    # Check if tap directory exists (for non-bundled taps)\n    return true if Dir.exist?(tap_directory(tap_name))\n\n    # Core and Cask are always available (bundled in Homebrew 5.0+)\n    tap_name == \"homebrew/homebrew-core\" || tap_name == \"homebrew/homebrew-cask\"\n  end\n```\n\n**Step 3: Verify the change**\n```bash\nruby -r ./mirror/lib/tap_manager -e \"puts TapManager.tap_installed?('homebrew/homebrew-core')\"\n# Expected: true\n```\n\n### Step Group 3: Simplify tap_available_in_homebrew? Method\n\n**Files:**\n- Modify: `mirror/lib/tap_manager.rb` (find new line number)\n\n**Step 1: Find the tap_available_in_homebrew? method**\n```bash\ngrep -n \"def self.tap_available_in_homebrew?\" mirror/lib/tap_manager.rb\n# Note the line number\n```\n\n**Step 2: Replace the entire method**\nReplace with simplified version:\n```ruby\n  # Check if a tap is available in Homebrew (for bundled taps)\n  #\n  # @param tap_name [String] Tap name in format \"user/repo\"\n  # @return [Boolean] True if tap is bundled\n  #\n  # @example Check if core tap is available\n  #   available = TapManager.tap_available_in_homebrew?(\"homebrew/homebrew-core\")\n  #   # =\u003e true\n  def self.tap_available_in_homebrew?(tap_name)\n    # Core and cask are always bundled in Homebrew 5.0+\n    tap_name == \"homebrew/homebrew-core\" || tap_name == \"homebrew/homebrew-cask\"\n  end\n```\n\n**Step 3: Verify the change**\n```bash\nruby -r ./mirror/lib/tap_manager -e \"puts TapManager.tap_available_in_homebrew?('homebrew/homebrew-core')\"\n# Expected: true\n\nruby -r ./mirror/lib/tap_manager -e \"puts TapManager.tap_available_in_homebrew?('custom/tap')\"\n# Expected: false\n```\n\n### Step Group 4: Update tap_commit Method\n\n**Files:**\n- Modify: `mirror/lib/tap_manager.rb` (find new line number)\n\n**Step 1: Find the tap_commit method**\n```bash\ngrep -n \"def self.tap_commit\" mirror/lib/tap_manager.rb\n# Note the line number\n```\n\n**Step 2: Update the bundled tap handling**\nIn the tap_commit method, find this section:\n```ruby\n    # For bundled taps in Homebrew 5.0+, return synthetic commit\n    if tap_name == \"homebrew/homebrew-core\" || tap_name == \"homebrew/homebrew-cask\"\n      version = homebrew_version || \"5.0\"\n      return \"bundled-#{version}\"\n    end\n```\n\nReplace with:\n```ruby\n    # Bundled taps use synthetic commit based on Homebrew version\n    if tap_name == \"homebrew/homebrew-core\" || tap_name == \"homebrew/homebrew-cask\"\n      # Use environment variable or default version\n      version = ENV['HOMEBREW_VERSION'] || \"5.0\"\n      return \"bundled-#{version}\"\n    end\n```\n\n**Step 3: Verify the change**\n```bash\nruby -r ./mirror/lib/tap_manager -e \"puts TapManager.tap_commit('homebrew/homebrew-core')\"\n# Expected: bundled-5.0 (or current version)\n```\n\n### Step Group 5: Clean up all_installed_taps Method\n\n**Files:**\n- Modify: `mirror/lib/tap_manager.rb` (find new line number)\n\n**Step 1: Find the all_installed_taps method**\n```bash\ngrep -n \"def self.all_installed_taps\" mirror/lib/tap_manager.rb\n# Note the line number\n```\n\n**Step 2: Update the comment**\nFind this comment in the method:\n```ruby\n    # In Homebrew 5.0+, bundled taps are always available\n```\n\nReplace with:\n```ruby\n    # Bundled taps are always available\n```\n\n**Step 3: Verify the method still works**\n```bash\nruby -r ./mirror/lib/tap_manager -e \"puts TapManager.all_installed_taps.inspect\"\n# Expected: Array including \"homebrew/homebrew-core\" and \"homebrew/homebrew-cask\"\n```\n\n### Step Group 6: Update Test File\n\n**Files:**\n- Modify: `mirror/test/test_tap_manager.rb:89-103`\n\n**Step 1: Open the test file**\n```bash\nopen mirror/test/test_tap_manager.rb\n```\n\n**Step 2: Delete test_homebrew_5_or_higher (lines 89-94)**\nDelete these exact lines:\n```ruby\n  # Tests for Homebrew 5.0+ requirement\n  def test_homebrew_5_or_higher\n    skip \"Not in brew ruby context\" unless TapManager.in_brew_ruby_context?\n\n    # Since we require Homebrew 5.0+, this should always be true\n    assert TapManager.homebrew_5_or_higher?, \"Homebrew 5.0+ should be detected\"\n  end\n```\n\n**Step 3: Delete test_require_homebrew_5_with_valid_version (lines 96-103)**\nDelete these exact lines:\n```ruby\n  def test_require_homebrew_5_with_valid_version\n    skip \"Not in brew ruby context\" unless TapManager.in_brew_ruby_context?\n\n    # Should not raise an error with Homebrew 5.0+\n    assert_silent do\n      TapManager.require_homebrew_5!\n    end\n  end\n```\n\n**Step 4: Update any skipped test conditions**\nSearch for tests that skip based on version checking:\n```bash\ngrep -n \"TapManager.in_brew_ruby_context?\" mirror/test/test_tap_manager.rb\n```\n\nFor each occurrence, remove the skip line since we no longer have that method.\n\n**Step 5: Run the tests to verify they pass**\n```bash\ncd mirror\nruby test/test_tap_manager.rb -v\n```\nExpected: All tests should pass\n\n### Step Group 7: Final Verification\n\n**Step 1: Run the full test suite**\n```bash\ncd mirror\nruby test/test_tap_manager.rb\n```\nExpected: All tests pass\n\n**Step 2: Test with a real Homebrew command**\n```bash\nbrew ruby -r ./lib/tap_manager -e \"puts TapManager.all_installed_taps\"\n```\nExpected: List of taps including homebrew-core and homebrew-cask\n\n**Step 3: Verify no version references remain**\n```bash\ngrep -r \"homebrew_version\\|5_or_higher\\|require_homebrew_5\" mirror/lib/\n```\nExpected: No output (all version checks removed)\n\n### Step Group 8: Verify with Tart VM\n\n**Step 1: Check if any tart tests are running**\n```bash\n# Check for existing tart processes\nps aux | grep -E \"(tart|offlinebrew-test)\" | grep -v grep\n# If any are running, wait for them to complete or kill them\n```\n\n**Step 2: Run the integration test to verify changes work in VM**\n```bash\ncd /Users/ryan/src/offlinebrew\nmake test-integration-phase-4\n```\nExpected: Phase 4 (create-mirror) should complete successfully with bundled tap detection working\n\n**Step 3: Alternative - run just the tap detection in VM**\n```bash\n# Start a clean VM\ntart run offlinebrew-test \u0026\nsleep 10  # Wait for VM to boot\n\n# Test tap detection in VM\ntart exec offlinebrew-test bash -c \"\n  cd /tmp/offlinebrew \u0026\u0026\n  /opt/homebrew/bin/brew ruby -r ./mirror/lib/tap_manager -e '\n    puts \\\"Core installed: #{TapManager.tap_installed?(\\\"homebrew/homebrew-core\\\")}\\\"\n    puts \\\"Core commit: #{TapManager.tap_commit(\\\"homebrew/homebrew-core\\\")}\\\"\n    puts \\\"All taps: #{TapManager.all_installed_taps.inspect}\\\"\n  '\n\"\n```\nExpected:\n- Core installed: true\n- Core commit: bundled-5.0 (or current version)\n- All taps: includes homebrew-core and homebrew-cask\n\n**Step 4: Clean up VM**\n```bash\ntart stop offlinebrew-test\ntart delete offlinebrew-test 2\u003e/dev/null || true\n```\n\n**Step 5: Commit the changes**\n```bash\ngit add mirror/lib/tap_manager.rb mirror/test/test_tap_manager.rb\ngit commit -m \"refactor(bd-clw): remove Homebrew version checking code\n\n- Delete all version detection methods (in_brew_ruby_context, homebrew_version, etc.)\n- Simplify tap_installed? to assume Homebrew 5.0+\n- Simplify tap_available_in_homebrew? for bundled taps\n- Update tap_commit to use ENV variable fallback\n- Remove version-related tests\n- Clean up comments referencing version checks\n- Verified working in Tart VM environment\n\nPart of bd-8mg: Simplify offlinebrew to require Homebrew 5.0+ only\"\n```\n\n## Key Considerations\n\n### Edge Case: HOMEBREW_VERSION Not Available\nSince we're removing `homebrew_version` method that checks `HOMEBREW_VERSION` constant, we need alternative approach:\n- Use ENV variable as fallback\n- Default to \"5.0\" if not available\n- Document this behavior\n\n### Edge Case: Third-Party Taps\nNon-bundled taps still need directory checks:\n- Must handle taps that don't exist gracefully\n- Return nil/false appropriately\n- Don't assume all taps are bundled\n\n### Edge Case: Running Outside Brew Context\nWhen offlinebrew runs outside `brew` command context:\n- HOMEBREW_VERSION constant may not be defined\n- Must not crash, use sensible defaults\n- Consider using `brew --version` as fallback\n\n## Anti-patterns\n- ❌ Don't assume HOMEBREW_VERSION constant exists\n- ❌ Don't hardcode version strings beyond default fallback\n- ❌ Don't remove bundled tap special handling\n- ❌ Don't break existing tap directory checks for third-party taps\n- ❌ Don't use deprecated Homebrew APIs","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-13T19:07:23.872769-05:00","updated_at":"2025-11-13T21:36:06.846927-05:00","closed_at":"2025-11-13T21:36:06.846929-05:00","source_repo":".","labels":["parent:bd-8mg"],"dependencies":[{"issue_id":"bd-clw","depends_on_id":"bd-8mg","type":"parent-child","created_at":"2025-11-13T19:08:19.811208-05:00","created_by":"ryan"}],"comments":[{"id":1,"issue_id":"bd-clw","author":"ryan","text":"## Design\n\n### Goal\nRemove all Homebrew version checking code since we now require 5.0+ minimum\n\n### Files to modify\n- `mirror/lib/tap_manager.rb`\n\n### Changes\n\n1. **Remove version check methods** (lines 21-52):\n   - Delete `in_brew_ruby_context?`\n   - Delete `homebrew_version`\n   - Delete `homebrew_5_or_higher?`\n   - Delete `require_homebrew_5!`\n\n2. **Simplify tap_installed?** (lines 135-146):\n   - Remove comment about 'Modern Homebrew (4.0+)'\n   - Keep bundled tap logic for core/cask\n\n3. **Simplify tap_available_in_homebrew?** (lines 158-165):\n   - Remove 'In Homebrew 5.0+' comment\n   - Just return true for core/cask, false for others\n\n4. **Clean up tap_commit** (lines 178-183):\n   - Remove 'For Homebrew 5.0+' comment\n   - Keep synthetic commit generation\n\n5. **Update all_installed_taps** (lines 267-268):\n   - Remove 'In Homebrew 5.0+' comment\n\n### Verification\n- Run `mirror/test/test_tap_manager.rb` \n- Ensure all tests pass","created_at":"2025-11-14T00:20:37Z"}]}
{"id":"bd-pve","content_hash":"d3962a013ca367fbadd4ab336142657be859e45d4a018709ec5c79280c69993f","title":"Phase 3: Simplify API usage and remove fallbacks","description":"","design":"## Goal\nRemove all API fallbacks and defensive coding, use only Homebrew 5.0+ stable APIs.\n\n## Effort Estimate\n2-3 hours\n\n## Success Criteria\n- [ ] All helper methods use single, direct API calls\n- [ ] No conditional API usage based on availability\n- [ ] No rescue blocks with fallback attempts\n- [ ] Methods fail immediately with clear errors if APIs unavailable\n- [ ] Unit tests pass with simplified code\n\n## Implementation Steps\n\n### Step Group 1: Simplify all_casks Method in cask_helpers.rb\n\n**Files:**\n- Modify: `mirror/lib/cask_helpers.rb:33-61`\n\n**Step 1: Open the file**\n```bash\ncd /Users/ryan/src/offlinebrew\nopen mirror/lib/cask_helpers.rb\n```\n\n**Step 2: Find the all_casks method at line 33**\n```bash\ngrep -n \"def self.all_casks\" mirror/lib/cask_helpers.rb\n# Should show line 33\n```\n\n**Step 3: Replace the entire all_casks method (lines 33-61)**\nDelete this entire method:\n```ruby\ndef self.all_casks\n  begin\n    # Try modern API first\n    if defined?(Cask::Cask) \u0026\u0026 Cask::Cask.respond_to?(:all)\n      ENV['HOMEBREW_EVAL_ALL'] = '1'\n      return Cask::Cask.all\n    end\n\n    # Try alternative methods\n    if defined?(Cask) \u0026\u0026 Cask.respond_to?(:to_a)\n      return Cask.to_a\n    end\n\n    # Last resort: iterate tap directory\n    cask_dir = File.join(HomebrewPaths.cask_tap_path, \"Casks\")\n    return [] unless Dir.exist?(cask_dir)\n\n    warn \"Using fallback: loading casks from #{cask_dir}\"\n\n    Dir.glob(\"#{cask_dir}/*.rb\").map do |path|\n      token = File.basename(path, \".rb\")\n      Cask::CaskLoader.load(token)\n    end\n  rescue StandardError =\u003e e\n    warn \"Error loading casks: #{e.message}\"\n    []\n  end\nend\n```\n\nReplace with this simplified version:\n```ruby\ndef self.all_casks\n  # Use modern Cask API (Homebrew 5.0+)\n  ENV['HOMEBREW_EVAL_ALL'] = '1'\n  Cask::Cask.all\nend\n```\n\n**Step 4: Verify the changes**\n```bash\nruby -c mirror/lib/cask_helpers.rb\n# Expected: Syntax OK\n```\n\n### Step Group 2: Remove Conditional API Checks in dependency_resolver.rb\n\n**Files:**\n- Modify: `mirror/lib/dependency_resolver.rb:135,144,206`\n\n**Step 1: Open the file**\n```bash\nopen mirror/lib/dependency_resolver.rb\n```\n\n**Step 2: Find and simplify cask dependency extraction (line 135)**\nFind this code:\n```ruby\nif cask.depends_on.respond_to?(:formula)\n  # ... extract formula dependencies\nend\n```\n\nReplace with direct access (assume API exists):\n```ruby\n# Direct access to formula dependencies (Homebrew 5.0+)\nif cask.depends_on\u0026.formula\n  # ... extract formula dependencies\nend\n```\n\n**Step 3: Find and simplify cask dependency extraction (line 144)**\nFind this code:\n```ruby\nif cask.depends_on.respond_to?(:cask)\n  # ... extract cask dependencies\nend\n```\n\nReplace with direct access:\n```ruby\n# Direct access to cask dependencies (Homebrew 5.0+)\nif cask.depends_on\u0026.cask\n  # ... extract cask dependencies\nend\n```\n\n**Step 4: Find and simplify recommended dependencies (line 206)**\nFind this code:\n```ruby\nif formula.respond_to?(:recommended_dependencies)\n  formula.recommended_dependencies\nend\n```\n\nReplace with direct access:\n```ruby\n# Recommended dependencies (Homebrew 5.0+)\nformula.recommended_dependencies || []\n```\n\n**Step 5: Verify the changes**\n```bash\nruby -c mirror/lib/dependency_resolver.rb\n# Expected: Syntax OK\n```\n\n### Step Group 3: Remove Conditional API Checks in download_helpers.rb\n\n**Files:**\n- Modify: `mirror/lib/download_helpers.rb:116,139,152`\n\n**Step 1: Open the file**\n```bash\nopen mirror/lib/download_helpers.rb\n```\n\n**Step 2: Find cached_location check at line 116**\nFind this code:\n```ruby\nreturn nil unless downloader.respond_to?(:cached_location)\n```\n\nReplace with direct access:\n```ruby\n# Direct access to cached_location (Homebrew 5.0+)\n# Will raise if method doesn't exist\n```\n\n**Step 3: Find cached_location check at line 139**\nFind this code:\n```ruby\nreturn false unless downloader.respond_to?(:cached_location)\n```\n\nReplace with direct access (remove the guard):\n```ruby\n# Direct cached_location access (Homebrew 5.0+)\n```\n\n**Step 4: Find cached_location check at line 152**\nFind this code:\n```ruby\nreturn nil unless downloader.respond_to?(:cached_location)\n```\n\nReplace with direct access (remove the guard):\n```ruby\n# Assume cached_location exists (Homebrew 5.0+)\n```\n\n**Step 5: Verify the changes**\n```bash\nruby -c mirror/lib/download_helpers.rb\n# Expected: Syntax OK\n```\n\n### Step Group 4: Remove Additional Conditional Checks in cask_helpers.rb\n\n**Files:**\n- Modify: `mirror/lib/cask_helpers.rb:72,110,118`\n\n**Step 1: Find cask_api_available? method at line 71**\n```bash\ngrep -n \"def self.cask_api_available?\" mirror/lib/cask_helpers.rb\n```\n\n**Step 2: Simplify or remove the method**\nCurrent code (lines 71-73):\n```ruby\ndef self.cask_api_available?\n  defined?(Cask::Cask) \u0026\u0026 defined?(Cask::CaskLoader)\nend\n```\n\nReplace with:\n```ruby\ndef self.cask_api_available?\n  # Always true in Homebrew 5.0+\n  true\nend\n```\n\n**Step 3: Find has_url? method at line 109**\nCurrent code:\n```ruby\ndef self.has_url?(cask)\n  cask.respond_to?(:url)\nend\n```\n\nReplace with:\n```ruby\ndef self.has_url?(cask)\n  # Direct attribute access (Homebrew 5.0+)\n  !cask.url.nil?\nend\n```\n\n**Step 4: Find checksum method at line 117**\nCurrent code:\n```ruby\ndef self.checksum(cask)\n  cask.respond_to?(:sha256) ? cask.sha256 : nil\nend\n```\n\nReplace with:\n```ruby\ndef self.checksum(cask)\n  # Direct sha256 access (Homebrew 5.0+)\n  cask.sha256\nend\n```\n\n**Step 5: Verify all changes**\n```bash\nruby -c mirror/lib/cask_helpers.rb\n# Expected: Syntax OK\n```\n\n### Step Group 5: Test the Simplified Code\n\n**Step 1: Test all_casks method**\n```bash\ncd /Users/ryan/src/offlinebrew\nbrew ruby -e \"require_relative 'mirror/lib/cask_helpers'; puts CaskHelpers.all_casks.count\"\n```\nExpected: Should return count of casks without errors\n\n**Step 2: Test cask operations**\n```bash\nbrew ruby -e \"\nrequire_relative 'mirror/lib/cask_helpers'\ncask = CaskHelpers.load_cask('firefox')\nputs \\\"Has URL: #{CaskHelpers.has_url?(cask)}\\\"\nputs \\\"Checksum: #{CaskHelpers.checksum(cask)}\\\"\n\"\n```\nExpected: Should print URL status and checksum\n\n**Step 3: Run any existing helper tests**\n```bash\ncd mirror\nfind test -name \"*helper*\" -type f\n# Run any helper test files found\n```\n\n### Step Group 6: Final Verification and Commit\n\n**Step 1: Verify no conditional API checks remain**\n```bash\ngrep -n \"respond_to?\\|defined?\" mirror/lib/cask_helpers.rb mirror/lib/dependency_resolver.rb mirror/lib/download_helpers.rb\n```\nExpected: Minimal or no results (maybe comments only)\n\n**Step 2: Verify no rescue fallbacks remain**\n```bash\ngrep -n \"rescue.*fallback\\|rescue.*alternative\" mirror/lib/\n```\nExpected: No output\n\n**Step 3: Test with integration tests**\n```bash\nmake test-unit  # if unit tests exist\n```\nExpected: All tests pass\n\n**Step 4: Commit the changes**\n```bash\ngit add mirror/lib/cask_helpers.rb mirror/lib/dependency_resolver.rb mirror/lib/download_helpers.rb\ngit commit -m \"refactor(bd-pve): remove API fallbacks and conditional checks\n\n- Simplify all_casks to use only Cask::Cask.all API\n- Remove respond_to? checks in dependency_resolver.rb\n- Remove respond_to? checks in download_helpers.rb\n- Remove defined? checks in cask_helpers.rb helper methods\n- Assume Homebrew 5.0+ APIs are always available\n- Methods now fail fast with clear errors if APIs missing\n\nPart of bd-8mg: Simplify offlinebrew to require Homebrew 5.0+ only\"\n```\n\n## Key Considerations\n\n### Edge Case: API Method Missing\nIf Cask::Cask.all doesn't exist:\n- Method will raise NoMethodError with clear message\n- Better than silent fallback masking the real problem\n- User gets immediate feedback about incompatible Homebrew version\n\n### Edge Case: Nil Dependencies\nWhen cask.depends_on is nil:\n- Use safe navigation operator (\u0026.) to handle gracefully\n- Return empty arrays as sensible defaults\n- Don't try multiple methods, just handle nil case\n\n### Edge Case: Missing Attributes\nWhen cask.url or cask.sha256 don't exist:\n- Let Ruby raise AttributeError naturally\n- Clear error message indicates which cask has the problem\n- Easier to debug than silent nil returns\n\n## Anti-patterns\n- ❌ Don't wrap everything in begin/rescue blocks\n- ❌ Don't check if methods exist before calling them\n- ❌ Don't provide multiple fallback paths\n- ❌ Don't return empty arrays on errors (fail fast instead)\n- ❌ Don't suppress errors with warnings","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-13T19:07:50.789328-05:00","updated_at":"2025-11-13T21:22:44.066565-05:00","source_repo":".","labels":["parent:bd-8mg"],"dependencies":[{"issue_id":"bd-pve","depends_on_id":"bd-8mg","type":"parent-child","created_at":"2025-11-13T19:08:20.902435-05:00","created_by":"ryan"},{"issue_id":"bd-pve","depends_on_id":"bd-1ml","type":"blocks","created_at":"2025-11-13T19:08:22.565253-05:00","created_by":"ryan"}],"comments":[{"id":3,"issue_id":"bd-pve","author":"ryan","text":"## Design\n\n### Goal\nRemove all API fallback methods and use only modern Homebrew APIs\n\n### Files to modify\n- `mirror/lib/cask_helpers.rb`\n- `mirror/lib/formula_helpers.rb`\n- Any other files with API fallbacks\n\n### Changes for cask_helpers.rb\n\n1. **Simplify all_casks method** (lines 21-61):\n   - Remove all fallback attempts\n   - Use only the modern API:\n   ```ruby\n   def self.all_casks\n     ENV['HOMEBREW_EVAL_ALL'] = '1'\n     Cask::Cask.all\n   end\n   ```\n   - Fail fast if API not available\n\n2. **Simplify cask_installed? method** (lines 67-103):\n   - Remove multiple fallback approaches\n   - Use only modern API:\n   ```ruby\n   def self.cask_installed?(cask_name)\n     Cask::Cask.installed.any? { |c| c.token == cask_name }\n   end\n   ```\n\n3. **Clean up cask_sources method** (lines 107-148):\n   - Remove conditional loading\n   - Use direct API calls only\n\n### Check formula_helpers.rb\n1. Search for similar fallback patterns\n2. Remove any legacy API usage\n3. Ensure modern APIs only\n\n### Verification\n- Test with sample casks and formulas\n- Ensure clean failures if APIs unavailable\n- Run unit tests for helpers","created_at":"2025-11-14T00:21:15Z"}]}
{"id":"bd-rv9","content_hash":"f19ff1e00393be6b90f9f131bcf1831cc9ed767d6d3c1cd217246d33b60b232a","title":"Remove legacy conversion from brew-offline-install","description":"","design":"## Goal\nRemove the legacy config auto-conversion code from brew-offline-install and add clear error messages for old format.\n\n## Context\nThis is Step Group 1 of bd-1ml. Currently brew-offline-install:195-209 contains auto-conversion logic that converts old single-tap format to new multi-tap format. This must be removed and replaced with clear error messages.\n\n## Implementation Steps\n\n1. Read brew-offline-install lines 195-209 to confirm current state\n2. Replace lines 195-209 with new code that:\n   - Checks if config[:commit] exists (old format indicator)\n   - Aborts with helpful error message if old format detected\n   - Checks if config[:taps] exists (new format required)\n   - Aborts with helpful error if taps missing\n   - Assigns taps = config[:taps] if valid\n3. Add tap validation after taps assignment:\n   - Validate each tap is a Hash\n   - Validate each tap has 'commit' field\n   - Validate each tap has 'type' field\n4. Run ruby -c to verify syntax\n5. Test with old format config (should error)\n6. Test with new format config (should work)\n\n## Files Modified\n- mirror/bin/brew-offline-install\n\n## Success Criteria\n- [ ] Lines 195-209 replaced with error detection code\n- [ ] Old format detection aborts with clear error message\n- [ ] Missing taps section aborts with clear error message\n- [ ] Tap validation added\n- [ ] Syntax check passes (ruby -c)\n- [ ] Manual test with old format shows error\n- [ ] Manual test with new format works","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-14T08:20:15.459386-05:00","updated_at":"2025-11-14T08:22:48.810302-05:00","closed_at":"2025-11-14T08:22:48.810302-05:00","source_repo":".","dependencies":[{"issue_id":"bd-rv9","depends_on_id":"bd-1ml","type":"parent-child","created_at":"2025-11-14T08:20:21.117949-05:00","created_by":"ryan"}]}
{"id":"bd-vlc","content_hash":"39e3667c46bea1ea6cce01ffd3bc08a065872706ab589cff4467fc6ee1b67941","title":"Update integration tests for legacy format rejection","description":"","design":"## Goal\nUpdate integration tests to expect legacy format rejection instead of backward compatibility.\n\n## Context\nThis is Step Group 6 of bd-1ml. The test file mirror/test/integration/test_error_handling.rb:210-260 has test_backward_compatible_config that expects old format to work. This must be updated to expect rejection.\n\nCompleted bd-rv9, bd-2oh, bd-8vd.\n\n## Implementation Steps\n\n1. Read test_error_handling.rb test_backward_compatible_config method (lines 210-260)\n2. Rename test to test_legacy_format_rejection\n3. Update test to expect SystemExit/abort when old format is used\n4. Update assertion to check for legacy format error message\n5. Run the test to verify it passes\n6. Check for any other tests that expect backward compatibility\n\n## Files Modified\n- mirror/test/integration/test_error_handling.rb\n\n## Success Criteria\n- [ ] test_backward_compatible_config renamed to test_legacy_format_rejection\n- [ ] Test expects SystemExit/abort for old format\n- [ ] Test verifies error message mentions legacy format\n- [ ] Test passes when run\n- [ ] No other tests expect backward compatibility","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-14T08:26:57.565429-05:00","updated_at":"2025-11-14T08:28:09.514209-05:00","closed_at":"2025-11-14T08:28:09.514209-05:00","source_repo":".","dependencies":[{"issue_id":"bd-vlc","depends_on_id":"bd-1ml","type":"parent-child","created_at":"2025-11-14T08:27:08.014087-05:00","created_by":"ryan"},{"issue_id":"bd-vlc","depends_on_id":"bd-8vd","type":"blocks","created_at":"2025-11-14T08:27:08.543552-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0","content_hash":"1c1871b9b6c7fd095f6f7f78d763175ec3fac88f644e235966d2e06d12dae655","title":"Set up Tart-based end-to-end test automation for offlinebrew","description":"Create automated tests using Tart CLI to validate offlinebrew works end-to-end: install Homebrew, install offlinebrew, mirror packages with dependencies, and install from mirror. Tests should run locally with fresh VMs, representative package set, and verify installations work.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-11-13T13:26:54.665425-05:00","updated_at":"2025-11-13T13:26:54.665425-05:00","source_repo":"."}
{"id":"offlinebrew-3d0.1","content_hash":"e9376d971b1f730e265beb87de123576f1eb38aaac606ab79dfd8472321a6b58","title":"Create test directory structure and configuration files","description":"Create test/integration/ directory with subdirectories: phases/, config/, lib/. Ensure proper permissions.","design":"## Goal\nCreate the directory structure for Tart-based integration tests.\n\n## Effort Estimate\n15-20 minutes\n\n## Success Criteria\n- [ ] test/integration/ directory exists\n- [ ] test/integration/phases/ directory exists\n- [ ] test/integration/config/ directory exists\n- [ ] test/integration/lib/ directory exists\n- [ ] All phase scripts have executable permissions (chmod +x)\n- [ ] Running \\`ls -R test/integration\\` shows all directories\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create directory structure\n\n**Files:**\n- Create: `test/` (directory)\n- Create: `test/integration/` (directory)\n- Create: `test/integration/phases/` (directory)\n- Create: `test/integration/config/` (directory)\n- Create: `test/integration/lib/` (directory)\n\n**Step 1: Create all directories in one command**\n\nFrom project root `/Users/ryan/src/offlinebrew`, run:\n\n\\`\\`\\`bash\nmkdir -p test/integration/{phases,config,lib}\n\\`\\`\\`\n\nThis creates:\n- `test/` (parent directory)\n- `test/integration/` (main integration test directory)\n- `test/integration/phases/` (for test phase scripts)\n- `test/integration/config/` (for test configuration files)\n- `test/integration/lib/` (for shared utilities)\n\n**Expected output**: None (silent success)\n\n**Step 2: Verify directory structure**\n\nRun:\n\\`\\`\\`bash\nls -R test/integration\n\\`\\`\\`\n\n**Expected output**:\n\\`\\`\\`\ntest/integration:\nconfig\tlib\tphases\n\ntest/integration/config:\n\ntest/integration/lib:\n\ntest/integration/phases:\n\\`\\`\\`\n\n**Step 3: Verify directories exist with tree view (alternative)**\n\nRun:\n\\`\\`\\`bash\nfind test/integration -type d | sort\n\\`\\`\\`\n\n**Expected output**:\n\\`\\`\\`\ntest/integration\ntest/integration/config\ntest/integration/lib\ntest/integration/phases\n\\`\\`\\`\n\n**Step 4: Commit the directory structure**\n\n\\`\\`\\`bash\ngit add test/\ngit commit -m \"feat(offlinebrew-3d0.1): create Tart integration test directory structure\n\nCreates test/integration/ with subdirectories:\n- phases/ - for test phase scripts\n- config/ - for test configuration files  \n- lib/ - for shared utilities\n\nThis is a new Tart-based E2E test suite, separate from existing\nRuby unit tests in mirror/test/.\n\nRef: offlinebrew-3d0.1\"\n\\`\\`\\`\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- No executable permissions needed yet - phase scripts will be created and made executable in later tasks (3d0.4-3d0.8)\n- Uses \\`mkdir -p\\` which is idempotent - safe to run multiple times\n- Brace expansion \\`{phases,config,lib}\\` creates all three subdirectories at once\n- New structure is intentionally at root level, distinct from existing \\`mirror/test/\\` Ruby tests\n\n## Edge Cases\n- **Directory Already Exists**: mkdir -p is idempotent, safe to run multiple times\n- **Permission Denied**: If parent directory not writable, will fail - this is expected\n- **Existing Files**: Won't overwrite existing files, only creates missing directories\n\n## Anti-patterns\n- ❌ Don't use \\`rm -rf test\\` first - preserve existing test files\n- ❌ Don't hardcode absolute paths - use relative to project root\n- ❌ Don't skip verification step - must confirm structure exists","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:05.34305-05:00","updated_at":"2025-11-13T14:59:16.072261-05:00","closed_at":"2025-11-13T14:59:16.072261-05:00","source_repo":"."}
{"id":"offlinebrew-3d0.10","content_hash":"f748756b71f6fb92a4ea5861596356354ed7f9c5a10bb7bb4e09a5171eadb730","title":"Create Makefile with test targets","description":"Define config variables (TART_VM_NAME, etc), implement targets: test (full suite), test-mirror, test-install, clean (delete VM and artifacts), add help target","design":"## Goal\nCreate Makefile with convenient targets to run tests and manage test environment.\n\n## Effort Estimate\n1 hour\n\n## Success Criteria\n- [ ] Makefile exists in project root\n- [ ] `make test` runs full test suite\n- [ ] `make test-mirror` runs mirror creation only (assumes VM setup)\n- [ ] `make test-install` runs installation verification only (assumes mirror exists)\n- [ ] `make clean` deletes VM and artifacts\n- [ ] `make help` prints usage information\n- [ ] All variables properly defined\n- [ ] .PHONY declarations present\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create Makefile\n\n**Files:**\n- Create: `Makefile` (project root)\n\n**Step 1: Create Makefile with header and variables**\n\nFrom project root, create the Makefile:\n\n**IMPORTANT**: Makefiles require TAB characters (not spaces) for recipe indentation. The commands below will create a proper Makefile with tabs.\n\n```bash\ncat \u003e Makefile \u003c\u003c 'EOF'\n# Offlinebrew Tart Integration Tests\n#\n# Makefile for running end-to-end tests using Tart VM\n\n# Configuration\nTART_VM_NAME := offlinebrew-test\nTART_IMAGE := ghcr.io/cirruslabs/macos-sonoma-vanilla:latest\nTART_CPUS := 4\nTART_MEMORY := 8192\n\n# Paths\nTEST_SCRIPT := test/integration/tart-e2e.sh\nPHASES_DIR := test/integration/phases\n\n# Phony targets (not actual files)\n.PHONY: help test test-mirror test-install clean\n\nEOF\n```\n\n**Expected output**: File created\n\n### Step Group 2: Add test targets\n\n**Step 2: Add help target (default)**\n\nAppend to the Makefile:\n\n```bash\ncat \u003e\u003e Makefile \u003c\u003c 'EOF'\n# Default target - show help\nhelp:\n\t@echo \"Offlinebrew Tart Integration Tests\"\n\t@echo \"\"\n\t@echo \"Usage:\"\n\t@echo \"  make test          - Run full end-to-end test suite (10-15 min)\"\n\t@echo \"  make test-mirror   - Run mirror creation test only\"\n\t@echo \"  make test-install  - Run installation verification only\"\n\t@echo \"  make clean         - Delete test VM and artifacts\"\n\t@echo \"  make help          - Show this help message\"\n\t@echo \"\"\n\t@echo \"Requirements:\"\n\t@echo \"  - Tart CLI installed (brew install tart)\"\n\t@echo \"  - ~50GB disk space for VM and mirror\"\n\t@echo \"  - macOS host (Apple Silicon or Intel)\"\n\t@echo \"\"\n\t@echo \"Environment variables:\"\n\t@echo \"  TART_VM_NAME       - VM name (default: $(TART_VM_NAME))\"\n\t@echo \"  TART_CPUS          - CPU count (default: $(TART_CPUS))\"\n\t@echo \"  TART_MEMORY        - Memory in MB (default: $(TART_MEMORY))\"\n\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 3: Add full test target**\n\nAppend to the Makefile:\n\n```bash\ncat \u003e\u003e Makefile \u003c\u003c 'EOF'\n# Run full end-to-end test suite\ntest:\n\t@echo \"========================================\"\n\t@echo \"Starting Tart End-to-End Test Suite\"\n\t@echo \"========================================\"\n\t@echo \"\"\n\t@echo \"Configuration:\"\n\t@echo \"  VM Name: $(TART_VM_NAME)\"\n\t@echo \"  CPUs: $(TART_CPUS)\"\n\t@echo \"  Memory: $(TART_MEMORY)MB\"\n\t@echo \"  Image: $(TART_IMAGE)\"\n\t@echo \"\"\n\t@export TART_VM_NAME=$(TART_VM_NAME) \u0026\u0026 bash $(TEST_SCRIPT)\n\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 4: Add partial test targets**\n\nAppend to the Makefile:\n\n```bash\ncat \u003e\u003e Makefile \u003c\u003c 'EOF'\n# Run mirror creation test only (assumes VM already setup)\ntest-mirror:\n\t@echo \"Running mirror creation test...\"\n\t@echo \"Note: Assumes VM is setup with Homebrew and offlinebrew installed\"\n\t@export TART_VM_NAME=$(TART_VM_NAME) \u0026\u0026 bash $(PHASES_DIR)/create-mirror.sh\n\n# Run installation verification test only (assumes mirror exists)\ntest-install:\n\t@echo \"Running installation verification test...\"\n\t@echo \"Note: Assumes mirror already created\"\n\t@export TART_VM_NAME=$(TART_VM_NAME) \u0026\u0026 bash $(PHASES_DIR)/verify-install.sh\n\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 5: Add clean target**\n\nAppend to the Makefile:\n\n```bash\ncat \u003e\u003e Makefile \u003c\u003c 'EOF'\n# Clean up test VM and artifacts\nclean:\n\t@echo \"Cleaning up test environment...\"\n\t@tart delete $(TART_VM_NAME) 2\u003e/dev/null || echo \"  VM not found (already clean)\"\n\t@echo \"Cleanup complete\"\n\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 6: Verify Makefile syntax**\n\n```bash\nmake -n help\n```\n\n**Expected output**: Should print the help target commands (dry-run)\n\n**Step 7: Test help target**\n\n```bash\nmake help\n```\n\n**Expected output**: Should print the help message\n\n**Step 8: Commit the Makefile**\n\n```bash\ngit add Makefile\ngit commit -m \"feat(offlinebrew-3d0.10): add Makefile with test targets\n\nCreates Makefile in project root with targets:\n- help (default) - Show usage information\n- test - Run full end-to-end test suite via tart-e2e.sh\n- test-mirror - Run mirror creation phase only\n- test-install - Run installation verification phase only\n- clean - Delete test VM and artifacts\n\nConfiguration variables:\n- TART_VM_NAME - VM name (default: offlinebrew-test)\n- TART_CPUS - CPU count (default: 4)\n- TART_MEMORY - Memory in MB (default: 8192)\n- TART_IMAGE - Base image (default: macos-sonoma-vanilla)\n\nPartial test targets (test-mirror, test-install) assume prior\nsetup and are useful for debugging specific phases.\n\nFull test suite takes 10-15 minutes.\n\nRef: offlinebrew-3d0.10\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **Tab vs Spaces**: Makefile REQUIRES tabs (not spaces) for recipe indentation - the cat heredoc preserves tabs\n- **@ prefix**: Suppresses command echo for cleaner output\n- **|| true**: Makes commands optional (don't fail if VM doesn't exist)\n- **export**: Passes TART_VM_NAME to shell scripts as environment variable\n- **Default target**: help is first, so running `make` with no args shows help\n\n## Key Considerations\n\n**Make Syntax**:\n- MUST use tabs (not spaces) for recipe indentation - Makefile won't parse otherwise\n- @ prefix suppresses command echo for cleaner output\n- || true makes commands optional (don't fail if condition not met)\n- := for immediate variable expansion vs = for deferred\n\n**Partial Test Targets**:\n- test-mirror and test-install assume prior setup already done\n- Useful for debugging specific phases without full suite rerun\n- Not fully isolated - require manual VM setup first\n- Faster iteration during development\n\n**Variable Usage**:\n- Variables defined at top for easy customization\n- Can override from command line: `make test TART_CPUS=8 TART_MEMORY=16384`\n- Exported to environment for shell scripts\n- Documented in help target\n\n**Default Target**:\n- First target is default when running `make` with no args\n- help is first for good UX (shows available commands)\n- Could make test first if prefer running tests by default\n\n**Clean Target**:\n- Independent target, doesn't depend on test\n- Safe to run multiple times (idempotent)\n- Handles case where VM doesn't exist gracefully\n\n## Edge Cases\n- **Make Not Installed**: Should be present on macOS by default (part of Xcode Command Line Tools)\n- **Tart Not Installed**: clean target handles gracefully with || true\n- **Tab vs Spaces**: Most common Makefile error - ensure tabs used\n- **Missing Scripts**: Make will fail with clear \"No such file\" error\n- **Variables Not Exported**: Scripts won't see TART_VM_NAME without export\n- **Spaces in Paths**: Variables handle this correctly with :=\n\n## Anti-patterns\n- ❌ Don't use spaces instead of tabs in recipes - Makefile won't parse\n- ❌ Don't make clean depend on test - should be independent operation\n- ❌ Don't use relative paths inconsistently - define at top as variables\n- ❌ Don't fail clean if VM doesn't exist - use || true for optional cleanup\n- ❌ Don't forget .PHONY declaration - targets aren't actual files\n- ❌ Don't use = instead of := - can cause unexpected variable expansion\n- ❌ Don't forget to export variables - shell scripts won't see them","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:57.165728-05:00","updated_at":"2025-11-13T15:13:02.02984-05:00","closed_at":"2025-11-13T15:13:02.02984-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.10","depends_on_id":"offlinebrew-3d0.9","type":"blocks","created_at":"2025-11-13T13:27:57.166407-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.11","content_hash":"4b173ce823397b3a1cd98998376c1634879f7783c55e89a7147f74aefe7828c2","title":"Add test/integration/README.md","description":"Document prerequisites (Tart, disk space), usage examples, package configuration, troubleshooting","design":"## Goal\nDocument the Tart-based test suite with comprehensive README covering prerequisites, usage, and troubleshooting.\n\n## Effort Estimate\n30-45 minutes\n\n## Success Criteria\n- [ ] File test/integration/README.md exists\n- [ ] README documents prerequisites (Tart, disk space, macOS)\n- [ ] README shows usage examples for all make targets\n- [ ] README explains package configuration\n- [ ] README includes troubleshooting section\n- [ ] README estimates test duration\n- [ ] README is clear and beginner-friendly\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create README.md\n\n**Files:**\n- Create: `test/integration/README.md`\n\n**Step 1: Create README with title and overview**\n\nFrom project root, create the README:\n\n```bash\ncat \u003e test/integration/README.md \u003c\u003c 'EOF'\n# Tart End-to-End Integration Tests\n\nAutomated end-to-end tests for offlinebrew using Tart VM isolation to validate the complete workflow:\n\n1. **Setup fresh VM** - Create macOS VM with Tart\n2. **Install Homebrew** - Non-interactive Homebrew installation\n3. **Install offlinebrew** - Copy local code and configure\n4. **Create mirror** - Mirror test packages with dependencies\n5. **Verify installation** - Install packages from mirror and verify\n\nThis ensures offlinebrew works end-to-end with a real Homebrew installation on a clean system.\n\n## Prerequisites\n\n- **Tart CLI**: Install via Homebrew\n  ```bash\n  brew install tart\n  ```\n  Or download from https://github.com/cirruslabs/tart\n\n- **macOS host**: Apple Silicon or Intel Mac\n  - Apple Silicon recommended for best performance\n  - Tart only runs on macOS\n\n- **Disk space**: ~50GB available\n  - 20-40GB for macOS base image (cached after first download)\n  - 1-2GB for package mirror\n  - 10GB for VM storage\n  - Use `df -h` to check available space\n\n- **Network**: Required for initial setup\n  - Homebrew installation\n  - Base image pull (first run only)\n  - Package downloads\n\n- **Time**: \n  - First run: 15-20 minutes (includes base image download)\n  - Subsequent runs: 10-15 minutes\n\n## Quick Start\n\nRun full test suite:\n```bash\nmake test\n```\n\nClean up after tests:\n```bash\nmake clean\n```\n\nThat's it! The test suite will:\n- Pull macOS Sonoma base image (first run only, cached thereafter)\n- Create fresh VM with 4 CPU, 8GB RAM\n- Install Homebrew non-interactively\n- Copy local offlinebrew code to VM\n- Create mirror with 5 test packages and dependencies\n- Install and verify all packages from mirror\n- Report success or failure\n\n## Usage\n\n### Run Full Test Suite\n\n```bash\nmake test\n```\n\nRuns all phases sequentially:\n1. `setup-vm.sh` - Create fresh Tart VM\n2. `install-homebrew.sh` - Install Homebrew\n3. `install-offlinebrew.sh` - Copy and configure offlinebrew\n4. `create-mirror.sh` - Mirror test packages\n5. `verify-install.sh` - Install and verify packages\n\n**Duration**: 10-15 minutes (first run may take longer for image download)\n\n**VM cleanup**: VM is deleted on success, preserved on failure for debugging\n\n### Run Specific Phases\n\nFor faster iteration during development:\n\n```bash\n# Test mirror creation only (assumes VM setup complete)\nmake test-mirror\n\n# Test installation only (assumes mirror exists)\nmake test-install\n```\n\n**Note**: These assume prior setup. Use `make test` for full isolated test.\n\n### Clean Up\n\n```bash\nmake clean\n```\n\nDeletes the test VM and frees ~30GB disk space. Safe to run multiple times.\n\n### Show Help\n\n```bash\nmake help\n```\n\nDisplays all available commands and configuration options.\n\n### Customize VM Configuration\n\nOverride defaults via environment variables:\n\n```bash\n# Use more CPU and memory\nmake test TART_CPUS=8 TART_MEMORY=16384\n\n# Use custom VM name\nmake test TART_VM_NAME=my-test-vm\n```\n\n**Defaults**:\n- `TART_VM_NAME=offlinebrew-test`\n- `TART_CPUS=4`\n- `TART_MEMORY=8192` (MB)\n- `TART_IMAGE=ghcr.io/cirruslabs/macos-sonoma-vanilla:latest`\n\n## Package Configuration\n\nTest packages are defined in `config/test-packages.txt` in CSV format:\n\n```\n# Format: type,name,version_command\nformula,wget,wget --version\nformula,jq,jq --version\nformula,nginx,nginx -v\ncask,firefox,/Applications/Firefox.app/Contents/MacOS/firefox --version\ncask,rectangle,defaults read /Applications/Rectangle.app/Contents/Info CFBundleShortVersionString\n```\n\n**Fields**:\n- `type`: Either `formula` (CLI tool) or `cask` (GUI application)\n- `name`: Package name as known to Homebrew\n- `version_command`: Shell command to verify installation\n\n**Adding Packages**:\n\nTo test additional packages, add lines to this file:\n\n```bash\n# Add a formula\nformula,htop,htop --version\n\n# Add a cask\ncask,slack,/Applications/Slack.app/Contents/MacOS/Slack --version\n```\n\n**Notes**:\n- Comments start with `#`\n- Empty lines are ignored\n- Mirror includes dependencies automatically via `--with-deps` flag\n- Large casks (e.g., firefox ~200MB) increase mirror size and test duration\n\n## Troubleshooting\n\n### VM fails to start\n\n**Symptom**: `tart run` errors or hangs\n\n**Solutions**:\n- Check disk space: `df -h` (need ~50GB free)\n- Check Tart version: `tart --version` (need 2.0+)\n- Try manual VM start: `tart run offlinebrew-test`\n- Check for stale VMs: `tart list`\n- Delete and retry: `make clean \u0026\u0026 make test`\n\n### Homebrew install hangs\n\n**Symptom**: Install phase doesn't complete after 5+ minutes\n\n**Solutions**:\n- Check network connectivity from host\n- VM may need more time - wait up to 10 minutes for first boot\n- Check if VM is running: `tart list`\n- Connect to VM to inspect: `tart run offlinebrew-test`\n- Check Homebrew install logs in VM\n\n### Package mirror fails\n\n**Symptom**: Mirror creation phase errors with \"Tap not installed\"\n\n**Solutions**:\n- Ensure bundled tap fix is applied (see commits: \"Support bundled core/cask taps\")\n- Verify Homebrew version in VM: `brew --version` (should be 4.0+)\n- Check packages exist: `brew search \u003cpackage\u003e`\n- Verify network access from VM\n- Try with fewer packages first\n\n### Version command fails for package\n\n**Symptom**: Package installs but version verification fails\n\n**Solutions**:\n- Check version command syntax in test-packages.txt\n- Some commands write to stderr (e.g., nginx -v)\n- Some commands require full path (casks)\n- Test command manually in VM: `tart run offlinebrew-test`\n- Check if application actually installed: `ls /Applications/`\n\n### Tests fail but VM is running\n\n**Symptom**: Test reports failure but VM still exists\n\n**Expected behavior**: VM is intentionally left running on failure for debugging\n\n**Inspection**:\n```bash\n# Connect to VM\ntart run offlinebrew-test\n\n# Inside VM, check state:\nbrew --version\nbrew offline --help\nls /tmp/brew_mirror\n```\n\n**Cleanup when done**:\n```bash\nmake clean\n```\n\n### Disk space issues\n\n**Symptom**: \"No space left on device\" errors\n\n**Solutions**:\n- Check space: `df -h`\n- Clean up test VM: `make clean`\n- Clear Tart image cache: `rm -rf ~/.tart/vms/cache/`\n- Clear Homebrew cache: `brew cleanup`\n\n### Network rate limiting\n\n**Symptom**: \"Too many requests\" from GitHub/Homebrew\n\n**Solutions**:\n- Wait 15-30 minutes before retrying\n- Use authentication token for higher limits\n- Test with fewer packages\n\n## Test Architecture\n\n```\ntest/integration/\n├── tart-e2e.sh           # Main orchestrator (runs all phases)\n├── phases/               # Individual test phases\n│   ├── setup-vm.sh       # Create fresh Tart VM\n│   ├── install-homebrew.sh      # Install Homebrew\n│   ├── install-offlinebrew.sh   # Copy and configure offlinebrew\n│   ├── create-mirror.sh         # Mirror packages\n│   └── verify-install.sh        # Install and verify packages\n├── config/               # Test configuration\n│   └── test-packages.txt # Package list\n├── lib/                  # Shared utilities\n│   └── test-helpers.sh   # Logging, assertions, VM communication\n└── README.md             # This file\n```\n\n**Key Principles**:\n- **Isolation**: Fresh VM for each full test run\n- **Fail-fast**: Stops on first phase failure\n- **Debugging**: VM preserved on failure\n- **Cleanup**: VM deleted on success\n\n**Phase Dependencies**:\n1. setup-vm → 2. install-homebrew → 3. install-offlinebrew → 4. create-mirror → 5. verify-install\n\nEach phase depends on successful completion of previous phases.\n\n## Development\n\n### Running Individual Phases\n\nFor development and debugging, run phases directly:\n\n```bash\n# From project root\nbash test/integration/phases/setup-vm.sh\nbash test/integration/phases/install-homebrew.sh\nbash test/integration/phases/install-offlinebrew.sh\nbash test/integration/phases/create-mirror.sh\nbash test/integration/phases/verify-install.sh\n```\n\n**Note**: Later phases assume earlier phases completed successfully.\n\n### Modifying Test Helpers\n\nShared utilities in `lib/test-helpers.sh`:\n- `info()`, `ok()`, `warn()`, `error()` - Colored logging\n- `vm_exec()` - Execute commands in VM\n- `assert_*()` - Assertion helpers\n\nChanges to helpers affect all phase scripts.\n\n### Adding New Phases\n\nTo add a new test phase:\n\n1. Create script in `phases/` directory\n2. Source `test-helpers.sh` for utilities\n3. Add to `phases` array in `tart-e2e.sh`\n4. Update this README\n\n## FAQ\n\n**Q: Why does the first run take so long?**  \nA: First run downloads ~20-40GB macOS Sonoma base image. Subsequent runs use cached image.\n\n**Q: Can I run tests in parallel?**  \nA: No, phases must run sequentially due to dependencies.\n\n**Q: Can I use existing VM?**  \nA: Not with `make test` - it creates fresh VM. Use individual phase scripts for existing VM.\n\n**Q: Why is VM deleted after tests?**  \nA: To save ~30GB disk space. VM is preserved on failure for debugging.\n\n**Q: Can I test on Linux?**  \nA: No, Tart only runs on macOS. Consider using Docker for Linux testing.\n\n**Q: How do I update base image?**  \nA: `tart pull ghcr.io/cirruslabs/macos-sonoma-vanilla:latest` - downloads latest version.\n\nEOF\n```\n\n**Expected output**: File created\n\n**Step 2: Commit the README**\n\n```bash\ngit add test/integration/README.md\ngit commit -m \"docs(offlinebrew-3d0.11): add comprehensive test README\n\nCreates test/integration/README.md with:\n- Overview of test suite and workflow\n- Prerequisites (Tart, disk space, network)\n- Quick start guide\n- Usage examples for all make targets\n- Package configuration documentation\n- Comprehensive troubleshooting section\n- Test architecture explanation\n- Development guide\n- FAQ\n\nDocuments:\n- 5 test phases and their dependencies\n- VM configuration options\n- Common issues and solutions\n- Package list customization\n- Debugging tips\n\nProvides clear guidance for running and debugging the\nTart-based end-to-end test suite.\n\nRef: offlinebrew-3d0.11\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **Beginner-friendly**: Assumes no Tart or VM experience\n- **Actionable**: Troubleshooting provides specific solutions, not just descriptions\n- **Complete**: Covers prerequisites, usage, configuration, troubleshooting, and architecture\n- **Maintainable**: Structured for easy updates as tests evolve\n\n## Key Considerations\n\n**Audience**:\n- Target: Junior engineers, contributors, or users testing offlinebrew\n- Assumes basic command-line knowledge (cd, ls, make)\n- Doesn't assume Tart, VM, or virtualization experience\n- Explains technical concepts clearly\n\n**Troubleshooting Coverage**:\n- Focus on issues discovered during initial testing\n- Provide actionable solutions with specific commands\n- Link to relevant documentation where helpful\n- Include debugging workflows (connect to VM, inspect state)\n\n**Maintenance**:\n- Keep in sync with actual implementation\n- Update troubleshooting as new issues discovered\n- Document any manual workarounds needed\n- Add FAQ items based on common questions\n\n**Structure**:\n- Quick start at top for impatient users\n- Progressive disclosure (basic → advanced)\n- Clear section headers for easy navigation\n- Code examples for every command\n\n## Edge Cases\n- **Tart Not Installed**: Covered in prerequisites with install command\n- **Insufficient Disk Space**: Covered in troubleshooting with df -h check\n- **Network Issues**: Covered in troubleshooting with connectivity checks\n- **First-time Tart Users**: Quick start provides minimal working example\n- **Custom Packages**: Configuration section explains how to add packages\n\n## Anti-patterns\n- ❌ Don't skip prerequisites - users need to know what to install first\n- ❌ Don't assume technical knowledge - explain VM, mirror, tap concepts\n- ❌ Don't provide outdated information - verify all commands actually work\n- ❌ Don't forget to document configuration - users will want to customize packages\n- ❌ Don't use jargon without explanation - define terms like \"bundled taps\"\n- ❌ Don't omit error messages - include actual error text for searchability","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:57.699045-05:00","updated_at":"2025-11-13T15:14:18.271706-05:00","closed_at":"2025-11-13T15:14:18.271706-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.11","depends_on_id":"offlinebrew-3d0.10","type":"blocks","created_at":"2025-11-13T13:27:57.699868-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.12","content_hash":"bef393a2b8b0352175a19746172697c5b9b479dcf48e387d92c674a343262e1f","title":"Run initial test validation","description":"Execute make test, monitor progress, verify all phases complete, validate cleanup, fix any issues, document gotchas","design":"## Goal\nExecute the complete test suite to validate all components work together and fix any issues discovered.\n\n## Effort Estimate\n1-2 hours (includes potential debugging time)\n\n## Success Criteria\n- [ ] `make clean` executes successfully\n- [ ] `make test` completes without errors\n- [ ] All 5 test phases complete successfully\n- [ ] All 5 packages install and verify correctly\n- [ ] VM is cleaned up after test\n- [ ] Test duration is reasonable (10-15 minutes after first run)\n- [ ] README is accurate (verified against actual run)\n- [ ] Any issues found are fixed\n- [ ] Test can be run multiple times successfully\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Pre-test verification\n\n**Step 1: Verify Tart is installed**\n\n```bash\nwhich tart\ntart --version\n```\n\n**Expected output**: \n```\n/opt/homebrew/bin/tart\ntart version 2.x.x\n```\n\nIf Tart not installed:\n```bash\nbrew install tart\n```\n\n**Step 2: Check disk space**\n\n```bash\ndf -h\n```\n\n**Expected output**: At least 50GB free on main disk\n\n**Step 3: Clean existing test VM (if any)**\n\n```bash\nmake clean\n```\n\n**Expected output**:\n```\nCleaning up test environment...\n  VM not found (already clean)\nCleanup complete\n```\n\nOr if VM exists, it will be deleted.\n\n### Step Group 2: First test run\n\n**Step 4: Start initial test run**\n\n```bash\nmake test\n```\n\n**What to watch for**:\n\n**Phase 1: setup-vm.sh**\n- Check for Tart CLI found\n- First run: Image pull starts (10-30 minutes, shows progress)\n- Subsequent runs: Uses cached image (fast)\n- VM clone succeeds\n- VM starts and reaches running state\n\n**Expected output snippet**:\n```\n[INFO] Checking for Tart CLI...\n[OK] Tart CLI found: tart version 2.x.x\n[INFO] Pulling base image: ghcr.io/cirruslabs/macos-sonoma-vanilla:latest\n[INFO] Note: First pull downloads ~20-40GB, subsequent pulls use cache\n...\n[OK] VM is running\n[OK] VM setup complete: offlinebrew-test\n```\n\n**Phase 2: install-homebrew.sh**\n- Homebrew install starts (2-5 minutes)\n- No prompts (NONINTERACTIVE=1)\n- brew --version shows output\n\n**Expected output snippet**:\n```\n[INFO] Installing Homebrew in VM (this may take 2-5 minutes)...\n...\n[OK] Homebrew installation completed\n[OK] Homebrew installed successfully: Homebrew 4.x.x\n[OK] brew command is available in PATH\n```\n\n**Phase 3: install-offlinebrew.sh**\n- Code copied to VM\n- PATH configured\n- brew offline --help works\n\n**Expected output snippet**:\n```\n[INFO] Copying offlinebrew code to VM...\n[OK] Code copied to VM successfully\n[OK] offlinebrew PATH configured\n[OK] brew offline command works\n```\n\n**Phase 4: create-mirror.sh**\n- Longest phase (5-10 minutes)\n- Downloads all packages and dependencies\n- Creates mirror structure\n\n**Expected output snippet**:\n```\n[INFO] Formulae to mirror: wget,jq,nginx\n[INFO] Casks to mirror: firefox,rectangle\n[INFO] Creating mirror with dependencies (this may take 5-10 minutes)...\n...\n[OK] Mirror created successfully\n[OK]   Location: /tmp/brew_mirror\n[OK]   Size: 1.5G\n[OK]   Files: 247\n```\n\n**Phase 5: verify-install.sh**\n- Installs all packages\n- Runs version commands\n- All should succeed\n\n**Expected output snippet**:\n```\n[1] Testing formula: wget\n  [OK] Installed wget\n  [OK] Verified: wget --version\n\n[2] Testing formula: jq\n  [OK] Installed jq\n  [OK] Verified: jq --version\n\n...\n\n[OK] All 5 packages installed and verified successfully\n```\n\n**Final summary**:\n```\n=========================================\n[OK] All tests passed!\n[INFO] Total phases: 5\n[INFO] Total duration: 12m 34s\n=========================================\n```\n\n**Step 5: Verify cleanup occurred**\n\n```bash\ntart list\n```\n\n**Expected output**: Should NOT show `offlinebrew-test` VM (cleaned up after success)\n\n**Step 6: Record test duration**\n\nNote the \"Total duration\" from test output. Should be:\n- First run: 15-25 minutes (includes image download)\n- Second run: 10-15 minutes (uses cached image)\n\n### Step Group 3: Handle failures\n\n**Step 7: If test fails, debug**\n\nIf any phase fails, the output will show:\n```\n[ERROR] Phase failed: \u003cphase-name\u003e\n```\n\nAnd VM will be left running for debugging:\n```\n[WARN] Tests failed - VM left running for debugging\n[WARN]   VM name: offlinebrew-test\n[WARN]   Connect: tart run offlinebrew-test\n[WARN]   Delete:  tart delete offlinebrew-test\n```\n\n**Debug steps**:\n\n1. Connect to VM:\n```bash\ntart run offlinebrew-test\n```\n\n2. Inside VM, check what failed:\n```bash\n# Check Homebrew\nbrew --version\n\n# Check offlinebrew\nbrew offline --help\n\n# Check mirror\nls -la /tmp/brew_mirror\n\n# Check packages\nbrew list\n```\n\n3. Review phase script that failed:\n```bash\n# From host\ncat test/integration/phases/\u003cfailed-phase\u003e.sh\n```\n\n4. Fix the issue in the phase script\n\n5. Clean up and re-test:\n```bash\nmake clean\nmake test\n```\n\n**Common issues and fixes**:\n\n**Issue**: \"Tap not installed: homebrew/homebrew-core\"\n**Fix**: Ensure bundled tap support is in tap_manager.rb (should already be fixed)\n\n**Issue**: \"brew offline command not found\"\n**Fix**: Check PATH configuration in install-offlinebrew.sh\n\n**Issue**: \"nginx -v failed\"\n**Fix**: nginx writes to stderr, verify stderr handling in verify-install.sh\n\n**Issue**: \"Permission denied\" running phase script\n**Fix**: `chmod +x test/integration/phases/*.sh`\n\n### Step Group 4: Verify idempotency\n\n**Step 8: Run test second time**\n\n```bash\nmake test\n```\n\n**Expected behavior**:\n- Should complete successfully again\n- Should be faster (image cached)\n- Should produce same results\n- No errors about existing VM (setup-vm deletes existing)\n\n**Expected output**: Same as first run, but faster (10-15 minutes)\n\n### Step Group 5: Validate documentation\n\n**Step 9: Verify README commands**\n\nTest each command documented in README:\n\n```bash\n# Help\nmake help\n\n# Clean\nmake clean\n\n# Test\nmake test\n\n# Partial tests (after full test)\nmake test-mirror    # Should work if VM still exists\nmake test-install   # Should work if mirror exists\n\n# Custom config\nmake test TART_CPUS=8\n```\n\n**Expected output**: All commands should work as documented\n\n**Step 10: Update README with gotchas (if any)**\n\nIf you discovered any issues during testing:\n\n```bash\nvim test/integration/README.md\n# Add to Troubleshooting section\n```\n\nExample gotchas to document:\n- Specific error messages encountered\n- Workarounds needed\n- Unexpected behavior\n- Time estimates if different than documented\n\n### Step Group 6: Final validation\n\n**Step 11: Verify all success criteria**\n\nChecklist:\n- [ ] `make clean` works\n- [ ] `make test` completes without errors\n- [ ] All 5 phases complete successfully\n- [ ] All 5 packages install and verify\n- [ ] VM cleaned up after test\n- [ ] Test duration 10-15 minutes (after first run)\n- [ ] README accurate\n- [ ] Issues fixed\n- [ ] Test can run multiple times\n\n**Step 12: Mark task complete and close epic**\n\n```bash\n# Update bd issue\nbd update 3d0.12 --status closed\n\n# Check epic status\nbd show 3d0\n\n# If all tasks complete, close epic\nbd update 3d0 --status closed\n```\n\n**Step 13: Create final commit (if README updated)**\n\nIf you updated README or fixed any issues:\n\n```bash\ngit add test/integration/README.md\ngit commit -m \"docs(offlinebrew-3d0.12): update README with validation results\n\nInitial test validation completed successfully:\n- All 5 phases pass\n- All 5 packages install and verify\n- Test duration: ~12 minutes (after image cache)\n- VM cleanup confirmed\n\nUpdated troubleshooting section with:\n- [List any gotchas discovered]\n\nRef: offlinebrew-3d0.12\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **First run time**: Highly variable due to image download (10-30 minutes)\n- **Network dependency**: Required for Homebrew install and package downloads\n- **Idempotency**: Critical that test can run multiple times\n- **VM cleanup**: Must verify VM actually deleted on success\n- **Error messages**: Should be clear and actionable\n\n## Key Considerations\n\n**First Run vs Subsequent Runs**:\n- First run downloads base image (~20-40GB, 10-30 minutes)\n- Image cached in ~/.tart/vms/cache/\n- Subsequent runs use cached image (much faster)\n- Document this timing difference for user expectations\n\n**Common First-Run Issues**:\n- **Tart not installed**: Error: \"tart: command not found\" - install via brew\n- **Insufficient disk space**: VM clone fails with \"no space\" error\n- **Network issues**: Image pull or Homebrew install timeout\n- **Bundled tap issues**: Should be fixed by tap_manager.rb changes\n- **Permission issues**: Phase scripts not executable - chmod +x\n\n**Debugging Strategy**:\n- VM left running on failure (intentional for debugging)\n- Connect with: `tart run offlinebrew-test`\n- Run commands manually to isolate issue\n- Check phase script for logic errors\n- Fix and re-test with clean state\n\n**Success Validation**:\n- Verify actual functionality, not just exit codes\n- Check packages actually installed: `brew list` in VM\n- Verify version commands produce output\n- Confirm cleanup removes VM: `tart list`\n- Ensure test is repeatable\n\n**Performance Expectations**:\n- First run: 15-25 minutes (image download + test)\n- Second run: 10-15 minutes (cached image)\n- Phase breakdown:\n  - setup-vm: 1-2 minutes (or 10-30 min first run)\n  - install-homebrew: 2-5 minutes\n  - install-offlinebrew: 30 seconds\n  - create-mirror: 5-10 minutes\n  - verify-install: 2-3 minutes\n\n## Edge Cases\n- **Disk Full Mid-Test**: Test may fail at any phase - run `make clean` to free space\n- **Network Drops**: Homebrew install or mirror creation fails - retry when network restored\n- **Tart Updates**: API changes may break scripts - test with latest Tart version\n- **macOS Updates**: VM image may need updating - pull latest base image\n- **First Run Timeout**: Image download may timeout - increase timeout or use faster network\n- **Concurrent Runs**: Multiple test runs may conflict - use different VM names\n\n## Anti-patterns\n- ❌ Don't skip second test run - idempotency critical for CI/CD\n- ❌ Don't ignore warnings - may indicate real issues\n- ❌ Don't accept \"mostly working\" - tests must pass 100%\n- ❌ Don't forget to update README with discoveries\n- ❌ Don't skip cleanup verification - confirm VM actually deleted\n- ❌ Don't leave broken tests - fix all issues before closing epic\n- ❌ Don't assume first success means repeatable - test multiple times\n\n## Validation Checklist\n\nAfter completing all steps:\n\n**Functional validation**:\n- [ ] Test runs without errors\n- [ ] All phases complete\n- [ ] All packages install\n- [ ] Version commands work\n- [ ] VM cleaned up\n\n**Documentation validation**:\n- [ ] README commands work\n- [ ] Error messages are clear\n- [ ] Troubleshooting accurate\n- [ ] Time estimates correct\n- [ ] Prerequisites complete\n\n**Quality validation**:\n- [ ] Test is repeatable\n- [ ] No manual intervention needed\n- [ ] Error handling works\n- [ ] Cleanup robust\n- [ ] Performance acceptable\n\n**If all checks pass**: Epic complete! 🎉","notes":"## Progress Update\n\n### Completed:\n1. ✓ Reopened task (was prematurely closed after static validation only)\n2. ✓ Fixed test infrastructure issues:\n   - Changed BASE_IMAGE to macos-sonoma-base (has Tart Guest Agent)\n   - Fixed vm_exec to use 'tart exec' instead of 'tart run'\n   - Added symlink creation for brew-offline in /opt/homebrew/bin\n   - Implemented portable symlink resolution in bin/brew-offline\n   - Simplified phase scripts to use symlink approach\n3. ✓ Committed fixes in commit 20b97a2\n\n### Test Execution Status:\n- Phase 1 (VM Setup): PASSED\n- Phase 2 (Homebrew Install): PASSED\n- Phase 3 (Offlinebrew Install): BLOCKED - brew offline verification fails\n- Phases 4-5: NOT REACHED\n\n### Remaining Work:\n1. Debug why brew offline command verification fails despite symlink\n2. Complete full test run through all 5 phases\n3. Verify idempotency (second test run)\n4. Update .validation-status file\n5. Close task and epic when validation complete\n\n### Blocker Details:\nTests hang or fail during Phase 3 verification. The symlink exists and brew-offline script executes correctly when called directly, but 'brew offline --help' fails in the test harness. Further investigation needed.\n\nNext steps: Manual debugging in VM to understand the exact failure mode.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:58.294497-05:00","updated_at":"2025-11-13T22:18:28.742386-05:00","closed_at":"2025-11-13T22:18:28.742386-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.12","depends_on_id":"offlinebrew-3d0.11","type":"blocks","created_at":"2025-11-13T13:27:58.295229-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.2","content_hash":"861a3dd971b05d7c50c7821c301acf4989db5ba357e9fce3b0216a30b55fd01d","title":"Create test-packages.txt with package definitions","description":"Define test packages in format 'type,name,version_command'. Include: wget, jq, nginx (formulae), firefox, rectangle (casks)","design":"## Goal\nCreate configuration file defining which packages to test in the integration suite.\n\n## Effort Estimate\n20-30 minutes\n\n## Success Criteria\n- [ ] File test/integration/config/test-packages.txt exists\n- [ ] File contains 5 package definitions (wget, jq, nginx, firefox, rectangle)\n- [ ] Each line follows format: type,name,version_command\n- [ ] File has comment header explaining format\n- [ ] File is valid (no blank lines, no trailing commas)\n- [ ] Can parse file with: \\`grep '^formula' test/integration/config/test-packages.txt\\`\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create package configuration file\n\n**Files:**\n- Create: `test/integration/config/test-packages.txt`\n\n**Step 1: Create test-packages.txt with complete content**\n\nFrom project root, create the file with this content:\n\n\\`\\`\\`\n# Test package definitions for offlinebrew integration tests\n# Format: type,name,version_command\n# Types: formula (CLI tools), cask (GUI applications)\n#\n# Package Selection Rationale:\n# - wget: Simple CLI tool, minimal dependencies, fast install\n# - jq: Has dependencies (oniguruma), tests dependency resolution  \n# - nginx: Complex with multiple dependencies, tests larger packages\n# - firefox: Large cask (~200MB), tests cask mirroring\n# - rectangle: Small cask, lightweight window manager\n\n# Formulae (CLI tools)\nformula,wget,wget --version\nformula,jq,jq --version\nformula,nginx,nginx -v\n\n# Casks (GUI applications)\ncask,firefox,/Applications/Firefox.app/Contents/MacOS/firefox --version\ncask,rectangle,defaults read /Applications/Rectangle.app/Contents/Info CFBundleShortVersionString\n\\`\\`\\`\n\nYou can create this file using your editor or with a cat heredoc command.\n\n**Expected output**: File created successfully\n\n**Step 2: Verify file exists and has correct content**\n\nRun:\n\\`\\`\\`bash\ncat test/integration/config/test-packages.txt\n\\`\\`\\`\n\nVerify all 5 package lines are present (3 formulae, 2 casks).\n\n**Step 3: Verify file can be parsed correctly**\n\nTest formula parsing:\n\\`\\`\\`bash\ngrep '^formula' test/integration/config/test-packages.txt\n\\`\\`\\`\n\n**Expected output**: 3 lines starting with \"formula,\"\n\nTest cask parsing:\n\\`\\`\\`bash\ngrep '^cask' test/integration/config/test-packages.txt\n\\`\\`\\`\n\n**Expected output**: 2 lines starting with \"cask,\"\n\n**Step 4: Verify file format is valid (no blank lines between package entries)**\n\nRun:\n\\`\\`\\`bash\ngrep -v '^#' test/integration/config/test-packages.txt | grep -v '^$' | wc -l\n\\`\\`\\`\n\n**Expected output**: \\`5\\` (exactly 5 package definitions)\n\n**Step 5: Count packages by type**\n\nCount formulae:\n\\`\\`\\`bash\ngrep -c '^formula' test/integration/config/test-packages.txt\n\\`\\`\\`\n\n**Expected output**: \\`3\\`\n\nCount casks:\n\\`\\`\\`bash\ngrep -c '^cask' test/integration/config/test-packages.txt\n\\`\\`\\`\n\n**Expected output**: \\`2\\`\n\n**Step 6: Commit the package configuration file**\n\n\\`\\`\\`bash\ngit add test/integration/config/test-packages.txt\ngit commit -m \"feat(offlinebrew-3d0.2): add test package configuration\n\nDefines 5 packages for Tart integration testing:\n- Formulae: wget, jq, nginx\n- Casks: firefox, rectangle\n\nPackage selection covers:\n- Simple CLI tools (wget)\n- Dependency resolution (jq -\u003e oniguruma)\n- Complex packages (nginx with many deps)\n- Large casks (firefox ~200MB)\n- Small casks (rectangle)\n\nFormat: type,name,version_command (CSV)\n\nRef: offlinebrew-3d0.2\"\n\\`\\`\\`\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **Rectangle version command**: Uses \\`defaults read\\` instead of \\`--version\\` because Rectangle.app doesn't have a CLI version flag\n- **nginx version command**: Uses \\`-v\\` (not \\`--version\\`) and writes to stderr (not stdout), but this is expected\n- **Firefox path**: Full path required because Firefox is not in PATH by default\n- **File format**: CSV-like with no spaces around commas for easy parsing with \\`cut\\` command\n- **Comments**: Lines starting with \\`#\\` will be ignored by parsing scripts\n\n## Key Considerations\n\n**Package Selection Rationale**:\n- wget: Simple CLI tool, minimal dependencies, fast install\n- jq: Has dependencies (oniguruma), tests dependency resolution\n- nginx: Complex with multiple dependencies, tests larger packages\n- firefox: Large cask (~200MB), tests cask mirroring\n- rectangle: Small cask, lightweight alternative to test\n\n**Version Command Variations**:\n- Some commands use --version, some use -v\n- Casks may not have version commands - use bundle info instead\n- Version commands must exit 0 and produce output\n\n**File Format Requirements**:\n- CSV-like format (comma-separated)\n- No spaces around commas\n- No empty lines (except comments starting with #)\n- Version commands can contain spaces\n\n## Edge Cases\n- **Missing Application**: Cask version commands fail if app not installed (expected in install phase)\n- **Command Not in PATH**: Formula version commands may fail if not in PATH after install\n- **Parse Errors**: Scripts must handle comments (lines starting with #)\n- **Special Characters**: Version commands may contain quotes or special chars - need careful parsing\n\n## Anti-patterns\n- ❌ Don't use packages that require licenses or registration (e.g., commercial software)\n- ❌ Don't use packages with long install times (\u003e5 min) - slows tests\n- ❌ Don't use deprecated or unmaintained packages\n- ❌ Don't hardcode /usr/local paths - use /Applications for casks","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:12.890088-05:00","updated_at":"2025-11-13T15:01:31.537408-05:00","closed_at":"2025-11-13T15:01:31.537408-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.2","depends_on_id":"offlinebrew-3d0.1","type":"blocks","created_at":"2025-11-13T13:27:12.890856-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.3","content_hash":"065bf7bb6e258433aef3be39876a0e53d2064315776ec7e7b2d9d79b3af4a3c2","title":"Create test-helpers.sh with shared utilities","description":"Implement logging functions (info, ok, warn, error), assertion helpers (assert_command_exists, assert_file_exists, assert_exit_code), and VM communication helpers (vm_exec, vm_copy)","design":"## Goal\nCreate shared utility library for test scripts with logging, assertions, and VM communication helpers.\n\n## Effort Estimate\n2-3 hours\n\n## Success Criteria\n- [ ] File test/integration/lib/test-helpers.sh exists and is executable\n- [ ] All 4 logging functions work (info, ok, warn, error)\n- [ ] All 3 assertion helpers work (assert_command_exists, assert_file_exists, assert_exit_code)\n- [ ] All 2 VM helpers work (vm_exec, vm_copy)\n- [ ] Sourcing file doesn't produce errors: `source test/integration/lib/test-helpers.sh \u0026\u0026 echo OK`\n- [ ] Manual test: calling `info \"test\"` produces colored output\n- [ ] Manual test: calling `assert_command_exists brew` returns 0 if brew exists\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create helper library file with logging functions\n\n**Files:**\n- Create: `test/integration/lib/test-helpers.sh`\n\n**Step 1: Create test-helpers.sh with shebang and color definitions**\n\nFrom project root, create the file with initial content including shebang, comments, and color codes.\n\nThe file should start with:\n- `#!/usr/bin/env bash` shebang\n- Header comments explaining purpose\n- `set -euo pipefail` for strict error handling\n- Color code definitions using ANSI-C quoting: `BLUE=$'\\033[0;34m'` etc.\n- Define: BLUE, GREEN, YELLOW, RED, NC (no color)\n\n**Expected output**: File created successfully\n\n**Step 2: Add logging functions to the file**\n\nAdd four logging functions:\n\n```bash\ninfo() {\n  echo -e \"${BLUE}[INFO]${NC} $*\"\n}\n\nok() {\n  echo -e \"${GREEN}[OK]${NC} $*\"\n}\n\nwarn() {\n  echo -e \"${YELLOW}[WARN]${NC} $*\"\n}\n\nerror() {\n  echo -e \"${RED}[ERROR]${NC} $*\" \u003e\u00262\n}\n```\n\nNote: error() writes to stderr (\u003e\u00262) for proper error handling.\n\n**Expected output**: Functions added to file\n\n**Step 3: Add assertion helper functions**\n\nAdd three assertion functions:\n\n```bash\nassert_command_exists() {\n  local cmd=\"$1\"\n  if command -v \"$cmd\" \u0026\u003e/dev/null; then\n    return 0\n  else\n    error \"Command not found: $cmd\"\n    return 1\n  fi\n}\n\nassert_file_exists() {\n  local file=\"$1\"\n  if [[ -f \"$file\" ]]; then\n    return 0\n  else\n    error \"File not found: $file\"\n    return 1\n  fi\n}\n\nassert_exit_code() {\n  local expected=\"$1\"\n  local actual=\"$2\"\n  if [[ \"$actual\" -eq \"$expected\" ]]; then\n    return 0\n  else\n    error \"Expected exit code $expected, got $actual\"\n    return 1\n  fi\n}\n```\n\n**Expected output**: Functions added to file\n\n**Step 4: Add VM communication helpers**\n\nAdd two VM helper functions:\n\n```bash\nvm_exec() {\n  local vm_name=\"${TART_VM_NAME:-offlinebrew-test}\"\n  tart run \"$vm_name\" -- bash -c \"$*\"\n}\n\nvm_copy() {\n  local vm_name=\"${TART_VM_NAME:-offlinebrew-test}\"\n  local src=\"$1\"\n  local dest=\"$2\"\n\n  warn \"vm_copy is not fully implemented\"\n  warn \"Tart uses --dir for mounting, not traditional copy\"\n  warn \"Use: tart run $vm_name --dir=name:$src\"\n  warn \"Then access at /Volumes/name in VM\"\n  return 1\n}\n```\n\nNote: vm_copy is a placeholder - Tart uses --dir mounting instead of traditional file copy.\n\n**Expected output**: Functions added to file\n\n**Step 5: Make file executable**\n\n```bash\nchmod +x test/integration/lib/test-helpers.sh\n```\n\n**Expected output**: None (silent success)\n\n**Step 6: Verify file permissions**\n\n```bash\nls -l test/integration/lib/test-helpers.sh\n```\n\n**Expected output**: Should show `-rwxr-xr-x` (executable bit set)\n\n### Step Group 2: Test the helper functions\n\n**Step 7: Test sourcing the file**\n\n```bash\nsource test/integration/lib/test-helpers.sh \u0026\u0026 echo \"OK: File sourced successfully\"\n```\n\n**Expected output**: `OK: File sourced successfully`\n\n**Step 8: Test logging functions**\n\n```bash\nsource test/integration/lib/test-helpers.sh\ninfo \"This is an info message\"\nok \"This is a success message\"\nwarn \"This is a warning message\"\nerror \"This is an error message\"\n```\n\n**Expected output**:\n- [INFO] This is an info message (in blue)\n- [OK] This is a success message (in green)\n- [WARN] This is a warning message (in yellow)\n- [ERROR] This is an error message (in red, to stderr)\n\n**Step 9: Test assertion helpers**\n\nTest assert_command_exists:\n\n```bash\nsource test/integration/lib/test-helpers.sh\nassert_command_exists bash \u0026\u0026 echo \"bash found\"\nassert_command_exists nonexistent_command || echo \"nonexistent_command not found (expected)\"\n```\n\n**Expected output**:\n- bash found\n- [ERROR] Command not found: nonexistent_command\n- nonexistent_command not found (expected)\n\nTest assert_file_exists:\n\n```bash\nsource test/integration/lib/test-helpers.sh\nassert_file_exists README.md \u0026\u0026 echo \"README.md found\"\nassert_file_exists nonexistent_file.txt || echo \"nonexistent_file.txt not found (expected)\"\n```\n\n**Expected output**:\n- README.md found\n- [ERROR] File not found: nonexistent_file.txt\n- nonexistent_file.txt not found (expected)\n\nTest assert_exit_code:\n\n```bash\nsource test/integration/lib/test-helpers.sh\ntrue\nassert_exit_code 0 $? \u0026\u0026 echo \"Exit code 0 matches (expected)\"\nfalse\nassert_exit_code 1 $? \u0026\u0026 echo \"Exit code 1 matches (expected)\"\n```\n\n**Expected output**:\n- Exit code 0 matches (expected)\n- Exit code 1 matches (expected)\n\n**Step 10: Test VM helper (will fail without VM - expected)**\n\n```bash\nsource test/integration/lib/test-helpers.sh\nvm_exec \"echo Hello from VM\" || echo \"VM not running (expected)\"\n```\n\n**Expected output**: Tart error about VM not found or not running, followed by \"VM not running (expected)\"\n\nNote: This is expected - VM hasn't been created yet. This helper will be tested properly in task 3d0.4.\n\n**Step 11: Commit the helper library**\n\n```bash\ngit add test/integration/lib/test-helpers.sh\ngit commit -m \"feat(offlinebrew-3d0.3): add shared test helper library\n\nCreates test-helpers.sh with utilities for Tart integration tests:\n\nLogging functions:\n- info() - blue informational messages\n- ok() - green success messages\n- warn() - yellow warnings\n- error() - red errors to stderr\n\nAssertion helpers:\n- assert_command_exists() - verify command in PATH\n- assert_file_exists() - verify file exists\n- assert_exit_code() - verify exit codes match\n\nVM communication:\n- vm_exec() - execute commands in Tart VM\n- vm_copy() - placeholder (Tart uses --dir mounting)\n\nFile is executable and safe to source in test scripts.\n\nRef: offlinebrew-3d0.3\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **ANSI-C quoting**: Color codes use `$'...'` syntax for proper bash interpretation\n- **Error output**: `error()` writes to stderr (\u003e\u00262) for proper error handling\n- **VM communication**: `vm_copy` is a placeholder - Tart uses `--dir` mounting instead\n- **Testing without VM**: VM helpers will fail until VM created (task 3d0.4)\n- **Sourcing**: File designed to be sourced, not executed directly\n- **set -euo pipefail**: Affects scripts that source this file (fail on errors, undefined vars)\n\n## Key Considerations\n\n**Color Output Detection**:\n- Colors should only be used when outputting to terminal (tty)\n- Should disable colors when output is piped or redirected\n- Can check with: `[[ -t 1 ]]` before using colors\n\n**VM Communication Approach**:\n- Tart doesn't have traditional SSH-based copy - uses shared directories\n- `tart run --dir` mounts host directory into VM\n- vm_exec is more useful than vm_copy for this use case\n- Scripts will mostly use vm_exec, not vm_copy\n\n**Error Handling in Assertions**:\n- Assertions return non-zero on failure\n- Assertions print helpful error messages\n- Calling scripts can use: `assert_file_exists foo.txt || exit 1`\n\n**Sourcing vs Executing**:\n- This file is meant to be sourced, not executed directly\n- set -euo pipefail affects scripts that source this file\n- Functions become available in calling script's scope\n\n## Edge Cases\n- **No Color Support**: Some terminals don't support ANSI colors - but acceptable for dev-only tests\n- **VM Not Running**: vm_exec will fail if VM not started - this is expected behavior\n- **Command Not in PATH**: assert_command_exists should work even with full paths\n- **Nested Quoting**: vm_exec with complex commands may need careful quoting\n\n## Anti-patterns\n- ❌ Don't use `echo` without -e flag - colors won't work\n- ❌ Don't write errors to stdout - use stderr (\u003e\u00262)\n- ❌ Don't assume VM name - use TART_VM_NAME variable\n- ❌ Don't implement complex retry logic - keep helpers simple\n- ❌ Don't silently fail - always return error codes and print messages","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:19.161543-05:00","updated_at":"2025-11-13T15:04:57.076169-05:00","closed_at":"2025-11-13T15:04:57.076169-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.3","depends_on_id":"offlinebrew-3d0.1","type":"blocks","created_at":"2025-11-13T13:27:19.162386-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.4","content_hash":"75b2e918d6ec14d5ae7dd968d643e5c9f31cce33d2b04ad0a5f1ef59bc5e0f3a","title":"Create setup-vm.sh phase script","description":"Check Tart installed, pull macOS Sonoma image, delete existing test VM, clone fresh VM, configure resources (4 CPU, 8GB RAM), start VM, wait for ready, verify accessible","design":"## Goal\nCreate script to set up a fresh Tart VM for testing, including pulling the base image, creating/starting the VM, and waiting for it to be ready.\n\n## Effort Estimate\n3-4 hours (including testing and troubleshooting)\n\n## Success Criteria\n- [ ] File test/integration/phases/setup-vm.sh exists and is executable\n- [ ] Script checks for Tart CLI and fails gracefully if missing\n- [ ] Script successfully pulls macOS Sonoma base image (or skips if cached)\n- [ ] Script deletes any existing offlinebrew-test VM\n- [ ] Script creates fresh VM clone with 4 CPU, 8GB RAM\n- [ ] Script starts VM successfully\n- [ ] Script waits for VM to be accessible (max 2 minutes)\n- [ ] Script exits 0 on success, 1 on failure\n- [ ] Running twice in a row works (idempotent)\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create script with header and configuration\n\n**Files:**\n- Create: `test/integration/phases/setup-vm.sh`\n\n**Step 1: Create setup-vm.sh with shebang and initial configuration**\n\nFrom project root, create the script:\n\n```bash\ncat \u003e test/integration/phases/setup-vm.sh \u003c\u003c 'EOF'\n#!/usr/bin/env bash\n#\n# setup-vm.sh - Set up fresh Tart VM for testing\n#\n# Creates a new macOS VM using Tart, configures resources, and waits for ready state.\n\nset -euo pipefail\n\n# Get directory of this script\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" \u0026\u0026 pwd)\"\n\n# Source test helpers\nsource \"$SCRIPT_DIR/../lib/test-helpers.sh\"\n\n# VM Configuration\nVM_NAME=\"offlinebrew-test\"\nBASE_IMAGE=\"ghcr.io/cirruslabs/macos-sonoma-vanilla:latest\"\nVM_CPUS=4\nVM_MEMORY=8192  # MB\n\nEOF\n```\n\n**Expected output**: File created\n\n**Step 2: Add Tart installation check**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/setup-vm.sh \u003c\u003c 'EOF'\n# Check if Tart is installed\ninfo \"Checking for Tart CLI...\"\nif ! command -v tart \u0026\u003e/dev/null; then\n  error \"Tart CLI not found\"\n  error \"Install from: https://github.com/cirruslabs/tart\"\n  error \"  brew install tart\"\n  exit 1\nfi\nok \"Tart CLI found: $(tart --version 2\u003e\u00261 | head -1)\"\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 2: Pull base image\n\n**Step 3: Add base image pull logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/setup-vm.sh \u003c\u003c 'EOF'\n# Pull base image (will be cached if already downloaded)\ninfo \"Pulling base image: $BASE_IMAGE\"\ninfo \"Note: First pull downloads ~20-40GB, subsequent pulls use cache\"\n\nif tart pull \"$BASE_IMAGE\"; then\n  ok \"Base image ready\"\nelse\n  error \"Failed to pull base image\"\n  error \"Check network connection and disk space (~50GB needed)\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 3: Delete existing VM\n\n**Step 4: Add VM deletion logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/setup-vm.sh \u003c\u003c 'EOF'\n# Delete existing VM if present\nif tart list 2\u003e/dev/null | grep -q \"^$VM_NAME\"; then\n  warn \"Existing VM found: $VM_NAME\"\n  info \"Deleting existing VM to start fresh...\"\n  if tart delete \"$VM_NAME\"; then\n    ok \"Existing VM deleted\"\n  else\n    warn \"Failed to delete existing VM (will try to continue)\"\n  fi\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 4: Clone and configure VM\n\n**Step 5: Add VM clone logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/setup-vm.sh \u003c\u003c 'EOF'\n# Clone fresh VM from base image\ninfo \"Cloning VM: $VM_NAME from $BASE_IMAGE\"\nif tart clone \"$BASE_IMAGE\" \"$VM_NAME\"; then\n  ok \"VM cloned successfully\"\nelse\n  error \"Failed to clone VM\"\n  error \"Check disk space (need ~30GB for VM)\"\n  exit 1\nfi\n\n# Configure VM resources\ninfo \"Configuring VM: $VM_CPUS CPU, $VM_MEMORY MB RAM\"\nif tart set \"$VM_NAME\" --cpu \"$VM_CPUS\" --memory \"$VM_MEMORY\"; then\n  ok \"VM resources configured\"\nelse\n  error \"Failed to configure VM resources\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 5: Start VM and wait for ready\n\n**Step 6: Add VM startup logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/setup-vm.sh \u003c\u003c 'EOF'\n# Start VM in background\ninfo \"Starting VM: $VM_NAME (this may take 1-2 minutes)\"\ntart run \"$VM_NAME\" --no-graphics \u0026\nVM_PID=$!\ninfo \"VM process started (PID: $VM_PID)\"\n\n# Give VM initial time to boot\nsleep 10\n\n# Wait for VM to be running (poll up to 120 seconds)\ninfo \"Waiting for VM to be ready...\"\nmax_wait=120\nelapsed=0\nwhile [[ $elapsed -lt $max_wait ]]; do\n  if tart list 2\u003e/dev/null | grep -q \"$VM_NAME.*running\"; then\n    ok \"VM is running\"\n    break\n  fi\n\n  # Still waiting\n  info \"  Waiting for VM... ($elapsed/$max_wait seconds)\"\n  sleep 5\n  elapsed=$((elapsed + 5))\ndone\n\n# Check if VM started successfully\nif [[ $elapsed -ge $max_wait ]]; then\n  error \"VM failed to start within $max_wait seconds\"\n  error \"Check VM logs with: tart run $VM_NAME\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 6: Final verification\n\n**Step 7: Add final verification and completion**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/setup-vm.sh \u003c\u003c 'EOF'\n# Final verification\ninfo \"Verifying VM status...\"\nif tart list | grep \"$VM_NAME.*running\"; then\n  ok \"VM setup complete: $VM_NAME\"\n  ok \"VM is running and ready for testing\"\n  exit 0\nelse\n  error \"VM not found in running state after setup\"\n  error \"VM status:\"\n  tart list | grep \"$VM_NAME\" || echo \"  VM not found\"\n  exit 1\nfi\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 8: Make script executable**\n\n```bash\nchmod +x test/integration/phases/setup-vm.sh\n```\n\n**Expected output**: None (silent success)\n\n**Step 9: Verify script permissions and content**\n\n```bash\nls -l test/integration/phases/setup-vm.sh\n```\n\n**Expected output**: Should show `-rwxr-xr-x` (executable bit set)\n\nVerify script content:\n\n```bash\nhead -20 test/integration/phases/setup-vm.sh\n```\n\n**Expected output**: Should show shebang, comments, and configuration variables\n\n### Step Group 7: Test the script (basic validation)\n\n**Step 10: Test script syntax**\n\n```bash\nbash -n test/integration/phases/setup-vm.sh\n```\n\n**Expected output**: None (silent success means no syntax errors)\n\n**Step 11: Test help/version output**\n\n```bash\nhead -10 test/integration/phases/setup-vm.sh | grep -E \"setup-vm.sh|Set up fresh\"\n```\n\n**Expected output**: Should show script description\n\n**Note**: Full end-to-end testing of this script requires Tart installed and will be done in task 3d0.12 (validation).\n\n**Step 12: Commit the setup script**\n\n```bash\ngit add test/integration/phases/setup-vm.sh\ngit commit -m \"feat(offlinebrew-3d0.4): add Tart VM setup script\n\nCreates setup-vm.sh phase script that:\n- Checks Tart CLI is installed\n- Pulls macOS Sonoma base image (ghcr.io/cirruslabs/macos-sonoma-vanilla)\n- Deletes existing offlinebrew-test VM if present\n- Clones fresh VM from base image\n- Configures VM with 4 CPU, 8GB RAM\n- Starts VM in background with --no-graphics\n- Waits for VM to reach running state (max 2 minutes)\n- Verifies VM is accessible\n\nScript is idempotent - can run multiple times safely.\nSources test-helpers.sh for logging and error handling.\n\nRef: offlinebrew-3d0.4\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **First run**: Image pull takes 10-30 minutes depending on network (20-40GB download)\n- **Subsequent runs**: Use cached image, much faster\n- **VM startup**: Takes 30-90 seconds after clone\n- **Background process**: VM continues running after script exits\n- **Cleanup**: VM can be deleted with `tart delete offlinebrew-test`\n- **Idempotent**: Deletes existing VM before creating new one\n\n## Key Considerations\n\n**Tart Image Cache**:\n- First pull downloads ~20-40GB (macOS Sonoma image)\n- Subsequent pulls are fast if image cached\n- Image stored in ~/.tart/vms/cache/\n\n**VM Startup Time**:\n- Fresh VM boot takes 30-90 seconds\n- Need to poll for \"running\" status, not just \"exists\"\n- VM may show as existing but not yet running\n\n**Resource Configuration**:\n- 4 CPU, 8GB RAM is moderate - enough for Homebrew + compilation\n- Can be overridden with environment variables if needed\n- macOS requires minimum 2 CPU, 4GB RAM\n\n**Background Process Management**:\n- tart run blocks, so need to run in background with \u0026\n- Store PID if we need to kill later\n- VM continues running after script exits\n\n## Edge Cases\n- **Tart Not Installed**: Fail gracefully with helpful error message and install URL\n- **Network Failure During Pull**: tart pull may fail - return non-zero to fail test\n- **Existing VM Won't Delete**: Use || true to continue even if delete fails\n- **VM Fails to Start**: Timeout after 2 minutes and exit with error\n- **Disk Space Full**: VM clone may fail if insufficient disk space (~50GB needed)\n- **Second Run**: Delete existing VM first, so running twice works\n\n## Anti-patterns\n- ❌ Don't assume Tart is installed - always check first\n- ❌ Don't hardcode paths to Tart - use PATH lookup\n- ❌ Don't skip VM deletion step - must start fresh each time\n- ❌ Don't use fixed sleep times without polling - VM startup is variable\n- ❌ Don't forget --no-graphics flag - we don't need GUI for testing\n- ❌ Don't exit immediately after starting VM - wait for ready state","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:25.929374-05:00","updated_at":"2025-11-13T15:07:01.940918-05:00","closed_at":"2025-11-13T15:07:01.940918-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.4","depends_on_id":"offlinebrew-3d0.3","type":"blocks","created_at":"2025-11-13T13:27:25.929952-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.5","content_hash":"d8756cef1876a7e05f9ff23a99a078965c7cf3fb575e70ba38503cfed8bcbcb4","title":"Create install-homebrew.sh phase script","description":"Execute Homebrew install script in VM non-interactively, verify brew command exists, check version, add to PATH if needed","design":"## Goal\nInstall Homebrew in the Tart VM non-interactively and verify it works.\n\n## Effort Estimate\n1-2 hours\n\n## Success Criteria\n- [ ] File test/integration/phases/install-homebrew.sh exists and is executable\n- [ ] Script executes Homebrew install script in VM\n- [ ] Homebrew installs without user interaction (NONINTERACTIVE=1)\n- [ ] `brew --version` command works in VM after install\n- [ ] brew is added to PATH\n- [ ] Script exits 0 on success, 1 on failure\n- [ ] Install completes in \u003c5 minutes\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create install script\n\n**Files:**\n- Create: `test/integration/phases/install-homebrew.sh`\n\n**Step 1: Create install-homebrew.sh with configuration**\n\nFrom project root, create the script:\n\n```bash\ncat \u003e test/integration/phases/install-homebrew.sh \u003c\u003c 'EOF'\n#!/usr/bin/env bash\n#\n# install-homebrew.sh - Install Homebrew in Tart VM\n#\n# Installs Homebrew non-interactively and configures PATH.\n\nset -euo pipefail\n\n# Get directory of this script\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" \u0026\u0026 pwd)\"\n\n# Source test helpers\nsource \"$SCRIPT_DIR/../lib/test-helpers.sh\"\n\n# Configuration\nVM_NAME=\"${TART_VM_NAME:-offlinebrew-test}\"\nHOMEBREW_INSTALL_URL=\"https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh\"\n\nEOF\n```\n\n**Expected output**: File created\n\n### Step Group 2: Install Homebrew in VM\n\n**Step 2: Add Homebrew installation logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/install-homebrew.sh \u003c\u003c 'EOF'\n# Install Homebrew using official install script\ninfo \"Installing Homebrew in VM (this may take 2-5 minutes)...\"\ninfo \"Install URL: $HOMEBREW_INSTALL_URL\"\n\nif vm_exec \"NONINTERACTIVE=1 /bin/bash -c \\\"\\$(curl -fsSL $HOMEBREW_INSTALL_URL)\\\"\"; then\n  ok \"Homebrew installation completed\"\nelse\n  error \"Homebrew installation failed\"\n  error \"Check network connection and VM logs\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 3: Configure PATH\n\n**Step 3: Add PATH configuration**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/install-homebrew.sh \u003c\u003c 'EOF'\n# Configure Homebrew PATH\ninfo \"Configuring Homebrew PATH...\"\n\n# Add shellenv to .zprofile for persistence\nvm_exec 'echo '\"'\"'eval \"$(/opt/homebrew/bin/brew shellenv)\"'\"'\"' \u003e\u003e ~/.zprofile' || {\n  error \"Failed to add Homebrew to PATH\"\n  exit 1\n}\n\nok \"Homebrew PATH configured\"\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 4: Verify installation\n\n**Step 4: Add verification logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/install-homebrew.sh \u003c\u003c 'EOF'\n# Verify Homebrew works\ninfo \"Verifying Homebrew installation...\"\n\n# Get Homebrew version\nbrew_version=$(vm_exec 'eval \"$(/opt/homebrew/bin/brew shellenv)\" \u0026\u0026 brew --version | head -1' 2\u003e/dev/null)\n\nif [[ -z \"$brew_version\" ]]; then\n  error \"Failed to get Homebrew version\"\n  error \"Homebrew may not be installed correctly\"\n  exit 1\nfi\n\nok \"Homebrew installed successfully: $brew_version\"\n\n# Verify brew command works\nif vm_exec 'eval \"$(/opt/homebrew/bin/brew shellenv)\" \u0026\u0026 command -v brew' \u003e/dev/null 2\u003e\u00261; then\n  ok \"brew command is available in PATH\"\nelse\n  error \"brew command not found in PATH\"\n  exit 1\nfi\n\ninfo \"Homebrew installation complete and verified\"\nexit 0\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 5: Make script executable**\n\n```bash\nchmod +x test/integration/phases/install-homebrew.sh\n```\n\n**Expected output**: None (silent success)\n\n**Step 6: Verify script syntax**\n\n```bash\nbash -n test/integration/phases/install-homebrew.sh\n```\n\n**Expected output**: None (silent success = no syntax errors)\n\n**Step 7: Commit the install script**\n\n```bash\ngit add test/integration/phases/install-homebrew.sh\ngit commit -m \"feat(offlinebrew-3d0.5): add Homebrew installation script\n\nCreates install-homebrew.sh phase script that:\n- Installs Homebrew in VM using official install script\n- Uses NONINTERACTIVE=1 to skip all prompts\n- Installs to /opt/homebrew (Apple Silicon) or /usr/local (Intel)\n- Adds shellenv to .zprofile for PATH persistence\n- Verifies brew command works after install\n- Checks brew --version output\n\nInstall takes 2-5 minutes depending on network speed.\nSources test-helpers.sh for logging and VM communication.\n\nRef: offlinebrew-3d0.5\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **NONINTERACTIVE=1**: Skips all prompts - required for automated testing\n- **PATH persistence**: shellenv added to .zprofile so brew is available in all future commands\n- **VM context**: Each vm_exec runs fresh shell - must eval shellenv in each command\n- **Install time**: 2-5 minutes for fresh install (downloads from GitHub)\n- **Full path**: /opt/homebrew/bin/brew used before shellenv is sourced\n\n## Key Considerations\n\n**Non-Interactive Install**:\n- NONINTERACTIVE=1 environment variable skips all prompts\n- Installs to /opt/homebrew on Apple Silicon\n- Installs to /usr/local on Intel Macs\n- No sudo password prompt in fresh VM (user has sudo)\n\n**PATH Configuration**:\n- Homebrew not in PATH by default\n- Need to run shellenv to set up PATH\n- Add to .zprofile so it persists across commands\n- Use eval to set variables in current shell\n\n**VM Execution Context**:\n- Each vm_exec runs in fresh shell - variables don't persist\n- Need to source .zprofile in each command or use full paths\n- Can use: `eval $(/opt/homebrew/bin/brew shellenv) \u0026\u0026 brew ...`\n\n**Install Time**:\n- Fresh install takes 2-5 minutes\n- Downloads Homebrew from GitHub\n- Clones homebrew-core tap\n- Runs post-install scripts\n\n## Edge Cases\n- **Network Failure**: curl or git may fail during install - fail immediately\n- **Disk Space**: Homebrew needs ~2GB - should have enough in VM\n- **Architecture Detection**: Install script auto-detects Apple Silicon vs Intel\n- **Existing Homebrew**: Fresh VM won't have Homebrew, but script should handle it\n- **PATH Issues**: Later commands must include shellenv or use full path\n\n## Anti-patterns\n- ❌ Don't assume Homebrew location - use shellenv to detect\n- ❌ Don't skip verification step - must confirm brew command works\n- ❌ Don't forget NONINTERACTIVE=1 - install will hang waiting for input\n- ❌ Don't use interactive shell features - vm_exec is non-interactive\n- ❌ Don't assume PATH persists between vm_exec calls","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:36.013442-05:00","updated_at":"2025-11-13T15:08:00.470854-05:00","closed_at":"2025-11-13T15:08:00.470854-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.5","depends_on_id":"offlinebrew-3d0.4","type":"blocks","created_at":"2025-11-13T13:27:36.014038-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.6","content_hash":"36d69733e2a8a5419b54a35282006fe2514d9bf3a5edfa9f6de4e361cde3a772","title":"Create install-offlinebrew.sh phase script","description":"Copy local offlinebrew code to VM using tart run --dir, verify code copied, add bin to PATH, verify brew offline command works","design":"## Goal\nCopy local offlinebrew code to the VM and install it so `brew offline` command works.\n\n## Effort Estimate\n1-2 hours\n\n## Success Criteria\n- [ ] File test/integration/phases/install-offlinebrew.sh exists and is executable\n- [ ] Local offlinebrew code is copied to VM at /tmp/offlinebrew\n- [ ] offlinebrew/bin is added to PATH in VM\n- [ ] `brew offline --help` command works in VM\n- [ ] Script exits 0 on success, 1 on failure\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create installation script\n\n**Files:**\n- Create: `test/integration/phases/install-offlinebrew.sh`\n\n**Step 1: Create install-offlinebrew.sh with configuration**\n\nFrom project root, create the script:\n\n```bash\ncat \u003e test/integration/phases/install-offlinebrew.sh \u003c\u003c 'EOF'\n#!/usr/bin/env bash\n#\n# install-offlinebrew.sh - Install offlinebrew in Tart VM\n#\n# Copies local offlinebrew code to VM and configures PATH.\n\nset -euo pipefail\n\n# Get directory of this script and project root\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" \u0026\u0026 pwd)\"\nPROJECT_ROOT=\"$(cd \"$SCRIPT_DIR/../../..\" \u0026\u0026 pwd)\"\n\n# Source test helpers\nsource \"$SCRIPT_DIR/../lib/test-helpers.sh\"\n\n# Configuration\nVM_NAME=\"${TART_VM_NAME:-offlinebrew-test}\"\nOFFLINE_BREW_DIR=\"/tmp/offlinebrew\"\n\nEOF\n```\n\n**Expected output**: File created\n\n### Step Group 2: Copy offlinebrew code to VM\n\n**Step 2: Add code copy logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/install-offlinebrew.sh \u003c\u003c 'EOF'\n# Copy offlinebrew code to VM\ninfo \"Copying offlinebrew code to VM...\"\ninfo \"Project root: $PROJECT_ROOT\"\ninfo \"Destination in VM: $OFFLINE_BREW_DIR\"\n\n# Create destination directory in VM\nvm_exec \"mkdir -p $OFFLINE_BREW_DIR\" || {\n  error \"Failed to create directory in VM\"\n  exit 1\n}\n\n# Mount project root and copy to VM\n# Use tart run --dir to mount host directory as read-only\n# Then copy to writable location in VM\ninfo \"Mounting and copying files (this may take a moment)...\"\nif tart run \"$VM_NAME\" --dir=offlinebrew:\"$PROJECT_ROOT\" -- \\\n  bash -c \"cp -r /Volumes/offlinebrew/* $OFFLINE_BREW_DIR/\"; then\n  ok \"Code copied to VM successfully\"\nelse\n  error \"Failed to copy code to VM\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 3: Configure PATH\n\n**Step 3: Add PATH configuration**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/install-offlinebrew.sh \u003c\u003c 'EOF'\n# Add offlinebrew/bin to PATH\ninfo \"Configuring offlinebrew PATH...\"\n\n# Add to .zprofile for persistence\nvm_exec \"echo 'export PATH=\\\"$OFFLINE_BREW_DIR/bin:\\$PATH\\\"' \u003e\u003e ~/.zprofile\" || {\n  error \"Failed to add offlinebrew to PATH\"\n  exit 1\n}\n\nok \"offlinebrew PATH configured\"\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 4: Verify installation\n\n**Step 4: Add verification logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/install-offlinebrew.sh \u003c\u003c 'EOF'\n# Verify brew offline command works\ninfo \"Verifying offlinebrew installation...\"\n\n# Test brew offline command (needs Homebrew shellenv)\nif vm_exec 'eval \"$(/opt/homebrew/bin/brew shellenv)\" \u0026\u0026 brew offline --help' | grep -q \"brew offline\"; then\n  ok \"brew offline command works\"\nelse\n  error \"brew offline command not working\"\n  error \"Check that offlinebrew is in PATH and Homebrew is available\"\n  exit 1\nfi\n\n# Verify bin directory exists\nif vm_exec \"test -d $OFFLINE_BREW_DIR/bin\"; then\n  ok \"offlinebrew bin directory confirmed\"\nelse\n  error \"offlinebrew bin directory not found\"\n  exit 1\nfi\n\ninfo \"offlinebrew installation complete and verified\"\nexit 0\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 5: Make script executable**\n\n```bash\nchmod +x test/integration/phases/install-offlinebrew.sh\n```\n\n**Expected output**: None (silent success)\n\n**Step 6: Verify script syntax**\n\n```bash\nbash -n test/integration/phases/install-offlinebrew.sh\n```\n\n**Expected output**: None (silent success = no syntax errors)\n\n**Step 7: Commit the installation script**\n\n```bash\ngit add test/integration/phases/install-offlinebrew.sh\ngit commit -m \"feat(offlinebrew-3d0.6): add offlinebrew installation script\n\nCreates install-offlinebrew.sh phase script that:\n- Copies local offlinebrew code to VM at /tmp/offlinebrew\n- Uses tart run --dir to mount project directory\n- Copies from read-only mount to writable location\n- Adds offlinebrew/bin to PATH in .zprofile\n- Verifies brew offline command works\n- Requires Homebrew shellenv for brew offline to work\n\nSources test-helpers.sh for logging and VM communication.\n\nRef: offlinebrew-3d0.6\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **Read-only mount**: tart --dir mounts as read-only, must copy to writable location\n- **Path calculation**: Uses relative path from script location to find project root\n- **PATH order**: offlinebrew/bin added before Homebrew in PATH\n- **Shellenv required**: brew offline needs HOMEBREW_PREFIX and other vars from shellenv\n- **Copy time**: Usually fast, but may take longer if project has large .git directory\n\n## Key Considerations\n\n**Tart Directory Mounting**:\n- `tart run --dir=name:host_path` mounts host directory into VM\n- Mounted at /Volumes/name in VM\n- Read-only mount - need to copy to writable location\n- Multiple --dir flags can be used\n\n**Code Location in VM**:\n- Copy to /tmp/offlinebrew for simplicity\n- /tmp is writable and cleaned on reboot\n- Could use /usr/local or ~/offlinebrew but /tmp is simpler for tests\n\n**PATH Configuration**:\n- Add offlinebrew/bin before Homebrew in PATH\n- Ensures brew offline command found\n- Must reload .zprofile or use full path\n\n**Shellenv Requirement**:\n- brew offline is a Homebrew external command\n- Requires Homebrew environment (HOMEBREW_PREFIX etc)\n- Must eval shellenv before running brew offline\n\n## Edge Cases\n- **Large Codebase**: Copy may take time if project has large files (.git etc)\n- **Permission Issues**: /tmp should be writable by default in macOS VM\n- **PATH Not Persisting**: Each vm_exec needs to source .zprofile\n- **Relative Paths**: Use absolute path to project root\n\n## Anti-patterns\n- ❌ Don't forget to copy code - can't just mount (mount is read-only)\n- ❌ Don't assume current directory - calculate PROJECT_ROOT properly\n- ❌ Don't skip PATH configuration - brew won't find external command\n- ❌ Don't forget to source shellenv - brew offline needs Homebrew context","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:36.548644-05:00","updated_at":"2025-11-13T15:08:54.278065-05:00","closed_at":"2025-11-13T15:08:54.278065-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.6","depends_on_id":"offlinebrew-3d0.5","type":"blocks","created_at":"2025-11-13T13:27:36.54926-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.7","content_hash":"9f2dc99aba9ecedf00baf1d4fa4a185d47717bc491adc77d26667d8eab65f56e","title":"Create create-mirror.sh phase script","description":"Read package list, create mirror directory, execute brew offline mirror command with test packages, verify config.json and urlmap.json, log mirror size","design":"## Goal\nCreate mirror of test packages using brew offline mirror command in VM, verify mirror structure.\n\n## Effort Estimate\n2-3 hours\n\n## Success Criteria\n- [ ] File test/integration/phases/create-mirror.sh exists and is executable\n- [ ] Script reads package list from config/test-packages.txt\n- [ ] Script creates mirror at /tmp/brew_mirror in VM\n- [ ] Mirror contains config.json with tap information\n- [ ] Mirror contains urlmap.json with URL-to-file mappings\n- [ ] Mirror contains packages/ directory with downloaded files\n- [ ] All 5 packages successfully mirrored\n- [ ] Script logs mirror size\n- [ ] Script exits 0 on success, 1 on any failure\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create script with configuration\n\n**Files:**\n- Create: `test/integration/phases/create-mirror.sh`\n\n**Step 1: Create create-mirror.sh with header and configuration**\n\nFrom project root, create the script:\n\n```bash\ncat \u003e test/integration/phases/create-mirror.sh \u003c\u003c 'EOF'\n#!/usr/bin/env bash\n#\n# create-mirror.sh - Create offlinebrew mirror of test packages\n#\n# Reads test-packages.txt, creates mirror with brew offline mirror command.\n\nset -euo pipefail\n\n# Get directory of this script and project root\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" \u0026\u0026 pwd)\"\nPROJECT_ROOT=\"$(cd \"$SCRIPT_DIR/../../..\" \u0026\u0026 pwd)\"\n\n# Source test helpers\nsource \"$SCRIPT_DIR/../lib/test-helpers.sh\"\n\n# Configuration\nVM_NAME=\"${TART_VM_NAME:-offlinebrew-test}\"\nMIRROR_DIR=\"/tmp/brew_mirror\"\nTEST_CONFIG_DIR=\"/tmp/test-config\"\nPACKAGES_FILE=\"$PROJECT_ROOT/test/integration/config/test-packages.txt\"\n\nEOF\n```\n\n**Expected output**: File created\n\n### Step Group 2: Copy config file to VM\n\n**Step 2: Add config file copy logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/create-mirror.sh \u003c\u003c 'EOF'\n# Verify packages file exists on host\nif [[ ! -f \"$PACKAGES_FILE\" ]]; then\n  error \"Package file not found: $PACKAGES_FILE\"\n  exit 1\nfi\n\ninfo \"Copying test-packages.txt to VM...\"\ninfo \"Source: $PACKAGES_FILE\"\n\n# Create config directory in VM\nvm_exec \"mkdir -p $TEST_CONFIG_DIR\" || {\n  error \"Failed to create config directory in VM\"\n  exit 1\n}\n\n# Copy config file using tart --dir mounting\nif tart run \"$VM_NAME\" --dir=testconfig:\"$PROJECT_ROOT/test/integration/config\" -- \\\n  bash -c \"cp /Volumes/testconfig/test-packages.txt $TEST_CONFIG_DIR/\"; then\n  ok \"Config file copied to VM\"\nelse\n  error \"Failed to copy config file to VM\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 3: Parse package lists\n\n**Step 3: Add package list parsing**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/create-mirror.sh \u003c\u003c 'EOF'\n# Parse formulae from config file\ninfo \"Parsing package lists...\"\n\nformulae=$(vm_exec \"grep '^formula,' $TEST_CONFIG_DIR/test-packages.txt | cut -d, -f2 | tr '\\n' ','\")\nformulae=${formulae%,}  # Remove trailing comma\n\nif [[ -z \"$formulae\" ]]; then\n  warn \"No formulae found in config file\"\nelse\n  info \"Formulae to mirror: $formulae\"\nfi\n\n# Parse casks from config file\ncasks=$(vm_exec \"grep '^cask,' $TEST_CONFIG_DIR/test-packages.txt | cut -d, -f2 | tr '\\n' ','\")\ncasks=${casks%,}  # Remove trailing comma\n\nif [[ -z \"$casks\" ]]; then\n  warn \"No casks found in config file\"\nelse\n  info \"Casks to mirror: $casks\"\nfi\n\n# Verify at least one package type specified\nif [[ -z \"$formulae\" \u0026\u0026 -z \"$casks\" ]]; then\n  error \"No packages found in config file\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 4: Create mirror\n\n**Step 4: Add mirror creation logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/create-mirror.sh \u003c\u003c 'EOF'\n# Create mirror directory in VM\ninfo \"Creating mirror directory...\"\nvm_exec \"mkdir -p $MIRROR_DIR\" || {\n  error \"Failed to create mirror directory\"\n  exit 1\n}\nok \"Mirror directory created: $MIRROR_DIR\"\n\n# Build brew offline mirror command\ninfo \"Creating mirror with dependencies (this may take 5-10 minutes)...\"\nmirror_cmd=\"eval \\$(/opt/homebrew/bin/brew shellenv) \u0026\u0026 brew offline mirror -d $MIRROR_DIR\"\n\n# Add formulae if present\nif [[ -n \"$formulae\" ]]; then\n  mirror_cmd=\"$mirror_cmd -f $formulae\"\nfi\n\n# Add casks if present\nif [[ -n \"$casks\" ]]; then\n  mirror_cmd=\"$mirror_cmd --casks $casks\"\nfi\n\n# Add --with-deps flag to include dependencies\nmirror_cmd=\"$mirror_cmd --with-deps\"\n\ninfo \"Mirror command: brew offline mirror -d $MIRROR_DIR -f ... --casks ... --with-deps\"\n\n# Execute mirror command\nif vm_exec \"$mirror_cmd\"; then\n  ok \"Mirror creation completed\"\nelse\n  error \"Mirror creation failed\"\n  error \"Check network connection and package names\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 5: Verify mirror structure\n\n**Step 5: Add mirror verification**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/create-mirror.sh \u003c\u003c 'EOF'\n# Verify mirror files exist\ninfo \"Verifying mirror structure...\"\n\n# Check config.json\nif vm_exec \"test -f $MIRROR_DIR/config.json\"; then\n  ok \"config.json found\"\nelse\n  error \"config.json not found in mirror\"\n  exit 1\nfi\n\n# Check urlmap.json\nif vm_exec \"test -f $MIRROR_DIR/urlmap.json\"; then\n  ok \"urlmap.json found\"\nelse\n  error \"urlmap.json not found in mirror\"\n  exit 1\nfi\n\n# Check packages directory\nif vm_exec \"test -d $MIRROR_DIR/packages\"; then\n  ok \"packages directory found\"\nelse\n  error \"packages directory not found in mirror\"\n  exit 1\nfi\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 6: Log mirror statistics\n\n**Step 6: Add statistics logging and completion**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/create-mirror.sh \u003c\u003c 'EOF'\n# Log mirror statistics\ninfo \"Gathering mirror statistics...\"\n\nmirror_size=$(vm_exec \"du -sh $MIRROR_DIR 2\u003e/dev/null | cut -f1\" || echo \"unknown\")\npackage_count=$(vm_exec \"ls $MIRROR_DIR/packages 2\u003e/dev/null | wc -l | tr -d ' '\" || echo \"0\")\n\nok \"Mirror created successfully\"\nok \"  Location: $MIRROR_DIR\"\nok \"  Size: $mirror_size\"\nok \"  Files: $package_count\"\n\n# Show config.json tap information\ninfo \"Mirror tap information:\"\nvm_exec \"cat $MIRROR_DIR/config.json 2\u003e/dev/null | head -20\" || warn \"Could not read config.json\"\n\ninfo \"Mirror creation complete and verified\"\nexit 0\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 7: Make script executable**\n\n```bash\nchmod +x test/integration/phases/create-mirror.sh\n```\n\n**Expected output**: None (silent success)\n\n**Step 8: Verify script syntax**\n\n```bash\nbash -n test/integration/phases/create-mirror.sh\n```\n\n**Expected output**: None (silent success = no syntax errors)\n\n**Step 9: Commit the mirror creation script**\n\n```bash\ngit add test/integration/phases/create-mirror.sh\ngit commit -m \"feat(offlinebrew-3d0.7): add mirror creation script\n\nCreates create-mirror.sh phase script that:\n- Copies test-packages.txt to VM using tart --dir\n- Parses formulae and casks from CSV config file\n- Creates mirror at /tmp/brew_mirror using brew offline mirror\n- Includes --with-deps flag to mirror all dependencies\n- Verifies mirror structure (config.json, urlmap.json, packages/)\n- Logs mirror size and file count\n\nMirror includes 5 test packages with dependencies:\n- Formulae: wget, jq, nginx\n- Casks: firefox, rectangle\n\nMirror creation takes 5-10 minutes depending on network speed.\nSources test-helpers.sh for logging and VM communication.\n\nRef: offlinebrew-3d0.7\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **Mirror time**: 5-10 minutes depending on network speed and package sizes\n- **Dependencies**: --with-deps includes all runtime dependencies automatically\n- **Cask sizes**: firefox alone is ~200MB, total mirror may be 1-2GB\n- **Config parsing**: Uses grep + cut + tr to extract package names from CSV\n- **tart --dir mounting**: Mounts config directory as read-only at /Volumes/testconfig\n- **Command building**: Conditionally adds -f and --casks based on what's in config file\n\n## Key Considerations\n\n**Mirror Creation Time**:\n- Downloading all packages may take 5-10 minutes\n- Network speed affects duration significantly\n- Large casks (firefox ~200MB) take longer\n- Dependencies multiply download time (nginx has many deps)\n\n**Dependency Resolution**:\n- --with-deps flag includes all runtime dependencies\n- jq depends on oniguruma\n- nginx has many dependencies (pcre2, openssl, etc)\n- Dependencies significantly increase mirror size (can be 10x larger)\n\n**Cask Mirroring**:\n- Casks are large binary files (100-500MB each)\n- firefox alone is ~200MB\n- rectangle is ~5MB\n- May hit Homebrew API rate limits if running too frequently\n- Requires homebrew/homebrew-cask tap to be available\n\n**Config File Parsing**:\n- Must handle comment lines (start with #) - grep '^formula,' excludes them\n- CSV format parsing with cut to get 2nd column\n- tr converts newlines to commas for command-line\n- Must remove trailing comma with parameter expansion\n\n**Command Building**:\n- Conditionally add -f flag only if formulae found\n- Conditionally add --casks flag only if casks found\n- Always add --with-deps flag to test dependency resolution\n- Use eval shellenv in VM to get Homebrew environment\n\n## Edge Cases\n- **Empty Package List**: Script checks and fails if no packages found\n- **Invalid Package Name**: brew offline mirror will fail - script catches exit code\n- **Network Failure**: Download may fail partway - mirror will be incomplete but script detects it\n- **Disk Space**: Mirror can be 1-2GB - VM should have enough space but may fill up\n- **Bundled Taps**: Modern Homebrew bundles core/cask - offlinebrew handles this (fixed in earlier session)\n- **Only Formulae**: If no casks, don't add --casks flag (empty value would fail)\n- **Only Casks**: If no formulae, don't add -f flag (empty value would fail)\n\n## Anti-patterns\n- ❌ Don't skip --with-deps flag - defeats purpose of testing dependency resolution\n- ❌ Don't hardcode package list - must read from config file for maintainability\n- ❌ Don't ignore mirror command errors - exit immediately on failure\n- ❌ Don't skip verification - must confirm mirror structure is valid\n- ❌ Don't forget to parse CSV correctly - handle trailing commas and comments\n- ❌ Don't use vm_copy - Tart doesn't have traditional copy, use --dir mounting instead\n- ❌ Don't assume both formulae and casks exist - check before building command","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:37.079172-05:00","updated_at":"2025-11-13T15:10:19.921792-05:00","closed_at":"2025-11-13T15:10:19.921792-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.7","depends_on_id":"offlinebrew-3d0.2","type":"blocks","created_at":"2025-11-13T13:27:37.079822-05:00","created_by":"ryan"},{"issue_id":"offlinebrew-3d0.7","depends_on_id":"offlinebrew-3d0.6","type":"blocks","created_at":"2025-11-13T13:27:37.080335-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.8","content_hash":"b81ef08fec6567c547a3d384b4d3ef44122cb15999a7db2e28b7cda0b52cafa4","title":"Create verify-install.sh phase script","description":"Read package list, install each package via brew offline install, verify version commands succeed, track success/fail count, return failure if any package fails","design":"## Goal\nInstall all packages from mirror and verify their version commands work.\n\n## Effort Estimate\n2-3 hours\n\n## Success Criteria\n- [ ] File test/integration/phases/verify-install.sh exists and is executable\n- [ ] Script reads package list from config/test-packages.txt\n- [ ] All 5 packages install successfully from mirror\n- [ ] All 5 version commands execute successfully\n- [ ] Script tracks success/failure count\n- [ ] Script exits 0 only if ALL packages succeed\n- [ ] Script exits 1 if ANY package fails\n- [ ] Script prints summary of results\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create script with configuration\n\n**Files:**\n- Create: `test/integration/phases/verify-install.sh`\n\n**Step 1: Create verify-install.sh with header and configuration**\n\nFrom project root, create the script:\n\n```bash\ncat \u003e test/integration/phases/verify-install.sh \u003c\u003c 'EOF'\n#!/usr/bin/env bash\n#\n# verify-install.sh - Verify packages install from mirror\n#\n# Reads test-packages.txt and installs each package via brew offline install.\n\nset -euo pipefail\n\n# Get directory of this script\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" \u0026\u0026 pwd)\"\n\n# Source test helpers\nsource \"$SCRIPT_DIR/../lib/test-helpers.sh\"\n\n# Configuration\nVM_NAME=\"${TART_VM_NAME:-offlinebrew-test}\"\nTEST_CONFIG_FILE=\"/tmp/test-config/test-packages.txt\"\nMIRROR_DIR=\"/tmp/brew_mirror\"\n\n# Counters\nsuccess_count=0\nfail_count=0\ntotal_count=0\n\nEOF\n```\n\n**Expected output**: File created\n\n### Step Group 2: Verify prerequisites\n\n**Step 2: Add prerequisite checks**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/verify-install.sh \u003c\u003c 'EOF'\n# Verify test config file exists in VM\ninfo \"Checking prerequisites...\"\n\nif ! vm_exec \"test -f $TEST_CONFIG_FILE\"; then\n  error \"Test config file not found in VM: $TEST_CONFIG_FILE\"\n  error \"Run create-mirror.sh first to copy config file\"\n  exit 1\nfi\n\nif ! vm_exec \"test -d $MIRROR_DIR\"; then\n  error \"Mirror directory not found in VM: $MIRROR_DIR\"\n  error \"Run create-mirror.sh first to create mirror\"\n  exit 1\nfi\n\nok \"Prerequisites verified\"\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 3: Install and verify packages\n\n**Step 3: Add package installation and verification loop**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/verify-install.sh \u003c\u003c 'EOF'\n# Install and verify each package\ninfo \"Installing and verifying packages...\"\necho \"\"\n\n# Read package list from VM and process locally\npackage_list=$(vm_exec \"cat $TEST_CONFIG_FILE\")\n\nwhile IFS=, read -r type name version_cmd; do\n  # Skip comments and empty lines\n  [[ \"$type\" =~ ^# ]] \u0026\u0026 continue\n  [[ -z \"$type\" ]] \u0026\u0026 continue\n  [[ -z \"$name\" ]] \u0026\u0026 continue\n  \n  total_count=$((total_count + 1))\n  \n  info \"[$total_count] Testing $type: $name\"\n  \n  # Install package based on type\n  if [[ \"$type\" == \"cask\" ]]; then\n    install_cmd=\"eval \\$(/opt/homebrew/bin/brew shellenv) \u0026\u0026 brew offline install --cask $name\"\n  else\n    install_cmd=\"eval \\$(/opt/homebrew/bin/brew shellenv) \u0026\u0026 brew offline install $name\"\n  fi\n  \n  # Execute install command\n  if vm_exec \"$install_cmd\" 2\u003e\u00261 | grep -q \"Error:\"; then\n    error \"  Failed to install $name\"\n    fail_count=$((fail_count + 1))\n    echo \"\"\n    continue\n  fi\n  \n  ok \"  Installed $name\"\n  \n  # Verify version command works\n  # Note: nginx -v writes to stderr, so redirect stderr to stdout\n  verify_cmd=\"eval \\$(/opt/homebrew/bin/brew shellenv) \u0026\u0026 $version_cmd\"\n  if vm_exec \"$verify_cmd\" \u003e/dev/null 2\u003e\u00261; then\n    ok \"  Verified: $version_cmd\"\n    success_count=$((success_count + 1))\n  else\n    error \"  Version command failed: $version_cmd\"\n    fail_count=$((fail_count + 1))\n  fi\n  \n  echo \"\"\ndone \u003c\u003c\u003c \"$package_list\"\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 4: Print summary and exit\n\n**Step 4: Add summary and exit logic**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/phases/verify-install.sh \u003c\u003c 'EOF'\n# Print summary\necho \"\"\ninfo \"=========================================\"\ninfo \"Installation test results:\"\ninfo \"  Total packages: $total_count\"\n\nif [[ $success_count -gt 0 ]]; then\n  ok \"  Successful: $success_count\"\nfi\n\nif [[ $fail_count -gt 0 ]]; then\n  error \"  Failed: $fail_count\"\nfi\n\ninfo \"=========================================\"\necho \"\"\n\n# Exit based on results\nif [[ $fail_count -gt 0 ]]; then\n  error \"Some packages failed to install or verify\"\n  exit 1\nfi\n\nif [[ $total_count -eq 0 ]]; then\n  warn \"No packages found in config file\"\n  exit 1\nfi\n\nok \"All $success_count packages installed and verified successfully\"\nexit 0\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 5: Make script executable**\n\n```bash\nchmod +x test/integration/phases/verify-install.sh\n```\n\n**Expected output**: None (silent success)\n\n**Step 6: Verify script syntax**\n\n```bash\nbash -n test/integration/phases/verify-install.sh\n```\n\n**Expected output**: None (silent success = no syntax errors)\n\n**Step 7: Commit the verification script**\n\n```bash\ngit add test/integration/phases/verify-install.sh\ngit commit -m \"feat(offlinebrew-3d0.8): add package verification script\n\nCreates verify-install.sh phase script that:\n- Checks prerequisites (mirror and config file exist)\n- Reads test-packages.txt from VM\n- Installs each package via brew offline install\n- Uses --cask flag for cask packages\n- Verifies each package's version command works\n- Handles stderr output (nginx -v writes to stderr)\n- Tracks success/failure counts\n- Continues testing after failures\n- Exits 0 only if ALL packages succeed\n\nTests 5 packages:\n- Formulae: wget, jq, nginx\n- Casks: firefox, rectangle\n\nSources test-helpers.sh for logging and VM communication.\n\nRef: offlinebrew-3d0.8\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **Error detection**: Checks for \"Error:\" in output to detect failures\n- **Stderr handling**: Uses `2\u003e\u00261` redirect for nginx -v which writes to stderr\n- **Continue on failure**: Loop continues even if one package fails\n- **Version verification**: Discards output with `\u003e/dev/null 2\u003e\u00261`, only checks exit code\n- **Cask flag**: Adds `--cask` flag only for cask type packages\n- **Empty check**: Validates total_count \u003e 0 at end\n\n## Key Considerations\n\n**Install Order Independence**:\n- Packages should install in any order\n- Dependencies handled by offlinebrew automatically via mirror\n- Don't need special ordering or dependency checking\n\n**Version Command Variations**:\n- Formula commands usually in PATH after brew install\n- Cask commands may need full application path (e.g., /Applications/Firefox.app/...)\n- nginx -v writes to stderr instead of stdout (must redirect)\n- Some commands exit non-zero even when working properly\n\n**Error Handling Strategy**:\n- Continue testing even if one package fails\n- Track all failures and report at end\n- Only exit 0 if ALL packages succeed\n- Provides complete test report, not just first failure\n\n**Cask vs Formula Install**:\n- Casks need `--cask` flag for brew offline install\n- Formulae don't use `--cask` flag (will error if provided)\n- Must distinguish using type field from CSV\n\n**CSV Reading Approach**:\n- Read entire file with vm_exec once (avoids multiple VM calls)\n- Use here-string `\u003c\u003c\u003c \"$package_list\"` to pipe to while loop\n- IFS=, for comma-separated parsing\n- read -r to preserve backslashes\n\n## Edge Cases\n- **Already Installed**: brew install may skip if already installed - output will say \"already installed\", script accepts this\n- **Version Command Failures**: Some apps don't have version flags - test might fail legitimately\n- **PATH Issues**: Formulae should be in PATH after install, casks may not be\n- **Stderr vs Stdout**: nginx -v writes to stderr, must redirect to avoid treating as error\n- **Empty Config**: Script detects 0 packages and exits with error\n- **Partial Install**: Some packages install but version fails - both counted separately\n- **Network Required**: Some version commands may need network (unlikely but possible)\n\n## Anti-patterns\n- ❌ Don't stop on first failure - test all packages for complete results\n- ❌ Don't assume version commands always exit 0 - some may return non-zero on success\n- ❌ Don't forget --cask flag for casks - install will fail with confusing error\n- ❌ Don't skip verification step - install success doesn't mean package works\n- ❌ Don't report success if any failures - must exit 1 if fail_count \u003e 0\n- ❌ Don't parse CSV in VM - read once and process locally for efficiency\n- ❌ Don't use separate vm_exec calls per package - batching reduces overhead","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:46.312324-05:00","updated_at":"2025-11-13T15:11:15.860588-05:00","closed_at":"2025-11-13T15:11:15.860588-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.8","depends_on_id":"offlinebrew-3d0.2","type":"blocks","created_at":"2025-11-13T13:27:46.313133-05:00","created_by":"ryan"},{"issue_id":"offlinebrew-3d0.8","depends_on_id":"offlinebrew-3d0.7","type":"blocks","created_at":"2025-11-13T13:27:46.313531-05:00","created_by":"ryan"}]}
{"id":"offlinebrew-3d0.9","content_hash":"88ab06ad1eb082aaeaf0728f736158fe8cfffc8f94278932efdb64df216f4062","title":"Create tart-e2e.sh main orchestrator script","description":"Source helpers, call all phase scripts in order, fail fast on errors, track duration, cleanup on success, print clear error messages","design":"## Goal\nCreate main orchestrator script that runs all test phases in correct order with proper error handling and cleanup.\n\n## Effort Estimate\n2-3 hours\n\n## Success Criteria\n- [ ] File test/integration/tart-e2e.sh exists and is executable\n- [ ] Script sources test-helpers.sh successfully\n- [ ] Script calls all 5 phase scripts in correct order\n- [ ] Script fails fast - stops on first phase failure\n- [ ] Script tracks total test duration\n- [ ] Script prints phase name before running each phase\n- [ ] Script cleans up VM and artifacts on completion\n- [ ] Script exits 0 only if all phases succeed\n- [ ] Script exits 1 if any phase fails\n\n## Implementation Steps (ADDED BY writing-plans)\n\n### Step Group 1: Create main orchestrator script\n\n**Files:**\n- Create: `test/integration/tart-e2e.sh`\n\n**Step 1: Create tart-e2e.sh with header and configuration**\n\nFrom project root, create the script:\n\n```bash\ncat \u003e test/integration/tart-e2e.sh \u003c\u003c 'EOF'\n#!/usr/bin/env bash\n#\n# tart-e2e.sh - End-to-end tests using Tart VM\n#\n# Orchestrates full test suite: VM setup, Homebrew install, mirror creation, package verification.\n\nset -euo pipefail\n\n# Get directory of this script\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" \u0026\u0026 pwd)\"\nPHASES_DIR=\"$SCRIPT_DIR/phases\"\nVM_NAME=\"${TART_VM_NAME:-offlinebrew-test}\"\n\n# Source test helpers\nsource \"$SCRIPT_DIR/lib/test-helpers.sh\"\n\nEOF\n```\n\n**Expected output**: File created\n\n### Step Group 2: Add cleanup and error handling\n\n**Step 2: Add cleanup trap**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/tart-e2e.sh \u003c\u003c 'EOF'\n# Cleanup function runs on exit\ncleanup() {\n  local exit_code=$?\n  \n  echo \"\"\n  \n  if [[ $exit_code -eq 0 ]]; then\n    info \"Tests passed - cleaning up...\"\n    if tart delete \"$VM_NAME\" 2\u003e/dev/null; then\n      ok \"VM deleted: $VM_NAME\"\n    else\n      warn \"Failed to delete VM (may not exist)\"\n    fi\n  else\n    warn \"Tests failed - VM left running for debugging\"\n    warn \"  VM name: $VM_NAME\"\n    warn \"  Connect: tart run $VM_NAME\"\n    warn \"  Delete:  tart delete $VM_NAME\"\n  fi\n  \n  return $exit_code\n}\n\n# Register cleanup trap\ntrap cleanup EXIT\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 3: Run test phases\n\n**Step 3: Add test phase execution**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/tart-e2e.sh \u003c\u003c 'EOF'\n# Record start time\nstart_time=$(date +%s)\n\necho \"\"\ninfo \"========================================\"\ninfo \"Starting Tart End-to-End Tests\"\ninfo \"========================================\"\necho \"\"\n\n# Define phases in execution order\nphases=(\n  \"setup-vm.sh\"\n  \"install-homebrew.sh\"\n  \"install-offlinebrew.sh\"\n  \"create-mirror.sh\"\n  \"verify-install.sh\"\n)\n\ncurrent_phase=0\ntotal_phases=${#phases[@]}\n\n# Run each phase\nfor phase in \"${phases[@]}\"; do\n  current_phase=$((current_phase + 1))\n  \n  echo \"\"\n  info \"========================================\"\n  info \"Phase $current_phase/$total_phases: $phase\"\n  info \"========================================\"\n  echo \"\"\n  \n  phase_start=$(date +%s)\n  \n  # Run phase script (fail-fast: set -e will exit on error)\n  \"$PHASES_DIR/$phase\"\n  \n  phase_end=$(date +%s)\n  phase_duration=$((phase_end - phase_start))\n  \n  echo \"\"\n  ok \"Phase complete: $phase (${phase_duration}s)\"\ndone\n\nEOF\n```\n\n**Expected output**: Code appended\n\n### Step Group 4: Print summary\n\n**Step 4: Add summary and completion**\n\nAppend to the script:\n\n```bash\ncat \u003e\u003e test/integration/tart-e2e.sh \u003c\u003c 'EOF'\n# Calculate total duration\nend_time=$(date +%s)\ntotal_duration=$((end_time - start_time))\nminutes=$((total_duration / 60))\nseconds=$((total_duration % 60))\n\n# Print summary\necho \"\"\ninfo \"========================================\"\nok \"All tests passed!\"\ninfo \"Total phases: $total_phases\"\ninfo \"Total duration: ${minutes}m ${seconds}s\"\ninfo \"========================================\"\necho \"\"\n\nexit 0\nEOF\n```\n\n**Expected output**: Code appended\n\n**Step 5: Make script executable**\n\n```bash\nchmod +x test/integration/tart-e2e.sh\n```\n\n**Expected output**: None (silent success)\n\n**Step 6: Verify script syntax**\n\n```bash\nbash -n test/integration/tart-e2e.sh\n```\n\n**Expected output**: None (silent success = no syntax errors)\n\n**Step 7: Commit the orchestrator script**\n\n```bash\ngit add test/integration/tart-e2e.sh\ngit commit -m \"feat(offlinebrew-3d0.9): add main orchestrator script\n\nCreates tart-e2e.sh orchestrator that:\n- Sources test-helpers.sh for logging\n- Runs 5 phase scripts in sequence:\n  1. setup-vm.sh - Create fresh Tart VM\n  2. install-homebrew.sh - Install Homebrew non-interactively\n  3. install-offlinebrew.sh - Copy and configure offlinebrew\n  4. create-mirror.sh - Mirror test packages with dependencies\n  5. verify-install.sh - Install and verify all packages\n- Fails fast on any phase error (set -euo pipefail)\n- Tracks per-phase and total duration\n- Cleanup trap runs on exit\n- Keeps VM running on failure for debugging\n- Deletes VM on success to save disk space\n\nExpected full suite duration: 10-15 minutes.\nSources test-helpers.sh for logging and VM communication.\n\nRef: offlinebrew-3d0.9\"\n```\n\n**Expected output**: Commit created successfully\n\n**Notes:**\n- **Fail fast**: `set -euo pipefail` causes immediate exit on any phase failure\n- **Cleanup trap**: Runs on exit regardless of success/failure\n- **VM preservation**: Keeps VM running on failure for debugging\n- **Duration tracking**: Per-phase and total duration calculated\n- **Progress display**: Shows phase N/M for visibility\n- **Exit codes**: Returns 0 only if all phases succeed\n\n## Key Considerations\n\n**Fail Fast Behavior**:\n- `set -euo pipefail` causes immediate exit on any error\n- Each phase script must return proper exit code (0 = success)\n- No need for explicit `|| exit 1` checks - shell does it automatically\n- Entire test suite stops at first failure\n\n**Cleanup Strategy**:\n- `trap cleanup EXIT` runs cleanup function on any exit (success, failure, signal)\n- Checks `$?` exit code to determine if tests passed\n- Keeps VM running on failure for manual debugging\n- Deletes VM on success to save disk space (~30GB per VM)\n- Returns original exit code after cleanup\n\n**Phase Order Critical**:\n- Phases must run in exact sequence - each depends on previous\n- setup-vm must be first (creates VM)\n- install-homebrew must be second (provides brew command)\n- install-offlinebrew must be third (provides brew offline command)\n- create-mirror must be fourth (creates mirror for install)\n- verify-install must be last (tests packages from mirror)\n\n**Duration Tracking**:\n- Helps identify performance regressions over time\n- Expected full suite: 10-15 minutes\n- Longest phase: create-mirror (5-10 minutes for downloads)\n- Per-phase timing helps identify bottlenecks\n\n**Logging Strategy**:\n- Uses test-helpers.sh logging functions (info, ok, warn, error)\n- Visual separators (===) for clear phase boundaries\n- Progress indicators (Phase N/M)\n- Duration in minutes and seconds\n\n## Edge Cases\n- **Phase Script Not Executable**: Will fail with \"Permission denied\" error\n- **Phase Script Missing**: Will fail with \"No such file or directory\"\n- **Early Exit**: Cleanup trap runs even on early exit (Ctrl-C)\n- **Kill Signal**: SIGTERM may not run cleanup trap (SIGKILL never does)\n- **VM Already Exists**: setup-vm.sh handles this (deletes existing VM)\n- **Disk Full**: Mirror creation may fail, error propagates up\n- **Network Failure**: Homebrew install or mirror creation will fail\n\n## Anti-patterns\n- ❌ Don't continue on phase failure - must fail fast for clear results\n- ❌ Don't skip cleanup trap - always clean up to prevent disk waste\n- ❌ Don't delete VM on failure - keep for debugging what went wrong\n- ❌ Don't run phases in parallel - dependencies require sequential execution\n- ❌ Don't suppress phase output - need full logs for debugging\n- ❌ Don't use bare `./phase.sh` - use `\"$PHASES_DIR/$phase\"` for clarity\n- ❌ Don't ignore exit codes - let set -e handle them automatically","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-13T13:27:46.856568-05:00","updated_at":"2025-11-13T15:12:09.895867-05:00","closed_at":"2025-11-13T15:12:09.895867-05:00","source_repo":".","dependencies":[{"issue_id":"offlinebrew-3d0.9","depends_on_id":"offlinebrew-3d0.3","type":"blocks","created_at":"2025-11-13T13:27:46.857215-05:00","created_by":"ryan"},{"issue_id":"offlinebrew-3d0.9","depends_on_id":"offlinebrew-3d0.4","type":"blocks","created_at":"2025-11-13T13:27:46.857636-05:00","created_by":"ryan"},{"issue_id":"offlinebrew-3d0.9","depends_on_id":"offlinebrew-3d0.5","type":"blocks","created_at":"2025-11-13T13:27:46.858025-05:00","created_by":"ryan"},{"issue_id":"offlinebrew-3d0.9","depends_on_id":"offlinebrew-3d0.6","type":"blocks","created_at":"2025-11-13T13:27:46.858333-05:00","created_by":"ryan"},{"issue_id":"offlinebrew-3d0.9","depends_on_id":"offlinebrew-3d0.7","type":"blocks","created_at":"2025-11-13T13:27:46.858645-05:00","created_by":"ryan"},{"issue_id":"offlinebrew-3d0.9","depends_on_id":"offlinebrew-3d0.8","type":"blocks","created_at":"2025-11-13T13:27:46.858949-05:00","created_by":"ryan"}]}

name: Test Suite

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main ]

jobs:
  test-fast:
    name: Fast Tests (Unit + Security)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-13, macos-14]  # Intel + Apple Silicon
        ruby: ['3.0', '3.1', '3.2']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
          working-directory: mirror

      - name: Install dependencies
        working-directory: mirror
        run: bundle install

      - name: Run unit tests
        working-directory: mirror
        run: bundle exec rake unit

      - name: Run security tests
        working-directory: mirror
        run: bundle exec rake security

  test-integration:
    name: Integration Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-13, macos-14]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: mirror

      - name: Update Homebrew
        run: brew update

      - name: Run integration tests
        working-directory: mirror
        run: bundle exec rake integration

  verify-formulae:
    name: Verify Real Formulae Work
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: mirror

      - name: Update Homebrew
        run: brew update

      - name: Mirror jq (small test formula)
        working-directory: mirror
        run: |
          mkdir -p /tmp/test-mirror
          brew ruby bin/brew-mirror -d /tmp/test-mirror -f jq,tree -s 1

      - name: Verify mirror structure
        run: |
          test -f /tmp/test-mirror/config.json || exit 1
          test -f /tmp/test-mirror/urlmap.json || exit 1
          echo "Mirror contents:"
          ls -lh /tmp/test-mirror/

      - name: Start HTTP server
        run: |
          cd /tmp/test-mirror
          python3 -m http.server 9876 > /tmp/server.log 2>&1 &
          echo $! > /tmp/server.pid
          sleep 3

          # Verify server is running
          curl -s http://localhost:9876/config.json || exit 1

      - name: Install jq from mirror
        working-directory: mirror
        run: |
          mkdir -p ~/.offlinebrew
          echo '{"baseurl":"http://localhost:9876"}' > ~/.offlinebrew/config.json

          # Uninstall if present
          brew uninstall jq 2>/dev/null || true

          # Install from offline mirror
          ruby bin/brew-offline-install jq

      - name: Test jq functionality
        run: |
          # Critical test: Does jq actually work?
          jq --version || exit 1

          # Test actual JSON parsing
          echo '{"name":"test","value":42}' | jq .value | grep -q 42 || exit 1
          echo "✓ jq works correctly"

      - name: Install tree from mirror
        working-directory: mirror
        run: |
          brew uninstall tree 2>/dev/null || true
          ruby bin/brew-offline-install tree

      - name: Test tree functionality
        run: |
          tree --version || exit 1
          echo "✓ tree works correctly"

      - name: Cleanup
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) 2>/dev/null || true
          fi
          rm -rf /tmp/test-mirror
          brew uninstall jq tree 2>/dev/null || true

  verify-casks:
    name: Verify Real Casks Work
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: mirror

      - name: Update Homebrew
        run: brew update

      - name: Mirror hex-fiend cask
        working-directory: mirror
        run: |
          mkdir -p /tmp/cask-mirror
          brew ruby bin/brew-mirror -d /tmp/cask-mirror --casks hex-fiend -s 2

      - name: Verify cask mirror structure
        run: |
          test -f /tmp/cask-mirror/config.json || exit 1
          test -f /tmp/cask-mirror/urlmap.json || exit 1

          # Verify DMG was downloaded
          dmg_count=$(find /tmp/cask-mirror -name "*.dmg" | wc -l)
          if [ "$dmg_count" -eq 0 ]; then
            echo "ERROR: No DMG files found"
            exit 1
          fi
          echo "Found $dmg_count DMG file(s)"

      - name: Start HTTP server for casks
        run: |
          cd /tmp/cask-mirror
          python3 -m http.server 9877 > /tmp/cask-server.log 2>&1 &
          echo $! > /tmp/cask-server.pid
          sleep 3
          curl -s http://localhost:9877/config.json || exit 1

      - name: Install hex-fiend from mirror
        working-directory: mirror
        run: |
          mkdir -p ~/.offlinebrew
          echo '{"baseurl":"http://localhost:9877"}' > ~/.offlinebrew/config.json

          brew uninstall --cask hex-fiend 2>/dev/null || true

          ruby bin/brew-offline-install --cask hex-fiend

      - name: Verify hex-fiend installed
        run: |
          # Critical test: Is the app actually installed?
          test -d "/Applications/Hex Fiend.app" || exit 1

          # Verify it's a valid app bundle
          test -f "/Applications/Hex Fiend.app/Contents/Info.plist" || exit 1

          # Verify code signature
          codesign --verify "/Applications/Hex Fiend.app" || exit 1

          echo "✓ Hex Fiend installed and verified"

      - name: Cleanup
        if: always()
        run: |
          brew uninstall --cask hex-fiend 2>/dev/null || true
          if [ -f /tmp/cask-server.pid ]; then
            kill $(cat /tmp/cask-server.pid) 2>/dev/null || true
          fi
          rm -rf /tmp/cask-mirror

  code-coverage:
    name: Code Coverage
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: mirror

      - name: Run tests with coverage
        working-directory: mirror
        env:
          COVERAGE: '1'
        run: bundle exec rake test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./mirror/coverage/.resultset.json
          flags: macos
          name: codecov-offlinebrew
